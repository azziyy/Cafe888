<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cafe 777 - Premium App</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="light-mode">

    <div id="myAlert" class="custom-alert" onclick="if(event.target==this) closeAlert()">
        <div class="alert-box">
            <span id="alertIcon" class="alert-icon"></span>
            <div id="alertTitle" class="alert-title"></div>
            <div id="alertMsg" class="alert-msg"></div>
            <button class="alert-btn" onclick="closeAlert()">Tushunarli</button>
        </div>
    </div>

    <div id="drawerOverlay" class="drawer-overlay" onclick="toggleDrawer()"></div>
    <div id="myDrawer" class="drawer">
        <div class="drawer-header">
            <h2>Cafe 777</h2>
            <p>Sifat va lazzat uyg'unligi</p>
        </div>
        <div class="drawer-content">
            <div class="drawer-item" onclick="toggleMode()">
                <i class="fa fa-moon"></i> <span>Tungi rejim</span>
                <div id="modeToggle" class="toggle-switch"></div>
            </div>
            <div class="drawer-item" onclick="p('cart', this); toggleDrawer();">
                <i class="fa fa-shopping-basket"></i> <span>Savatim</span>
            </div>
            <div class="drawer-item" onclick="location.reload()">
                <i class="fa fa-rotate"></i> <span>Yangilash</span>
            </div>
        </div>
    </div>

    <header class="header-nav">
        <div class="menu-icon" onclick="toggleDrawer()">
            <i class="fa fa-bars-staggered"></i>
        </div>
        <div class="logo">CAFE <span>777</span></div>
        <div class="user-badge" onclick="openProfile()">
            <i class="fa fa-circle-user"></i>
            <span id="badgeName">Kirish</span>
        </div>
    </header>

    <div id="productInfoModal" class="modal" onclick="if(event.target==this) closeModal('productInfoModal')">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('productInfoModal')">Ã—</button>
            <div class="modal-img-wrapper">
                <img id="p-modal-img" src="" alt="product">
            </div>
            <div class="modal-body">
                <h2 id="p-modal-title"></h2>
                <div id="p-modal-price" class="modal-price"></div>
                <p id="p-modal-desc"></p>
            </div>
        </div>
    </div>

    <div id="profileModal" class="modal" onclick="if(event.target==this) closeModal('profileModal')">
        <div class="modal-content profile-modal-content">
            <button class="close-modal" onclick="closeModal('profileModal')">Ã—</button>
            <div class="profile-header-bg"></div>
            <div class="modal-body profile-body">
                <div class="profile-avatar">
                    <i class="fa fa-user-circle"></i>
                </div>
                <h3>Mening profilim</h3>
                <p class="profile-hint">Buyurtmalaringizni yetkazish uchun ma'lumotlarni to'ldiring</p>
                
                <div class="input-group">
                    <label><i class="fa fa-user"></i> To'liq ismingiz</label>
                    <input type="text" id="userName" placeholder="Masalan: Ali Valiyev">
                </div>
                <div class="input-group">
                    <label><i class="fa fa-phone"></i> Telefon raqamingiz</label>
                    <input type="tel" id="userPhone" placeholder="+998 90 123 45 67">
                </div>
                <button class="save-btn profile-save" onclick="saveProfile()">
                    <i class="fa fa-check-circle"></i> MA'LUMOTLARNI SAQLASH
                </button>
            </div>
        </div>
    </div>

    <main id="main-p" class="p-con">
        <div id="catNav" class="category-nav"></div>
        <div id="menu" class="menu-grid"></div>
    </main>

    <div id="cart-p" class="p-con hidden">
        <div class="cart-card">
            <h3>Savat ðŸ›’</h3>
            <div id="cartList" class="cart-items-list"></div>
            <div class="total-section">
                <span>Jami:</span> <span id="total">0 so'm</span>
            </div>
            <button id="locBtn" class="location-btn" onclick="getLocation()">
                <i class="fa fa-location-arrow"></i> MANZILNI ANIQLASH
            </button>
            <button id="submitBtn" class="order-submit-btn" onclick="sendOrder()">
                BUYURTMANI YUBORISH
            </button>
        </div>
    </div>

    <div id="fav-p" class="p-con hidden">
        <div id="favs" class="menu-grid"></div>
    </div>

    <nav class="toolbar">
        <div class="tool-item active" onclick="p('main',this)">
            <i class="fa fa-utensils"></i><span>Menyu</span>
        </div>
        <div class="tool-item" onclick="p('cart',this)">
            <i class="fa fa-cart-shopping"></i><span>Savat</span>
        </div>
        <div class="tool-item" onclick="p('fav',this)">
            <i class="fa fa-heart"></i><span>Sevimlilar</span>
        </div>
    </nav>

    <script>
        const BOT = "8032226679:AAETTGPvYZYSvF_QmdofXKibpOwt4E9Iitc", 
              ADMIN = "519326806", 
              SHEET = "1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk";
        
        let prods = [], cart = {}, favs = [], coords = null;

        // Custom Alert
        function showAlert(title, msg, type = 'info') {
            const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸', geo: 'ðŸ“' };
            document.getElementById('alertIcon').innerText = icons[type] || 'ðŸ””';
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMsg').innerText = msg;
            const modal = document.getElementById('myAlert');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeAlert() {
            const modal = document.getElementById('myAlert');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // Ma'lumotlarni yuklash
        async function load() {
            try {
                const r = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET}/gviz/tq?tqx=out:json`);
                const t = await r.text();
                const j = JSON.parse(t.substring(47, t.length - 2));
                prods = j.table.rows.map((r, i) => ({
                    id: i + 1, cat: r.c[1]?.v || 'Boshqa', name: r.c[2]?.v || 'Nomsiz',
                    price: r.c[3]?.v || 0, img: r.c[4]?.v || '', desc: r.c[5]?.v || "Ma'lumot yo'q"
                }));
                renderCats(); 
                renderMenu(); 
                checkProfile();
            } catch(e) { showAlert("Xato", "Tarmoq ulanishini tekshiring", "error"); }
        }

        // Kartani generatsiya qilish (prefix bilan)
        function genCard(p, prefix = 'main') {
            let q = cart[p.id] || 0;
            const ctrlId = `${prefix}-ctrl-${p.id}`;
            return `
            <div class="card">
                <div class="heart-btn ${favs.includes(p.id)?'active':''}" onclick="toggleF(${p.id},this)"><i class="fa fa-heart"></i></div>
                <img src="${p.img}" onclick="openDetail(${p.id})" onerror="this.src='https://via.placeholder.com/300'">
                <div class="card-info">
                    <h4 onclick="openDetail(${p.id})">${p.name}</h4>
                    <b class="price">${p.price.toLocaleString()} so'm</b>
                    <div id="${ctrlId}" class="card-ctrl">
                        ${q > 0 ? `
                            <button class="qty-btn" onclick="updateQty(${p.id},-1)">-</button>
                            <span class="qty-num">${q}</span>
                            <button class="qty-btn" onclick="updateQty(${p.id},1)">+</button>
                        ` : `<button class="add-to-cart" onclick="updateQty(${p.id},1)">Savatga</button>`}
                    </div>
                </div>
            </div>`;
        }

        // Sinxron yangilash
        function updateQty(id, n) {
            cart[id] = (cart[id] || 0) + n;
            if(cart[id] <= 0) delete cart[id];
            renderCart();
            const allCtrls = document.querySelectorAll(`[id$="-ctrl-${id}"]`);
            allCtrls.forEach(ctrl => {
                let q = cart[id] || 0;
                ctrl.innerHTML = q > 0 ? `
                    <button class="qty-btn" onclick="updateQty(${id},-1)">-</button>
                    <span class="qty-num">${q}</span>
                    <button class="qty-btn" onclick="updateQty(${id},1)">+</button>
                ` : `<button class="add-to-cart" onclick="updateQty(${id},1)">Savatga</button>`;
            });
        }

        function renderMenu(data = prods) {
            const container = document.getElementById('menu');
            container.innerHTML = "";
            data.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'card-anim';
                div.style.animationDelay = (i * 0.05) + 's';
                div.innerHTML = genCard(p, 'main');
                container.appendChild(div);
            });
        }

        function renderF() {
            const fList = prods.filter(x => favs.includes(x.id));
            const container = document.getElementById('favs');
            container.innerHTML = "";
            if(fList.length === 0) {
                container.innerHTML = `<div class="empty-state"><i class="fa-regular fa-heart"></i><p>Sevimlilar bo'sh</p></div>`;
            } else {
                fList.forEach((p, i) => {
                    const div = document.createElement('div');
                    div.className = 'card-anim';
                    div.style.animationDelay = (i * 0.05) + 's';
                    div.innerHTML = genCard(p, 'fav');
                    container.appendChild(div);
                });
            }
        }

        function toggleF(id, el) {
            event.stopPropagation();
            if(favs.includes(id)) favs = favs.filter(x=>x!=id); else favs.push(id);
            el.classList.toggle('active');
            localStorage.setItem('c777_f', JSON.stringify(favs));
        }

        function filterCat(c, btn) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderMenu(c === 'Barchasi' ? prods : prods.filter(p => p.cat === c));
        }

        function renderCats() {
            const cats = ['Barchasi', ...new Set(prods.map(p => p.cat))];
            document.getElementById('catNav').innerHTML = cats.map(c => 
                `<button class="cat-btn ${c==='Barchasi'?'active':''}" onclick="filterCat('${c}', this)">${c}</button>`
            ).join('');
        }

        function p(s, el) {
            document.querySelectorAll('.p-con').forEach(x => x.classList.add('hidden'));
            const target = document.getElementById(s + '-p');
            target.classList.remove('hidden');
            document.querySelectorAll('.tool-item').forEach(x => x.classList.remove('active'));
            el.classList.add('active'); 
            if(s === 'fav') renderF();
            if(s === 'main') renderMenu();
            window.scrollTo(0,0);
        }

        // UI Funksiyalari
        function toggleDrawer() {
            document.getElementById('myDrawer').classList.toggle('open');
            document.getElementById('drawerOverlay').classList.toggle('active');
        }

        // MODAL FUNKSIYALARI (Tuzatilgan)
        function openModal(id) {
            const m = document.getElementById(id);
            m.style.display = 'flex';
            setTimeout(() => m.classList.add('show'), 10);
        }

        function closeModal(id) {
            const m = document.getElementById(id);
            m.classList.remove('show');
            setTimeout(() => m.style.display = 'none', 300);
        }

        // Profil ochish funksiyasi
        function openProfile() {
            const n = localStorage.getItem('c777_name');
            const ph = localStorage.getItem('c777_phone');
            if(n) document.getElementById('userName').value = n;
            if(ph) document.getElementById('userPhone').value = ph;
            openModal('profileModal');
        }

        function saveProfile() {
            const n = document.getElementById('userName').value.trim();
            const ph = document.getElementById('userPhone').value.trim();
            if(n.length > 2 && ph.length > 8) {
                localStorage.setItem('c777_name', n);
                localStorage.setItem('c777_phone', ph);
                document.getElementById('badgeName').innerText = n.split(' ')[0];
                closeModal('profileModal');
                showAlert("Saqlandi", "Profilingiz muvaffaqiyatli yangilandi âœ¨", "success");
            } else {
                showAlert("Xatolik", "Iltimos, ismingiz va raqamingizni to'g'ri kiriting!", "error");
            }
        }

        function checkProfile() {
            const n = localStorage.getItem('c777_name');
            if(n) document.getElementById('badgeName').innerText = n.split(' ')[0];
        }

        function toggleMode() {
            document.body.classList.toggle('dark-mode');
            document.getElementById('modeToggle').classList.toggle('active');
        }

        function openDetail(id) {
            const p = prods.find(x => x.id === id);
            document.getElementById('p-modal-img').src = p.img;
            document.getElementById('p-modal-title').innerText = p.name;
            document.getElementById('p-modal-price').innerText = p.price.toLocaleString() + " so'm";
            document.getElementById('p-modal-desc').innerText = p.desc;
            openModal('productInfoModal');
        }

        function renderCart() {
            let t=0, h="";
            for(let id in cart) { 
                let p=prods.find(x=>x.id==id);
                t+=p.price*cart[id]; 
                h+=`<div class="cart-item"><span>${p.name} (x${cart[id]})</span><b>${(p.price*cart[id]).toLocaleString()}</b></div>`; 
            }
            document.getElementById('cartList').innerHTML = h || "<p style='text-align:center; color:#999; padding:20px;'>Savat bo'sh</p>";
            document.getElementById('total').innerText = t.toLocaleString() + " so'm";
        }

        function getLocation() {
            const b = document.getElementById('locBtn');
            b.innerHTML = '<i class="fa fa-spinner fa-spin"></i>...';
            navigator.geolocation.getCurrentPosition(p => {
                coords = p.coords;
                b.style.color = "var(--green)"; b.innerText = "âœ… MANZIL ANIQLANDI";
                showAlert("Ajoyib", "Yetkazib berish manzili olindi", "geo");
            }, () => {
                b.innerHTML = '<i class="fa fa-location-arrow"></i> QAYTA URINISH';
                showAlert("GPS Xatosi", "Iltimos, joylashuvga ruxsat bering", "error");
            });
        }

        async function sendOrder() {
    const n = localStorage.getItem('c777_name'), ph = localStorage.getItem('c777_phone');
    if(!n || !ph) { openProfile(); return; }
    if(!Object.keys(cart).length) return showAlert("Savat bo'sh", "Mahsulot tanlang", "info");
    if(!coords) return showAlert("Manzil", "Joylashuvni aniqlang", "geo");

    // 1. Mahsulotlar ro'yxatini shakllantirish
    let itemsText = "";
    for(let id in cart) {
        let p = prods.find(x => x.id == id);
        let count = cart[id];
        let sum = (p.price * count).toLocaleString();
        // Har bir qator: ðŸ” Burger x2 = 60,000 so'm
        itemsText += `ðŸ”¹ ${p.name} x${count} = ${sum} so'm\n`;
    }

    const totalSum = document.getElementById('total').innerText;
    
    // 2. Telegram uchun to'liq xabar matni
    const text = `ðŸ”” YANGI BUYURTMA\n\n` +
                 `ðŸ‘¤ Mijoz: ${n}\n` +
                 `ðŸ“ž Tel: ${ph}\n\n` +
                 `ðŸ›’ MAHSULOTLAR:\n${itemsText}\n` +
                 `ðŸ’° JAMI: ${totalSum}\n\n` +
                 `ðŸ“ Manzil: https://www.google.com/maps?q=${coords.latitude},${coords.longitude}`;
    
    try {
        await fetch(`https://api.telegram.org/bot${BOT}/sendMessage`, {
            method: 'POST', 
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ chat_id: ADMIN, text: text })
        });
        showAlert("Tabriklaymiz!", "Buyurtmangiz yuborildi. Operator qo'ng'irog'ini kuting.", "success");
        cart = {}; 
        renderCart(); 
        renderMenu(); 
        p('main', document.querySelector('.tool-item'));
    } catch(e) { 
        showAlert("Xato", "Buyurtma yuborishda xatolik yuz berdi", "error"); 
    }
}


        window.onload = () => {
            favs = JSON.parse(localStorage.getItem('c777_f') || "[]");
            load();
        };
    </script>
</body>
</html>
