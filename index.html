<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cafe 777 - Premium App</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Status va Tarix uchun qo'shimcha dizayn */
        .history-item {
            background: var(--white);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border-left: 5px solid #ddd;
            animation: fadeIn 0.3s ease;
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }
        /* Status ranglari */
        .st-1 { background: #fff3cd; color: #856404; } /* Qabul qilindi */
        .st-2 { background: #cce5ff; color: #004085; } /* Tayyorlanmoqda */
        .st-3 { background: #d1ecf1; color: #0c5460; } /* Yo'lda */
        .st-4 { background: #d4edda; color: #155724; } /* Yetkazildi */
        
        .order-id { font-size: 10px; color: #999; }
        .order-date { font-size: 10px; color: #999; float: right; }
    </style>
</head>
<body class="light-mode">

    <div id="myAlert" class="custom-alert" onclick="if(event.target==this) closeAlert()">
        <div class="alert-box">
            <span id="alertIcon" class="alert-icon"></span>
            <div id="alertTitle" class="alert-title"></div>
            <div id="alertMsg" class="alert-msg"></div>
            <button class="alert-btn" onclick="closeAlert()">Tushunarli</button>
        </div>
    </div>

    <header class="header-nav">
        <div class="menu-icon" onclick="toggleDrawer()"><i class="fa fa-bars-staggered"></i></div>
        <div class="logo">CAFE <span>777</span></div>
        <div class="user-badge" onclick="openProfile()"><i class="fa fa-circle-user"></i> <span id="badgeName">Kirish</span></div>
    </header>

    <main id="main-p" class="p-con">
        <div id="catNav" class="category-nav"></div>
        <div id="menu" class="menu-grid"></div>
    </main>

    <div id="cart-p" class="p-con hidden">
        <div class="cart-card">
            <h3>Savat üõí</h3>
            <div id="cartList" class="cart-items-list"></div>
            <div class="total-section"><span>Jami:</span> <span id="total">0 so'm</span></div>
            <button id="locBtn" class="location-btn" onclick="getLocation()"><i class="fa fa-location-arrow"></i> MANZILNI ANIQLASH</button>
            <button id="submitBtn" class="order-submit-btn" onclick="sendOrder()">BUYURTMANI YUBORISH</button>
        </div>
    </div>

    <div id="history-p" class="p-con hidden">
        <div class="cart-card">
            <h3>Buyurtmalar tarixi üìú</h3>
            <div id="historyList">
                <p style="text-align:center; color:#999; padding:20px;">Hozircha buyurtmalar yo'q</p>
            </div>
        </div>
    </div>

    <div id="fav-p" class="p-con hidden">
        <div id="favs" class="menu-grid"></div>
    </div>

    <nav class="toolbar">
        <div class="tool-item active" onclick="p('main',this)"><i class="fa fa-utensils"></i><span>Menyu</span></div>
        <div class="tool-item" onclick="p('cart',this)"><i class="fa fa-cart-shopping"></i><span>Savat</span></div>
        <div class="tool-item" onclick="p('history',this)"><i class="fa fa-clock-rotate-left"></i><span>Tarix</span></div>
        <div class="tool-item" onclick="p('fav',this)"><i class="fa fa-heart"></i><span>Sevimlilar</span></div>
    </nav>

    <div id="profileModal" class="modal" onclick="if(event.target==this) closeModal('profileModal')">
        <div class="modal-content profile-modal-content">
            <div class="modal-body profile-body">
                <h3>Mening profilim</h3>
                <div class="input-group"><label>Ism</label><input type="text" id="userName"></div>
                <div class="input-group"><label>Telefon</label><input type="tel" id="userPhone"></div>
                <button class="save-btn" onclick="saveProfile()">SAQLASH</button>
            </div>
        </div>
    </div>

    <script>
        const BOT = "8032226679:AAETTGPvYZYSvF_QmdofXKibpOwt4E9Iitc", 
              ADMIN = "519326806", 
              SHEET = "1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk",
              SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzwXqXAjdnweGOhHv-8zUHy2w00LKFaW5-bMWgzEyY7qLfDIkdhdyr13E-vWwx9icJQ4g/exec"; // Google Apps Script URL ni qo'ying

        let prods = [], cart = {}, favs = [], coords = null;

        async function load() {
            try {
                const r = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET}/gviz/tq?tqx=out:json`);
                const t = await r.text();
                const j = JSON.parse(t.substring(47, t.length - 2));
                prods = j.table.rows.map((r, i) => ({
                    id: i + 1, cat: r.c[1]?.v || 'Boshqa', name: r.c[2]?.v || 'Nomsiz',
                    price: r.c[3]?.v || 0, img: r.c[4]?.v || '', desc: r.c[5]?.v || ""
                }));
                renderCats(); renderMenu(); checkProfile();
            } catch(e) { console.log(e); }
        }

        // Sahifalarni boshqarish
        function p(s, el) {
            document.querySelectorAll('.p-con').forEach(x => x.classList.add('hidden'));
            document.getElementById(s + '-p').classList.remove('hidden');
            document.querySelectorAll('.tool-item').forEach(x => x.classList.remove('active'));
            el.classList.add('active'); 
            if(s === 'history') updateHistory();
            if(s === 'fav') renderF();
            window.scrollTo(0,0);
        }

        async function sendOrder() {
            const n = localStorage.getItem('c777_name'), ph = localStorage.getItem('c777_phone');
            if(!n || !ph) return openProfile();
            if(!Object.keys(cart).length) return;
            if(!coords) return showAlert("Manzil", "Joylashuvni aniqlang", "geo");

            const orderId = Date.now();
            let itemsText = "";
            for(let id in cart) itemsText += `${prods.find(x => x.id == id).name} x${cart[id]}, `;
            const totalSum = document.getElementById('total').innerText;

            // 1. Google Sheetsga saqlash
            fetch(`${SCRIPT_URL}?action=add&id=${orderId}&name=${encodeURIComponent(n)}&phone=${ph}&items=${encodeURIComponent(itemsText)}&total=${totalSum}`);

            // 2. Telegramga yuborish
            const keyboard = { inline_keyboard: [
                [{text:"üç≥ Tayyorlanmoqda", callback_data:`status_2_${orderId}`}, {text:"üö¥ Yo'lda", callback_data:`status_3_${orderId}`}],
                [{text:"‚úÖ Yetkazildi", callback_data:`status_4_${orderId}`}]
            ]};

            await fetch(`https://api.telegram.org/bot${BOT}/sendMessage`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ chat_id: ADMIN, text: `üîî BUYURTMA #${orderId}\nüë§ ${n}\nüìû ${ph}\nüõí ${itemsText}\nüí∞ ${totalSum}\nüìç https://www.google.com/maps?q=${coords.latitude},${coords.longitude}`, reply_markup: keyboard })
            });

            // 3. Tarixga saqlash
            let myOrders = JSON.parse(localStorage.getItem('my_orders') || "[]");
            myOrders.unshift({ id: orderId, items: itemsText, total: totalSum, status: 1 });
            localStorage.setItem('my_orders', JSON.stringify(myOrders));

            showAlert("Muvaffaqiyatli", "Buyurtmangiz qabul qilindi!", "success");
            cart = {}; renderCart(); p('history', document.querySelectorAll('.tool-item')[2]);
        }

        async function updateHistory() {
            let myOrders = JSON.parse(localStorage.getItem('my_orders') || "[]");
            const container = document.getElementById('historyList');
            if(myOrders.length === 0) return;

            container.innerHTML = `<p style="text-align:center; padding:20px;"><i class="fa fa-spinner fa-spin"></i> Yangilanmoqda...</p>`;
            
            let html = "";
            const statusTexts = ["", "Qabul qilindi", "Tayyorlanmoqda üë®‚Äçüç≥", "Yo'lda üö¥", "Yetkazildi ‚úÖ"];

            for(let order of myOrders) {
                if(order.status < 4) {
                    try {
                        const res = await fetch(`${SCRIPT_URL}?orderId=${order.id}`);
                        const data = await res.json();
                        if(data.status) order.status = parseInt(data.status);
                    } catch(e) {}
                }
                html += `
                <div class="history-item" style="border-left-color: ${order.status==4?'#2ecc71':'#ffc107'}">
                    <span class="order-id">#${order.id}</span>
                    <span class="order-date">${new Date(order.id).toLocaleTimeString()}</span>
                    <div style="margin:8px 0; font-weight:bold; font-size:14px;">${order.items}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b>${order.total}</b>
                        <span class="status-badge st-${order.status}">${statusTexts[order.status]}</span>
                    </div>
                </div>`;
            }
            container.innerHTML = html;
            localStorage.setItem('my_orders', JSON.stringify(myOrders));
        }

        // (Qolgan renderMenu, updateQty, renderCats funksiyalaringiz o'sha holaticha qoladi...)
        // ... (Kodingizning qolgan qismi)
        
        function renderMenu(data = prods) {
            const container = document.getElementById('menu'); container.innerHTML = "";
            data.forEach(p => {
                const div = document.createElement('div'); div.innerHTML = genCard(p, 'main'); container.appendChild(div);
            });
        }
        function genCard(p, prefix = 'main') {
            let q = cart[p.id] || 0;
            return `<div class="card">
                <img src="${p.img}">
                <div class="card-info">
                    <h4>${p.name}</h4>
                    <b class="price">${p.price.toLocaleString()} so'm</b>
                    <div id="${prefix}-ctrl-${p.id}" class="card-ctrl">
                        ${q > 0 ? `<button onclick="updateQty(${p.id},-1)">-</button><span>${q}</span><button onclick="updateQty(${p.id},1)">+</button>` : 
                        `<button class="add-to-cart" onclick="updateQty(${p.id},1)">Savatga</button>`}
                    </div>
                </div>
            </div>`;
        }
        function updateQty(id, n) {
            cart[id] = (cart[id] || 0) + n;
            if(cart[id] <= 0) delete cart[id];
            renderCart();
            document.querySelectorAll(`[id$="-ctrl-${id}"]`).forEach(ctrl => {
                let q = cart[id] || 0;
                ctrl.innerHTML = q > 0 ? `<button onclick="updateQty(${id},-1)">-</button><span>${q}</span><button onclick="updateQty(${id},1)">+</button>` : 
                `<button class="add-to-cart" onclick="updateQty(${id},1)">Savatga</button>`;
            });
        }
        function renderCats() {
            const cats = ['Barchasi', ...new Set(prods.map(p => p.cat))];
            document.getElementById('catNav').innerHTML = cats.map(c => `<button class="cat-btn" onclick="filterCat('${c}', this)">${c}</button>`).join('');
        }
        function filterCat(c, btn) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); renderMenu(c === 'Barchasi' ? prods : prods.filter(p => p.cat === c));
        }
        function openProfile() { openModal('profileModal'); }
        function saveProfile() {
            const n = document.getElementById('userName').value, ph = document.getElementById('userPhone').value;
            if(n && ph) { localStorage.setItem('c777_name', n); localStorage.setItem('c777_phone', ph); checkProfile(); closeModal('profileModal'); }
        }
        function checkProfile() { const n = localStorage.getItem('c777_name'); if(n) document.getElementById('badgeName').innerText = n.split(' ')[0]; }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function getLocation() { navigator.geolocation.getCurrentPosition(p => { coords = p.coords; document.getElementById('locBtn').innerText = "‚úÖ ANIQLANDI"; }); }
        function renderCart() {
            let t=0, h="";
            for(let id in cart) { let p=prods.find(x=>x.id==id); t+=p.price*cart[id]; h+=`<div class="cart-item"><span>${p.name} (x${cart[id]})</span><b>${(p.price*cart[id]).toLocaleString()}</b></div>`; }
            document.getElementById('cartList').innerHTML = h || "Bo'sh";
            document.getElementById('total').innerText = t.toLocaleString() + " so'm";
        }
        function showAlert(t, m) { alert(t + ": " + m); }

        window.onload = load;
    </script>
</body>
</html>
