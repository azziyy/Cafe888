<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafe 777 - Premium</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <header class="header">
        <div class="logo">CAFE <span>777</span></div>
        <div class="header-icons">
            <i class="fa fa-bell"></i>
            <div class="user-info" onclick="showPage('profile')">
                <span id="user-display">Kirish</span>
            </div>
        </div>
    </header>

    <main id="content">
        <section id="home" class="page active">
            <div class="promo-banner">Bugun barcha pitsalarga -20%</div>
            <div id="categories" class="categories"></div>
            <div id="products" class="products-grid"></div>
        </section>

        <section id="cart" class="page">
            <div class="card-box">
                <h3>Savat ðŸ›’</h3>
                <div id="cart-list" class="cart-list"></div>
                <div class="total-section">
                    <p>Jami: <b id="total-sum">0</b> so'm</p>
                    <button class="btn location-btn" onclick="getLocation()"><i class="fa fa-map-marker-alt"></i> Manzilni aniqlash</button>
                    <button class="btn order-btn" onclick="sendOrder()">Buyurtmani tasdiqlash</button>
                </div>
            </div>
        </section>

        <section id="history" class="page">
            <div class="card-box">
                <h3>Buyurtmalarim ðŸ“œ</h3>
                <div id="history-list"></div>
            </div>
        </section>

        <section id="profile" class="page">
            <div class="card-box">
                <h3>Profil ðŸ‘¤</h3>
                <div class="input-group">
                    <label>Ismingiz</label>
                    <input type="text" id="user-name" placeholder="Ali Valiyev">
                </div>
                <div class="input-group">
                    <label>Telefon raqam</label>
                    <input type="tel" id="user-phone" placeholder="+998901234567">
                </div>
                <button class="btn save-btn" onclick="saveUser()">Ma'lumotlarni saqlash</button>
            </div>
        </section>
    </main>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="showPage('home', this)"><i class="fa fa-home"></i><span>Menyu</span></div>
        <div class="nav-item" onclick="showPage('cart', this)"><i class="fa fa-shopping-basket"></i><span id="cart-count">0</span><span>Savat</span></div>
        <div class="nav-item" onclick="showPage('history', this)"><i class="fa fa-list-alt"></i><span>Buyurtmalar</span></div>
        <div class="nav-item" onclick="showPage('profile', this)"><i class="fa fa-user-gear"></i><span>Profil</span></div>
    </nav>

    <script>
        const SCRIPT_URL = "SIZNING_WEB_APP_URL"; // Deploydan keyingi URLni qo'ying
        const SHEET_ID = "1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk";

        let allProducts = [], cart = {}, user = JSON.parse(localStorage.getItem('user777')), coords = null;

        function showPage(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            if(id === 'history') loadHistory();
            if(id === 'cart') renderCart();
        }

        async function loadData() {
            const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`);
            const text = await res.text();
            const json = JSON.parse(text.substring(47, text.length - 2));
            allProducts = json.table.rows.map((r, i) => ({
                id: i, cat: r.c[1]?.v, name: r.c[2]?.v, price: r.c[3]?.v, img: r.c[4]?.v
            }));
            renderProducts(allProducts);
            renderCats();
        }

        function renderProducts(items) {
            document.getElementById('products').innerHTML = items.map(p => `
                <div class="p-card">
                    <img src="${p.img}" onerror="this.src='https://via.placeholder.com/150'">
                    <div class="p-details">
                        <h4>${p.name}</h4>
                        <b>${p.price.toLocaleString()} so'm</b>
                        <button onclick="addToCart(${p.id})"><i class="fa fa-cart-plus"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function renderCats() {
            const cats = ['Barchasi', ...new Set(allProducts.map(p => p.cat))];
            document.getElementById('categories').innerHTML = cats.map(c => 
                `<button class="cat-btn" onclick="filter('${c}')">${c}</button>`
            ).join('');
        }

        function filter(cat) {
            renderProducts(cat === 'Barchasi' ? allProducts : allProducts.filter(p => p.cat === cat));
        }

        function addToCart(id) {
            cart[id] = (cart[id] || 0) + 1;
            document.getElementById('cart-count').innerText = Object.values(cart).reduce((a, b) => a + b, 0);
        }

        function renderCart() {
            let html = '', total = 0;
            for(let id in cart) {
                const p = allProducts[id];
                total += p.price * cart[id];
                html += `<div class="cart-item">
                    <span>${p.name}</span>
                    <div>
                        <button onclick="changeQty(${id}, -1)">-</button>
                        <b>${cart[id]}</b>
                        <button onclick="changeQty(${id}, 1)">+</button>
                    </div>
                </div>`;
            }
            document.getElementById('cart-list').innerHTML = html || "Savat bo'sh";
            document.getElementById('total-sum').innerText = total.toLocaleString();
        }

        function changeQty(id, val) {
            cart[id] += val;
            if(cart[id] <= 0) delete cart[id];
            renderCart();
            document.getElementById('cart-count').innerText = Object.values(cart).reduce((a, b) => a + b, 0);
        }

        async function sendOrder() {
            if(!user) return showPage('profile');
            if(!coords) return alert("Manzilni aniqlang!");
            if(Object.keys(cart).length === 0) return alert("Savat bo'sh!");

            let items = "";
            for(let id in cart) items += `${allProducts[id].name} (${cart[id]}x), `;
            
            const url = `${SCRIPT_URL}?action=add&clientId=${user.phone}&name=${encodeURIComponent(user.name)}&phone=${user.phone}&items=${encodeURIComponent(items)}&total=${document.getElementById('total-sum').innerText}&lat=${coords.latitude}&lng=${coords.longitude}`;
            
            await fetch(url, {mode: 'no-cors'});
            cart = {}; document.getElementById('cart-count').innerText = 0;
            alert("Buyurtmangiz qabul qilindi!");
            showPage('history');
        }

        async function loadHistory() {
            if(!user) return;
            const res = await fetch(`${SCRIPT_URL}?action=getOrders&clientId=${user.phone}`);
            const data = await res.json();
            document.getElementById('history-list').innerHTML = data.map(o => `
                <div class="h-item">
                    <div class="h-row"><b>#${o.orderId}</b> <span>${o.status}</span></div>
                    <small>${o.items}</small>
                    <div class="h-row"><span>${new Date(o.date).toLocaleDateString()}</span> <b>${o.total} so'm</b></div>
                </div>
            `).join('') || "Hozircha buyurtmalar yo'q";
        }

        function getLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                coords = pos.coords;
                alert("ðŸ“ Manzil muvaffaqiyatli saqlandi!");
            }, () => alert("GPS-ni yoqing!"));
        }

        function saveUser() {
            const name = document.getElementById('user-name').value;
            const phone = document.getElementById('user-phone').value;
            if(!name || !phone) return alert("To'ldiring!");
            user = { name, phone };
            localStorage.setItem('user777', JSON.stringify(user));
            document.getElementById('user-display').innerText = name;
            alert("Profil saqlandi!");
        }

        if(user) document.getElementById('user-display').innerText = user.name;
        loadData();
    </script>
</body>
</html>
