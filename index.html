<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cafe 777 - Smart System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #ffbe0b; --secondary: #fb5607; --dark: #1a1a1a;
            --blue: #0088cc; --green: #2ecc71; --red: #ff4757; --gray: #f0f2f5;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--gray); margin: 0; overflow-x: hidden; }

        /* HEADER */
        .header {
            width: 100%; background: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .badge { background: var(--red); color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; position: absolute; top: -5px; right: -5px; }

        /* DRAWER */
        .drawer { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background: white; z-index: 5501; transition: 0.5s; box-shadow: 10px 0 30px rgba(0,0,0,0.1); }
        .drawer.open { left: 0; }
        .drawer-header { background: var(--primary); padding: 40px 20px; text-align: center; }
        .drawer-item { display: flex; align-items: center; padding: 15px 25px; color: var(--dark); text-decoration: none; font-weight: 600; border-bottom: 1px solid #f5f5f5; }
        .drawer-item i { margin-right: 15px; width: 20px; }

        /* STATUS SECTION */
        .status-box { background: white; margin: 15px; padding: 15px; border-radius: 15px; border-left: 5px solid var(--blue); animation: slideIn 0.5s; }
        .status-step { display: flex; align-items: center; gap: 10px; margin-top: 10px; font-size: 14px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: #ddd; }
        .dot.active { background: var(--green); box-shadow: 0 0 10px var(--green); }

        /* CHAT SECTION */
        .chat-container { height: 300px; overflow-y: auto; padding: 10px; background: #fafafa; border-radius: 10px; margin-bottom: 10px; }
        .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 80%; font-size: 14px; }
        .msg.admin { background: #e1ffeb; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg.user { background: var(--blue); color: white; margin-left: auto; border-bottom-right-radius: 2px; }

        /* CARDS & ANIMATIONS */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; }
        .card { background: white; border-radius: 20px; overflow: hidden; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; transition: 0.3s; }
        .card:active img { transform: scale(1.1); }
        .fav-heart { position: absolute; top: 10px; right: 10px; color: #ccc; font-size: 20px; z-index: 5; }
        .fav-heart.active { color: var(--red); }

        /* MODALS */
        .full-screen-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 7000; display: none; flex-direction: column; padding: 20px; transition: 0.5s; }
        .full-screen-modal.show { display: flex; animation: fadeInUp 0.4s forwards; }
        
        @keyframes fadeInUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }

        .order-btn { background: var(--dark); color: white; border: none; width: 100%; padding: 16px; border-radius: 14px; font-weight: bold; cursor: pointer; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; }
    </style>
</head>
<body>

    <div id="drawer" class="drawer">
        <div class="drawer-header">
            <div style="font-size:40px">üç≥</div>
            <h3 id="drName">Mehmon</h3>
        </div>
        <a href="#" class="drawer-item" onclick="showSec('home')"><i class="fas fa-home"></i> Menyu</a>
        <a href="#" class="drawer-item" onclick="showSec('favs')"><i class="fas fa-heart"></i> Sevimlilar</a>
        <a href="#" class="drawer-item" onclick="showSec('status')"><i class="fas fa-truck"></i> Buyurtmani kuzatish</a>
        <a href="#" class="drawer-item" onclick="showSec('chat')"><i class="fas fa-comment-dots"></i> Xabarlar <span id="msgBadge" class="badge" style="display:none">0</span></a>
    </div>

    <header class="header">
        <button onclick="document.getElementById('drawer').classList.toggle('open')" style="background:none; border:none; font-size:24px;">‚ò∞</button>
        <b>CAFE 777</b>
        <div style="font-size:20px; position:relative;" onclick="showSec('favs')">‚ù§Ô∏è<span id="favBadge" class="badge">0</span></div>
    </header>

    <div id="activeStatus" style="display:none"></div>

    <main id="homeSec">
        <div id="catNav" style="display:flex; gap:10px; overflow-x:auto; padding:15px; background:white;"></div>
        <div class="menu-grid" id="menuDisplay"></div>
    </main>

    <main id="favsSec" style="display:none; padding:15px;">
        <h3>Sevimlilar ‚ù§Ô∏è</h3>
        <div class="menu-grid" id="favDisplay"></div>
    </main>

    <main id="statusSec" style="display:none; padding:15px;">
        <h3>Buyurtma holati üì¶</h3>
        <div id="statusContent">Sizda faol buyurtmalar yo'q.</div>
    </main>

    <main id="chatSec" style="display:none; padding:15px;">
        <h3>Admin bilan muloqot üí¨</h3>
        <div id="chatBox" class="chat-container"></div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="chatInput" placeholder="Xabar yozing...">
            <button onclick="sendChat()" style="background:var(--blue); color:white; border:none; border-radius:12px; padding:0 20px;">‚úâÔ∏è</button>
        </div>
    </main>

    <div style="background:white; margin:15px; padding:20px; border-radius:20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05);">
        <div id="cartItems"></div>
        <div style="display:flex; justify-content:space-between; font-weight:bold; margin:10px 0;">
            <span>Jami:</span><span id="totalPrice">0 so'm</span>
        </div>
        <button class="order-btn" onclick="sendOrder()">BUYURTMA BERISH</button>
    </div>

    <script>
        const BOT_TOKEN = "8032226679:AAETTGPvYZYSvF_QmdofXKibpOwt4E9Iitc";
        const ADMIN_CHAT_ID = "519326806";
        const SHEET_ID = "1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk";

        let products = [], cart = {}, favorites = [], orderStatus = "none";
        let messages = JSON.parse(localStorage.getItem('c777_msgs') || "[]");

        // 1. SEVIMLILAR LOGIKASI
        function toggleFav(id) {
            const idx = favorites.indexOf(id);
            if(idx === -1) favorites.push(id); else favorites.splice(idx,1);
            localStorage.setItem('c777_favs', JSON.stringify(favorites));
            updateUI();
        }

        // 2. BUYURTMA VA STATUS (ADMIN BILAN ALOQA)
        async function sendOrder() {
            if(Object.keys(cart).length === 0) return alert("Savat bo'sh!");
            
            orderStatus = "yuborildi";
            localStorage.setItem('order_status', "yuborildi");
            
            let text = `üöÄ YANGI BUYURTMA!\n\n`;
            for(let id in cart) text += `- ${products.find(x=>x.id==id).name} x${cart[id]}\n`;
            
            // Telegramga status tugmalari bilan yuborish
            const keyboard = {
                inline_keyboard: [
                    [{text: "‚úÖ Qabul qilish", callback_data: `status_qabul_${ADMIN_CHAT_ID}`}],
                    [{text: "üë®‚Äçüç≥ Tayyorlanmoqda", callback_data: `status_tayyorlanmoqda_${ADMIN_CHAT_ID}`}],
                    [{text: "üöö Yo'lda", callback_data: `status_yolda_${ADMIN_CHAT_ID}`}]
                ]
            };

            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    chat_id: ADMIN_CHAT_ID,
                    text: text,
                    reply_markup: keyboard
                })
            });
            
            alert("Buyurtma yuborildi! Statusni kuzatishingiz mumkin.");
            showSec('status');
            updateStatusUI();
        }

        // 3. STATUSNI TEKSHIRIB TURISH (Interval)
        // Eslatma: Haqiqiy server bo'lmasa, biz Bot "getUpdates" orqali Admin xabarlarini tekshiramiz
        async function checkUpdates() {
            try {
                const r = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=-1`);
                const d = await r.json();
                if(d.result.length > 0) {
                    const lastMsg = d.result[0];
                    
                    // Agar admin statusni o'zgartirsa (Sizning holatda buni simulyatsiya qilamiz)
                    if(lastMsg.message && lastMsg.message.text.startsWith("/status")) {
                        const newStatus = lastMsg.message.text.split(" ")[1];
                        orderStatus = newStatus;
                        localStorage.setItem('order_status', newStatus);
                        updateStatusUI();
                    }
                    
                    // Agar admin xabar yozsa
                    if(lastMsg.message && lastMsg.message.chat.id == ADMIN_CHAT_ID && !lastMsg.message.text.startsWith("/")) {
                        const text = lastMsg.message.text;
                        if(!messages.find(m => m.text === text)) {
                            messages.push({type: 'admin', text: text});
                            localStorage.setItem('c777_msgs', JSON.stringify(messages));
                            renderChat();
                            document.getElementById('msgBadge').style.display = 'block';
                        }
                    }
                }
            } catch(e) {}
        }
        setInterval(checkUpdates, 3000); // Har 3 sekundda tekshiradi

        function updateStatusUI() {
            const container = document.getElementById('statusContent');
            const s = localStorage.getItem('order_status') || "none";
            
            if(s === "none") return;

            const steps = [
                {id: "yuborildi", label: "Yuborildi"},
                {id: "qabul", label: "Qabul qilindi"},
                {id: "tayyor", label: "Tayyor bo'ldi"},
                {id: "yolda", label: "Yo'lda / Yetkazilmoqda"}
            ];

            let html = `<div class="status-box"><h3>Buyurtma #${Math.floor(Math.random()*1000)}</h3>`;
            steps.forEach(step => {
                const isActive = (s.includes(step.id)) ? 'active' : '';
                html += `<div class="status-step"><div class="dot ${isActive}"></div> ${step.label}</div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        // 4. CHAT LOGIKASI
        function sendChat() {
            const input = document.getElementById('chatInput');
            if(!input.value) return;
            
            const txt = input.value;
            messages.push({type: 'user', text: txt});
            localStorage.setItem('c777_msgs', JSON.stringify(messages));
            
            // Adminga yuborish
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ chat_id: ADMIN_CHAT_ID, text: `üí¨ Xabar: ${txt}` })
            });
            
            input.value = "";
            renderChat();
        }

        function renderChat() {
            const box = document.getElementById('chatBox');
            box.innerHTML = messages.map(m => `<div class="msg ${m.type}">${m.text}</div>`).join('');
            box.scrollTop = box.scrollHeight;
        }

        // 5. ASOSIY FUNKSIYALAR
        function showSec(id) {
            ['homeSec', 'favsSec', 'statusSec', 'chatSec'].forEach(s => document.getElementById(s).style.display = 'none');
            document.getElementById(id + 'Sec').style.display = 'block';
            document.getElementById('drawer').classList.remove('open');
            if(id === 'chat') {
                renderChat();
                document.getElementById('msgBadge').style.display = 'none';
            }
            if(id === 'favs') renderFavs();
        }

        async function loadData() {
            const r = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`);
            const t = await r.text();
            const j = JSON.parse(t.substr(47).slice(0, -2));
            products = j.table.rows.map((r, i) => ({
                id: i+1, cat: r.c[1]?.v, name: r.c[2]?.v, price: r.c[3]?.v, img: r.c[4]?.v
            }));
            renderMenu();
        }

        function renderMenu() {
            document.getElementById('menuDisplay').innerHTML = products.map(p => `
                <div class="card">
                    <i class="fas fa-heart fav-heart ${favorites.includes(p.id)?'active':''}" onclick="toggleFav(${p.id})"></i>
                    <img src="${p.img}">
                    <div style="padding:10px; text-align:center">
                        <div style="font-size:14px; font-weight:600">${p.name}</div>
                        <div style="color:var(--secondary)">${p.price.toLocaleString()} so'm</div>
                        <button onclick="addToCart(${p.id})" style="margin-top:5px; border:none; background:var(--dark); color:white; border-radius:5px; padding:5px 10px;">+ Savat</button>
                    </div>
                </div>
            `).join('');
        }

        function renderFavs() {
            const favProducts = products.filter(p => favorites.includes(p.id));
            document.getElementById('favDisplay').innerHTML = favProducts.map(p => `
                <div class="card"><img src="${p.img}"><div style="padding:10px">${p.name}</div></div>
            `).join('');
        }

        function addToCart(id) {
            cart[id] = (cart[id] || 0) + 1;
            updateUI();
        }

        function updateUI() {
            document.getElementById('favBadge').innerText = favorites.length;
            let total = 0;
            for(let id in cart) total += products.find(x=>x.id==id).price * cart[id];
            document.getElementById('totalPrice').innerText = total.toLocaleString() + " so'm";
        }

        window.onload = () => {
            favorites = JSON.parse(localStorage.getItem('c777_favs') || "[]");
            loadData();
            updateStatusUI();
            updateUI();
        };
    </script>
</body>
</html>
