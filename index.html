<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>777 Cafe Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #FF7F50; --dark: #0F172A; --bg: #F8FAFC; --white: #FFFFFF; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color:transparent; }
        body { background: var(--bg); color: var(--dark); overflow-x: hidden; }

        /* Loader */
        #splash { position:fixed; inset:0; background:var(--white); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.5s; }
        .spinner { width:45px; height:45px; border:4px solid #E2E8F0; border-top-color: var(--primary); border-radius: 50%; animation: s 1s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }

        /* Header */
        header { position:sticky; top:0; background:rgba(255,255,255,0.85); backdrop-filter:blur(12px); padding:15px 20px; display:flex; justify-content:space-between; align-items:center; z-index:1000; border-bottom:1px solid #F1F5F9; }
        .logo { font-size:22px; font-weight:800; color:var(--dark); }
        .logo span { color:var(--primary); }

        /* Auth */
        #auth-ui { position:fixed; inset:0; background:rgba(15,23,42,0.9); backdrop-filter:blur(10px); z-index:9000; display:none; align-items:center; justify-content:center; padding:20px; }
        .auth-card { background:var(--white); width:100%; max-width:380px; padding:35px; border-radius:30px; text-align:center; }
        input { width:100%; padding:16px; margin:12px 0; border:2px solid #F1F5F9; border-radius:15px; font-size:16px; outline:none; }

        /* Menu Grid */
        .cats { display:flex; overflow-x:auto; padding:15px 20px; gap:10px; scrollbar-width:none; }
        .chip { padding:10px 22px; background:var(--white); border-radius:30px; font-size:14px; font-weight:700; white-space:nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.04); }
        .chip.active { background:var(--dark); color:white; }
        .grid { display:grid; grid-template-columns: 1fr 1fr; gap:15px; padding:0 15px 120px; }
        .card { background:var(--white); border-radius:24px; overflow:hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.03); position:relative; }
        .card img { width:100%; height:135px; object-fit:cover; }
        .card-p { padding:12px; }
        .price { color:var(--primary); font-weight:800; }

        /* Buttons */
        .btn-main { width:100%; padding:18px; background:var(--primary); color:white; border:none; border-radius:18px; font-weight:800; font-size:16px; cursor:pointer; }
        .add-btn { position:absolute; bottom:10px; right:10px; width:36px; height:36px; background:var(--primary); color:white; border:none; border-radius:12px; }
        .qty { display:flex; align-items:center; gap:8px; background:#F8FAFC; border-radius:10px; padding:3px; position:absolute; bottom:10px; right:10px; }
        .qty button { width:28px; height:28px; background:white; border:none; border-radius:8px; font-weight:800; color:var(--primary); }

        /* Nav */
        nav { position:fixed; bottom:25px; left:20px; right:20px; background:var(--dark); height:75px; border-radius:25px; display:flex; justify-content:space-around; align-items:center; z-index:2000; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        .n-item { color:#64748B; text-decoration:none; display:flex; flex-direction:column; align-items:center; font-size:10px; gap:5px; position:relative; }
        .n-item.active { color:var(--primary); }
        .n-item i { font-size:22px; }
        .badge { position:absolute; top:-6px; right:-8px; background:var(--primary); color:white; width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:800; border:3px solid var(--dark); }

        .page { display:none; }
        .page.active { display:block; }
        .footer-cart { position:fixed; bottom:115px; left:20px; right:20px; background:var(--white); padding:20px; border-radius:25px; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div id="splash"><div class="spinner"></div><h2 style="margin-top:20px; font-weight:800">777 CAFE</h2></div>

    <div id="auth-ui">
        <div class="auth-card">
            <h2 style="font-weight:800">Xush kelibsiz! üëã</h2>
            <input type="text" id="un" placeholder="Ismingiz">
            <input type="tel" id="up" placeholder="Telefoningiz" value="+998">
            <button onclick="saveU()" class="btn-main">DAVOM ETISH</button>
        </div>
    </div>

    <header>
        <div class="logo">CAFE <span>777</span></div>
        <div id="user-l" style="font-weight:700; color:var(--primary)">Premium</div>
    </header>

    <main>
        <section id="menu-p" class="page active">
            <div class="cats" id="cats"></div>
            <div class="grid" id="grid"></div>
        </section>

        <section id="cart-p" class="page" style="padding:20px">
            <h2 style="font-weight:800; margin-bottom:20px">Savatcha üõí</h2>
            <div id="c-list"></div>
            <div style="height:300px"></div>
            <div class="footer-cart" id="c-nav" style="display:none">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px">
                    <b>Umumiy:</b> <b id="total" style="color:var(--primary)">0 so'm</b>
                </div>
                <button onclick="getLoc()" id="l-btn" style="width:100%; padding:12px; border:2px dashed #DDD; background:none; border-radius:15px; margin-bottom:10px">üìç Manzilni aniqlash</button>
                <button onclick="order()" class="btn-main">YUBORISH</button>
            </div>
        </section>

        <section id="history-p" class="page" style="padding:20px">
            <h2 style="font-weight:800; margin-bottom:20px">Tarix üìú</h2>
            <div id="h-list"></div>
        </section>
    </main>

    <nav>
        <div class="n-item active" onclick="go('menu', this)"><i class="fa-solid fa-utensils"></i><span>Menyu</span></div>
        <div class="n-item" onclick="go('cart', this)"><i class="fa-solid fa-bag-shopping"><span class="badge" id="badge" style="display:none">0</span></i><span>Savat</span></div>
        <div class="n-item" onclick="go('history', this)"><i class="fa-solid fa-clock-rotate-left"></i><span>Tarix</span></div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const API = {
            S: "https://docs.google.com/spreadsheets/d/1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk/gviz/tq?tqx=out:json",
            W: "https://script.google.com/macros/s/AKfycbxOIkZkCrjmTI-8rm-P9UZfx2Qxc5ewsOgzXlgREnrCWb44XPSYMDkFe7Akcm8rUa32YA/exec"
        };

        let db = [], cart = {}, loc = null;

        async function start() {
            try {
                const r = await fetch(API.S);
                const t = await r.text();
                const j = JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));
                db = j.table.rows.filter(r => r.c[2]).map((r, i) => ({
                    id: i+1, cat: r.c[1]?.v || 'Menu', name: r.c[2].v, price: r.c[3]?.v || 0, img: r.c[4]?.v || 'https://via.placeholder.com/200'
                }));
                render();
            } catch (e) { console.error(e); }
            finally { setTimeout(() => { document.getElementById('splash').style.opacity='0'; setTimeout(()=>document.getElementById('splash').remove(),500); }, 1000); }
        }

        function render() {
            const cs = ['Barchasi', ...new Set(db.map(p => p.cat))];
            document.getElementById('cats').innerHTML = cs.map(c => `<div class="chip" onclick="fMenu('${c}', this)">${c}</div>`).join('');
            fMenu('Barchasi');
            checkU();
        }

        function fMenu(c, el) {
            if(el) { document.querySelectorAll('.chip').forEach(x => x.classList.remove('active')); el.classList.add('active'); }
            const l = c === 'Barchasi' ? db : db.filter(p => p.cat === c);
            document.getElementById('grid').innerHTML = l.map(p => `
                <div class="card">
                    <img src="${p.img}">
                    <div class="card-p"><h4>${p.name}</h4><b class="price">${p.price.toLocaleString()} so'm</b></div>
                    <div id="btn-${p.id}">${bHtml(p.id)}</div>
                </div>
            `).join('');
        }

        function bHtml(id) {
            return cart[id] ? `<div class="qty"><button onclick="upd(${id},-1)">-</button><span>${cart[id]}</span><button onclick="upd(${id},1)">+</button></div>` : 
            `<button class="add-btn" onclick="upd(${id},1)"><i class="fa fa-plus"></i></button>`;
        }

        function upd(id, n) {
            cart[id] = (cart[id] || 0) + n;
            if(cart[id] <= 0) delete cart[id];
            if(document.getElementById(`btn-${id}`)) document.getElementById(`btn-${id}`).innerHTML = bHtml(id);
            const sum = Object.values(cart).reduce((a,b)=>a+b,0);
            document.getElementById('badge').innerText = sum;
            document.getElementById('badge').style.display = sum > 0 ? 'flex' : 'none';
        }

        async function order() {
            if(!loc) return Swal.fire('Manzil', 'Iltimos, manzilni aniqlang!', 'warning');
            Swal.fire({title: 'Yuborilmoqda...', didOpen: () => Swal.showLoading()});
            
            const u = JSON.parse(localStorage.getItem('u777'));
            const orderId = Date.now();
            let items = "";
            for(let id in cart) { items += `${db.find(x=>x.id==id).name} (${cart[id]}x), `; }

            const url = `${API.W}?action=add&id=${orderId}&name=${encodeURIComponent(u.name)}&phone=${u.phone}&items=${encodeURIComponent(items)}&total=${document.getElementById('total').innerText}&lat=${loc.lat}&lng=${loc.lng}`;
            
            try {
                await fetch(url, { mode: 'no-cors' });
                let hist = JSON.parse(localStorage.getItem('h777') || "[]");
                hist.unshift({id: orderId, items, total: document.getElementById('total').innerText, date: new Date().toLocaleTimeString(), status: 0});
                localStorage.setItem('h777', JSON.stringify(hist));
                
                cart = {}; upd(0,0);
                Swal.fire('Rahmat!', 'Buyurtmangiz yuborildi!', 'success');
                go('history', document.querySelectorAll('.n-item')[2]);
            } catch(e) { Swal.fire('Xato', 'Ketmadi!', 'error'); }
        }

        function getLoc() {
            const b = document.getElementById('l-btn');
            navigator.geolocation.getCurrentPosition(p => {
                loc = {lat: p.coords.latitude, lng: p.coords.longitude};
                b.innerText = "‚úÖ Manzil aniqlandi"; b.style.color = "#10B981";
            }, () => Swal.fire('GPS', 'Ruxsat bering!', 'error'));
        }

        function checkU() {
            const u = JSON.parse(localStorage.getItem('u777'));
            if(!u) document.getElementById('auth-ui').style.display='flex';
            else document.getElementById('user-l').innerText = u.name;
        }

        function saveU() {
            const n = document.getElementById('un').value, p = document.getElementById('up').value;
            if(n.length<3) return;
            localStorage.setItem('u777', JSON.stringify({name:n, phone:p}));
            document.getElementById('auth-ui').style.display='none';
            document.getElementById('user-l').innerText = n;
        }

        function go(p, el) {
            document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
            document.getElementById(p+'-p').classList.add('active');
            document.querySelectorAll('.n-item').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            if(p==='cart') {
                let h = "", tot = 0;
                for(let id in cart) {
                    const p = db.find(x => x.id == id);
                    tot += p.price * cart[id];
                    h += `<div style="background:white; padding:15px; border-radius:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center">
                        <div><b>${p.name}</b><br><small>${p.price.toLocaleString()}</small></div>
                        <div class="qty" style="position:static"><button onclick="upd(${id},-1);go('cart',el)">-</button><span>${cart[id]}</span><button onclick="upd(${id},1);go('cart',el)">+</button></div>
                    </div>`;
                }
                document.getElementById('c-list').innerHTML = h || "Bo'sh";
                document.getElementById('total').innerText = tot.toLocaleString() + " so'm";
                document.getElementById('c-nav').style.display = tot > 0 ? 'block' : 'none';
            }
            if(p==='history') {
                const h = JSON.parse(localStorage.getItem('h777') || "[]");
                document.getElementById('h-list').innerHTML = h.map(o => `
                    <div style="background:white; padding:15px; border-radius:15px; margin-bottom:10px; border-left:5px solid var(--primary)">
                        <div style="display:flex; justify-content:space-between"><small>#${o.id.toString().slice(-5)}</small> <b>Kutilmoqda</b></div>
                        <p style="font-size:13px; margin:5px 0">${o.items}</p>
                        <b>${o.total}</b>
                    </div>
                `).join('') || "Tarix bo'sh";
            }
        }

        window.onload = start;
    </script>
</body>
</html>
