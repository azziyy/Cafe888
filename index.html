<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>777 Cafe Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF7F50;
            --dark: #1A1A1A;
            --light: #F8F9FA;
            --white: #FFFFFF;
            --gray: #94A3B8;
            --radius-lg: 24px;
            --radius-md: 16px;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color:transparent; }
        body { background: var(--light); color: var(--dark); line-height: 1.6; }

        /* Splash Screen */
        #splash { position:fixed; inset:0; background:var(--white); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.8s; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Auth Form (Ro'yxatdan o'tish) */
        #auth-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(8px); z-index:9000; display:none; align-items:center; justify-content:center; padding:20px; }
        .auth-card { background:var(--white); width:100%; max-width:400px; padding:30px; border-radius:var(--radius-lg); box-shadow:var(--shadow); text-align:center; }
        .auth-card h2 { margin-bottom:10px; font-weight:800; }
        .auth-card input { width:100%; padding:15px; margin:10px 0; border:2px solid #EEE; border-radius:var(--radius-md); font-size:16px; outline:none; transition:0.3s; }
        .auth-card input:focus { border-color:var(--primary); }
        .auth-card button { width:100%; padding:16px; background:var(--primary); color:white; border:none; border-radius:var(--radius-md); font-weight:800; font-size:16px; cursor:pointer; margin-top:10px; }

        /* Header */
        header { position:sticky; top:0; background:rgba(255,255,255,0.8); backdrop-filter:blur(15px); padding:15px 20px; display:flex; justify-content:space-between; align-items:center; z-index:1000; border-bottom:1px solid rgba(0,0,0,0.05); }
        .logo { font-size:22px; font-weight:800; color:var(--dark); }
        .logo span { color:var(--primary); }

        /* Category chips */
        .cats { display:flex; overflow-x:auto; padding:15px 20px; gap:10px; scrollbar-width:none; }
        .cats::-webkit-scrollbar { display:none; }
        .chip { padding:10px 22px; background:var(--white); border-radius:30px; font-size:14px; font-weight:600; white-space:nowrap; box-shadow:var(--shadow); transition:0.3s; border:1px solid transparent; }
        .chip.active { background:var(--dark); color:white; }

        /* Grid & Cards */
        .grid { display:grid; grid-template-columns: 1fr 1fr; gap:15px; padding:0 15px 120px; }
        .card { background:var(--white); border-radius:var(--radius-lg); overflow:hidden; box-shadow:var(--shadow); position:relative; }
        .card img { width:100%; height:140px; object-fit:cover; }
        .card-body { padding:12px; }
        .card-body h4 { font-size:14px; font-weight:700; margin-bottom:5px; height:20px; overflow:hidden; }
        .card-price { color:var(--primary); font-weight:800; font-size:15px; }
        .add-btn { position:absolute; bottom:10px; right:10px; width:35px; height:35px; background:var(--primary); color:white; border:none; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:18px; box-shadow:0 4px 10px rgba(255,127,80,0.3); }

        /* Quantity Controls */
        .qty-ctrl { display:flex; align-items:center; gap:8px; background:#F1F5F9; border-radius:10px; padding:3px; position:absolute; bottom:10px; right:10px; }
        .qty-ctrl button { width:28px; height:28px; border:none; background:white; border-radius:8px; font-weight:800; color:var(--primary); }

        /* Navigation */
        nav { position:fixed; bottom:20px; left:20px; right:20px; background:var(--dark); height:70px; border-radius:25px; display:flex; justify-content:space-around; align-items:center; z-index:2000; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .nav-item { color:var(--gray); text-decoration:none; display:flex; flex-direction:column; align-items:center; font-size:10px; gap:4px; }
        .nav-item.active { color:var(--primary); }
        .nav-item i { font-size:20px; }
        .badge { position:absolute; top:-5px; right:-8px; background:var(--primary); color:white; width:18px; height:18px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:800; border:2px solid var(--dark); }

        /* Sections */
        .page { display:none; animation: slideUp 0.4s ease; }
        .page.active { display:block; }
        @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

        /* Cart Footer */
        .cart-footer { position:fixed; bottom:100px; left:20px; right:20px; background:var(--white); padding:20px; border-radius:var(--radius-lg); box-shadow:0 -10px 40px rgba(0,0,0,0.1); }
        .btn-order { width:100%; padding:18px; background:var(--primary); color:white; border:none; border-radius:var(--radius-md); font-weight:800; font-size:16px; margin-top:15px; }

        /* History */
        .h-card { background:white; margin:10px 20px; padding:15px; border-radius:var(--radius-md); box-shadow:var(--shadow); border-left:5px solid var(--primary); }
    </style>
</head>
<body>

    <div id="splash"><div class="spinner"></div><h2 style="margin-top:20px">777 CAFE</h2></div>

    <div id="auth-overlay">
        <div class="auth-card">
            <h2>Xush kelibsiz! üëã</h2>
            <p style="color:var(--gray); margin-bottom:15px">Buyurtma berish uchun ma'lumotlaringizni kiriting</p>
            <input type="text" id="u-name" placeholder="Ismingiz">
            <input type="tel" id="u-phone" placeholder="Telefoningiz" value="+998">
            <button onclick="saveUser()">Davom etish</button>
        </div>
    </div>

    <header>
        <div class="logo">CAFE <span>777</span></div>
        <div id="user-display" style="font-weight:600">Profil</div>
    </header>

    <main>
        <section id="menu-p" class="page active">
            <div class="cats" id="cat-nav"></div>
            <div class="grid" id="menu-grid"></div>
        </section>

        <section id="cart-p" class="page" style="padding:20px">
            <h2 style="font-weight:800; margin-bottom:20px">Savatda üõí</h2>
            <div id="cart-list"></div>
            <div style="height:280px"></div>
            <div class="cart-footer" id="c-foot" style="display:none">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <span style="font-weight:600">Jami:</span>
                    <b id="total-price" style="font-size:22px; color:var(--primary)">0 so'm</b>
                </div>
                <button onclick="getPos()" id="loc-btn" style="width:100%; margin-top:15px; padding:10px; border:1px solid #EEE; background:none; border-radius:10px; font-weight:600">üìç Manzilni yuborish</button>
                <button onclick="checkout()" class="btn-order">BUYURTMA BERISH</button>
            </div>
        </section>

        <section id="history-p" class="page" style="padding:20px">
            <h2 style="font-weight:800; margin-bottom:20px">Tarix üìú</h2>
            <div id="history-list"></div>
        </section>
    </main>

    <nav>
        <a href="#" class="nav-item active" onclick="showP('menu', this)"><i class="fa-solid fa-house"></i><span>Asosiy</span></a>
        <a href="#" class="nav-item" onclick="showP('cart', this)"><i class="fa-solid fa-cart-shopping"><span class="badge" id="badge" style="display:none">0</span></i><span>Savat</span></a>
        <a href="#" class="nav-item" onclick="showP('history', this)"><i class="fa-solid fa-clock-rotate-left"></i><span>Tarix</span></a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const API = {
            SHEET: "https://docs.google.com/spreadsheets/d/1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk/gviz/tq?tqx=out:json",
            SCRIPT: "https://script.google.com/macros/s/AKfycbyczPTwYHrR8RkuMpFuuHwc-lrj57OTFXykW4oGkoZdxGqcKOCSxQYKd6pTegz53uSBjg/exec"
        };

        let products = [], cart = {}, userLoc = null;

        async function start() {
            try {
                const res = await fetch(API.SHEET);
                const txt = await res.text();
                const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}") + 1));
                products = json.table.rows.filter(r => r.c[2]).map((r, i) => ({
                    id: i+1, cat: r.c[1]?.v || 'Boshqa', name: r.c[2].v, price: r.c[3]?.v || 0, img: r.c[4]?.v || 'https://via.placeholder.com/200', desc: r.c[5]?.v || ''
                }));
                renderCats();
                renderMenu('Barchasi');
                checkUser();
            } catch (e) { console.error(e); }
            finally { 
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => document.getElementById('splash').remove(), 800);
            }
        }

        function renderCats() {
            const c = ['Barchasi', ...new Set(products.map(p => p.cat))];
            document.getElementById('cat-nav').innerHTML = c.map(t => `<div class="chip" onclick="filter('${t}', this)">${t}</div>`).join('');
            document.querySelector('.chip').classList.add('active');
        }

        function filter(t, el) {
            document.querySelectorAll('.chip').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            renderMenu(t);
        }

        function renderMenu(t) {
            const list = t === 'Barchasi' ? products : products.filter(p => p.cat === t);
            document.getElementById('menu-grid').innerHTML = list.map(p => `
                <div class="card">
                    <img src="${p.img}" onclick="Swal.fire({imageUrl:'${p.img}', showConfirmButton:false})">
                    <div class="card-body">
                        <h4>${p.name}</h4>
                        <b class="card-price">${p.price.toLocaleString()} so'm</b>
                    </div>
                    <div id="ctrl-${p.id}">${btnHtml(p.id)}</div>
                </div>
            `).join('');
        }

        function btnHtml(id) {
            return cart[id] ? `<div class="qty-ctrl"><button onclick="updateQty(${id},-1)">-</button><span>${cart[id]}</span><button onclick="updateQty(${id},1)">+</button></div>` : 
            `<button class="add-btn" onclick="updateQty(${id},1)"><i class="fa fa-plus"></i></button>`;
        }

        function updateQty(id, n) {
            cart[id] = (cart[id] || 0) + n;
            if(cart[id] <= 0) delete cart[id];
            const el = document.getElementById(`ctrl-${id}`);
            if(el) el.innerHTML = btnHtml(id);
            updateBadge();
            if(document.getElementById('cart-p').classList.contains('active')) renderCart();
        }

        function updateBadge() {
            const sum = Object.values(cart).reduce((a,b) => a+b, 0);
            const b = document.getElementById('badge');
            b.innerText = sum; b.style.display = sum > 0 ? 'flex' : 'none';
        }

        function renderCart() {
            let h = "", tot = 0;
            for(let id in cart) {
                const p = products.find(x => x.id == id);
                tot += p.price * cart[id];
                h += `<div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:15px; border-radius:15px; margin-bottom:10px; box-shadow:var(--shadow)">
                    <div><b>${p.name}</b><br><small>${p.price.toLocaleString()} so'm</small></div>
                    <div class="qty-ctrl" style="position:static"><button onclick="updateQty(${id},-1)">-</button><span>${cart[id]}</span><button onclick="updateQty(${id},1)">+</button></div>
                </div>`;
            }
            document.getElementById('cart-list').innerHTML = h || "<p style='text-align:center; color:var(--gray)'>Savat bo'sh</p>";
            document.getElementById('total-price').innerText = tot.toLocaleString() + " so'm";
            document.getElementById('c-foot').style.display = tot > 0 ? 'block' : 'none';
        }

        async function checkout() {
            if(!userLoc) return Swal.fire('Manzil?', 'Iltimos, manzilni aniqlash tugmasini bosing!', 'warning');
            Swal.fire({title: 'Yuborilmoqda...', didOpen: () => Swal.showLoading()});
            
            const u = JSON.parse(localStorage.getItem('user_777'));
            const id = Date.now();
            let items = "";
            for(let k in cart) { items += `${products.find(x=>x.id==k).name} (${cart[k]}x), `; }

            // Telegramga yuborish (Xavfsizroq usul)
            const scriptUrl = `${API.SCRIPT}?action=add&id=${id}&name=${encodeURIComponent(u.name)}&phone=${u.phone}&items=${encodeURIComponent(items)}&total=${document.getElementById('total-price').innerText}&lat=${userLoc.lat}&lng=${userLoc.lng}`;
            
            try {
                await fetch(scriptUrl, { mode: 'no-cors' });
                let hist = JSON.parse(localStorage.getItem('hist_777') || "[]");
                hist.unshift({id, items, total: document.getElementById('total-price').innerText, status: 1});
                localStorage.setItem('hist_777', JSON.stringify(hist));
                cart = {}; updateBadge();
                Swal.fire('Rahmat!', 'Buyurtmangiz qabul qilindi!', 'success');
                showP('history', document.querySelectorAll('.nav-item')[2]);
            } catch(e) { Swal.fire('Xato', 'Internetni tekshiring!', 'error'); }
        }

        function getPos() {
            const btn = document.getElementById('loc-btn');
            btn.innerText = "Aniqlanmoqda...";
            navigator.geolocation.getCurrentPosition(p => {
                userLoc = {lat: p.coords.latitude, lng: p.coords.longitude};
                btn.innerText = "‚úÖ Manzil aniqlandi"; btn.style.color = "green";
            }, () => { Swal.fire('Xato', 'GPSni yoqing!', 'error'); btn.innerText = "üìç Manzilni aniqlash"; });
        }

        function checkUser() {
            const u = JSON.parse(localStorage.getItem('user_777'));
            if(!u) document.getElementById('auth-overlay').style.display = 'flex';
            else document.getElementById('user-display').innerText = u.name;
        }

        function saveUser() {
            const n = document.getElementById('u-name').value;
            const p = document.getElementById('u-phone').value;
            if(n.length < 3) return Swal.fire('Xato', 'Ismingizni kiriting', 'error');
            localStorage.setItem('user_777', JSON.stringify({name: n, phone: p}));
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('user-display').innerText = n;
        }

        function showP(p, el) {
            document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
            document.getElementById(p+'-p').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            if(p==='cart') renderCart();
            if(p==='history') renderHistory();
        }

        function renderHistory() {
            const h = JSON.parse(localStorage.getItem('hist_777') || "[]");
            document.getElementById('history-list').innerHTML = h.map(o => `
                <div class="h-card">
                    <div style="display:flex; justify-content:space-between"><small>#${o.id.toString().slice(-5)}</small> <b>Kutilmoqda</b></div>
                    <p style="font-size:13px; margin:5px 0">${o.items}</p>
                    <b style="color:var(--primary)">${o.total}</b>
                </div>
            `).join('') || "<p style='text-align:center'>Tarix bo'sh</p>";
        }

        window.onload = start;
    </script>
</body>
</html>
