<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cafe 777 - Final</title>
    <style>
        :root {
            --primary: #ffbe0b; --secondary: #fb5607; --dark: #1a1a1a;
            --blue: #0088cc; --green: #2ecc71; --red: #ff4757; --gray: #f4f7f6;
        }

        /* Barcha Italic (qiyshiq) yozuvlarni yo'qotish va tekislash */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            font-style: normal !important; 
            font-family: 'Segoe UI', sans-serif;
        }

        body { background-color: var(--gray); margin: 0; padding-bottom: 90px; }

        /* QALQIB CHIQISH XABARI */
        #toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: var(--dark); color: white; padding: 14px 28px;
            border-radius: 50px; z-index: 10000; transition: 0.5s;
            font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        #toast.show { top: 30px; }

        /* BOTTOM TOOLBAR */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 12px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 2000;
            border-radius: 20px 20px 0 0;
        }
        .nav-item { text-align: center; font-size: 12px; color: #aaa; cursor: pointer; flex: 1; font-weight: 600; }
        .nav-item.active { color: var(--secondary); }
        .nav-item b { font-size: 20px; display: block; }

        /* SAHIFALAR */
        .page { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* MENU VA KARTALAR */
        .category-nav { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 15px; }
        .category-nav::-webkit-scrollbar { display: none; }
        .cat-btn { padding: 10px 20px; border-radius: 15px; border: none; background: white; font-weight: 700; white-space: nowrap; }
        .cat-btn.active { background: var(--primary); color: white; }

        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: white; border-radius: 20px; overflow: hidden; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .fav-heart { position: absolute; top: 10px; right: 10px; font-size: 22px; color: rgba(255,255,255,0.8); z-index: 5; }
        .fav-heart.active { color: var(--red); }
        .card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
        .card-info { padding: 12px; text-align: center; }
        
        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 5000; display: none;
            align-items: center; justify-content: center;
        }
        .modal-card { background: white; width: 90%; border-radius: 25px; overflow: hidden; animation: zoom 0.3s; }
        @keyframes zoom { from { transform: scale(0.8); } to { transform: scale(1); } }

        /* TUGMALAR */
        .btn-main { background: var(--dark); color: white; border: none; width: 100%; padding: 15px; border-radius: 15px; font-weight: 700; cursor: pointer; }
        .c-btn { width: 35px; height: 35px; border-radius: 10px; border: none; background: #eee; font-weight: bold; }
        
        input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #ddd; outline: none; font-size: 16px; }
    </style>
</head>
<body>

    <div id="toast">Habar!</div>

    <div id="regModal" class="modal-overlay" style="display: flex;">
        <div class="modal-card" style="padding: 30px; text-align: center;">
            <h2>Xush kelibsiz! üëã</h2>
            <p>Ismingiz va raqamingizni kiriting</p>
            <input type="text" id="regName" placeholder="Ismingiz">
            <input type="tel" id="regPhone" placeholder="+998901234567">
            <button class="btn-main" onclick="saveReg()">DAVOM ETISH</button>
        </div>
    </div>

    <div id="page-home" class="page">
        <h2>Menu üçî</h2>
        <div class="category-nav" id="catNav"></div>
        <div class="menu-grid" id="menuDisplay"></div>
    </div>

    <div id="page-favs" class="page">
        <h2>Sevimlilar ‚ù§Ô∏è</h2>
        <div id="favList" class="menu-grid"></div>
    </div>

    <div id="page-cart" class="page">
        <h2>Savat üõí</h2>
        <div id="cartItems" style="background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px;"></div>
        <div style="display: flex; justify-content: space-between; font-weight: 800; font-size: 20px; margin-bottom: 20px;">
            <span>Jami:</span> <span id="totalPrice">0 so'm</span>
        </div>
        <button class="btn-main" onclick="getLocation()" id="locBtn" style="background:#eee; color:#333; margin-bottom:10px;">üìç MANZILNI ANIQLASH</button>
        <button class="btn-main" onclick="sendOrder()" id="orderBtn" style="background:var(--blue);">BUYURTMA BERISH</button>
    </div>

    <div id="page-history" class="page">
        <h2>Tarix üìú</h2>
        <div id="orderHistory"></div>
    </div>

    <div id="page-profile" class="page">
        <h2>Profil üë§</h2>
        <div style="background: white; padding: 20px; border-radius: 20px; text-align: center;">
            <h3 id="pName">Ism</h3>
            <p id="pPhone">Raqam</p>
            <button onclick="localStorage.clear(); location.reload();" style="border:none; color:red; background:none; cursor:pointer;">Chiqish</button>
        </div>
    </div>

    <div id="productModal" class="modal-overlay" onclick="if(event.target==this) closeProduct()">
        <div class="modal-card">
            <img id="pm-img" style="width: 100%;">
            <div style="padding: 20px;">
                <h2 id="pm-title" style="margin:0;"></h2>
                <p id="pm-desc" style="color:#666;"></p>
                <b id="pm-price" style="font-size: 20px; color: var(--secondary);"></b>
                <div id="pm-counter" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="showPage('home', this)"><b>üè†</b>Menu</div>
        <div class="nav-item" onclick="showPage('favs', this)"><b>‚ù§Ô∏è</b>Sevimli</div>
        <div class="nav-item" onclick="showPage('cart', this)"><b>üõí</b>Savat</div>
        <div class="nav-item" onclick="showPage('history', this)"><b>üìú</b>Tarix</div>
        <div class="nav-item" onclick="showPage('profile', this)"><b>üë§</b>Profil</div>
    </div>

    <script>
        const BOT_TOKEN = "8032226679:AAETTGPvYZYSvF_QmdofXKibpOwt4E9Iitc";
        const CHAT_ID = "519326806";
        const SHEET_ID = "1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk";

        let products = [], cart = {}, favorites = [], history = [], userLoc = null, currentCat = 'Barchasi';

        // 1. RO'YXATDAN O'TISH FUNKSIYASI (ISHONCHLI)
        function saveReg() {
            const name = document.getElementById('regName').value.trim();
            const phone = document.getElementById('regPhone').value.trim();

            if (name === "" || phone === "") {
                alert("Iltimos, ma'lumotlarni to'ldiring!");
                return;
            }

            localStorage.setItem('u_name', name);
            localStorage.setItem('u_phone', phone);
            
            // Modalni yopish va asosiy sahifani ochish
            document.getElementById('regModal').style.display = 'none';
            showPage('home');
            updateProfileUI();
            loadData(); // Ma'lumotlarni yuklash
        }

        // AGAR OLDIN RO'YXATDAN O'TGAN BO'LSA
        if (localStorage.getItem('u_name')) {
            document.getElementById('regModal').style.display = 'none';
            showPage('home');
            updateProfileUI();
            loadData();
        }

        async function loadData() {
            try {
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`);
                const text = await res.text();
                const json = JSON.parse(text.substr(47).slice(0, -2));
                products = json.table.rows.map((r, i) => ({
                    id: i+1, cat: r.c[1]?.v || 'Boshqa', name: r.c[2]?.v || 'Nomsiz', 
                    price: r.c[3]?.v || 0, img: r.c[4]?.v || '', desc: r.c[5]?.v || 'Tavsif yoq'
                }));
                renderCats(); renderMenu();
            } catch (e) { console.log("Xato yuklashda"); }
        }

        function renderCats() {
            const cats = ['Barchasi', ...new Set(products.map(p => p.cat))];
            document.getElementById('catNav').innerHTML = cats.map(c => 
                `<button class="cat-btn ${currentCat===c?'active':''}" onclick="filterCat('${c}')">${c}</button>`).join('');
        }

        function renderMenu() {
            const filtered = currentCat === 'Barchasi' ? products : products.filter(p => p.cat === currentCat);
            document.getElementById('menuDisplay').innerHTML = filtered.map(p => `
                <div class="card">
                    <span class="fav-heart ${favorites.includes(p.id)?'active':''}" onclick="toggleFav(${p.id}, this)">‚ù§</span>
                    <img src="${p.img}" onclick="openProduct(${p.id})">
                    <div class="card-info">
                        <h4 onclick="openProduct(${p.id})">${p.name}</h4>
                        <b>${p.price.toLocaleString()} so'm</b>
                        <div class="counter-box">
                            <button class="c-btn" onclick="updateQty(${p.id},-1)">-</button>
                            <span id="qty-${p.id}">${cart[p.id]||0}</span>
                            <button class="c-btn" onclick="updateQty(${p.id},1)">+</button>
                        </div>
                    </div>
                </div>`).join('');
        }

        function openProduct(id) {
            const p = products.find(x => x.id === id);
            document.getElementById('pm-img').src = p.img;
            document.getElementById('pm-title').innerText = p.name;
            document.getElementById('pm-desc').innerText = p.desc;
            document.getElementById('pm-price').innerText = p.price.toLocaleString() + " so'm";
            document.getElementById('pm-counter').innerHTML = `
                <div style="display:flex; justify-content:center; gap:20px; align-items:center;">
                    <button class="c-btn" onclick="updateQty(${p.id},-1)">-</button>
                    <span id="mqty-${p.id}" style="font-size:20px; font-weight:bold;">${cart[id]||0}</span>
                    <button class="c-btn" onclick="updateQty(${p.id},1)">+</button>
                </div>`;
            document.getElementById('productModal').style.display = 'flex';
        }

        function closeProduct() { document.getElementById('productModal').style.display = 'none'; }

        function updateQty(id, ch) {
            cart[id] = (cart[id] || 0) + ch;
            if (cart[id] <= 0) delete cart[id];
            document.querySelectorAll(`#qty-${id}, #mqty-${id}`).forEach(el => el.innerText = cart[id] || 0);
            renderCart();
        }

        function renderCart() {
            let total = 0, html = "";
            for (let id in cart) {
                const p = products.find(x => x.id == id);
                total += p.price * cart[id];
                html += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>${p.name} x${cart[id]}</span>
                    <span>${(p.price*cart[id]).toLocaleString()} so'm</span>
                </div>`;
            }
            document.getElementById('cartItems').innerHTML = html || "Savat bo'sh";
            document.getElementById('totalPrice').innerText = total.toLocaleString() + " so'm";
        }

        function sendOrder() {
            if (!Object.keys(cart).length) return showToast("Savat bo'sh!");
            if (!userLoc) return showToast("Lokatsiya aniqlanmadi!");

            const btn = document.getElementById('orderBtn');
            btn.innerText = "Yuborilmoqda...";
            btn.disabled = true;

            const orderId = Math.floor(1000 + Math.random() * 9000);
            let items = "";
            for (let id in cart) items += `‚Ä¢ ${products.find(x=>x.id==id).name} (x${cart[id]})\n`;

            const text = `üÜï BUYURTMA #${orderId}\nüë§ ${localStorage.getItem('u_name')}\nüìû ${localStorage.getItem('u_phone')}\n\n${items}\nüìç Lokatsiya: https://www.google.com/maps?q=${userLoc}`;

            const kb = { inline_keyboard: [
                [{text: "‚úÖ Qabul qilish", callback_data: `ok_${orderId}`}],
                [{text: "üöö Yetkazish", callback_data: `go_${orderId}`}]
            ]};

            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chat_id: CHAT_ID, text: text, reply_markup: kb })
            }).then(() => {
                showToast("Buyurtma yuborildi! ‚úÖ");
                history.unshift({id: orderId, items: items, status: 'Kutilmoqda'});
                localStorage.setItem('u_history', JSON.stringify(history));
                cart = {}; renderCart(); renderMenu(); renderHistory();
                showPage('history');
                btn.innerText = "BUYURTMA BERISH"; btn.disabled = false;
            });
        }

        function showPage(pId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pId).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }
        }

        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function updateProfileUI() {
            document.getElementById('pName').innerText = localStorage.getItem('u_name');
            document.getElementById('pPhone').innerText = localStorage.getItem('u_phone');
        }

        function filterCat(c) { currentCat = c; renderCats(); renderMenu(); }

        function getLocation() {
            navigator.geolocation.getCurrentPosition(p => {
                userLoc = `${p.coords.latitude},${p.coords.longitude}`;
                document.getElementById('locBtn').innerText = "‚úÖ MANZIL ANIQLANDI";
                document.getElementById('locBtn').style.background = "#d4edda";
            });
        }

        function toggleFav(id, el) {
            if(favorites.includes(id)) {
                favorites = favorites.filter(f => f !== id); el.classList.remove('active');
            } else {
                favorites.push(id); el.classList.add('active');
            }
            localStorage.setItem('u_favs', JSON.stringify(favorites));
        }

        function renderHistory() {
            document.getElementById('orderHistory').innerHTML = history.map(h => `
                <div style="background:white; padding:15px; border-radius:15px; margin-bottom:10px; border-left:5px solid var(--blue);">
                    <b>#${h.id}</b><br><small>${h.items}</small><br><b>Holat: ${h.status}</b>
                </div>`).join('');
        }
    </script>
</body>
</html>
