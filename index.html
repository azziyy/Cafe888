<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cafe 777 | Premium Menu</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary: #ff7f50;
            --accent: #ff4757;
            --bg: #f8f9fa;
            --white: #ffffff;
            --text: #2d3436;
            --glass: rgba(255, 255, 255, 0.8);
            --radius: 24px;
            --shadow: 0 10px 40px rgba(0,0,0,0.06);
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color:transparent; }
        body { background: var(--bg); color: var(--text); overflow-x: hidden; }

        /* Yuklanish ekrani */
        #splash { position:fixed; inset:0; background:var(--white); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.6s; }
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: var(--primary); border-radius: 50%; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg) } 100% { transform: rotate(360deg) } }

        /* Header dizayni */
        header { position:sticky; top:0; background:var(--glass); backdrop-filter:blur(20px); padding:15px 20px; display:flex; justify-content:space-between; align-items:center; z-index:1000; box-shadow: 0 2px 15px rgba(0,0,0,0.04); border-bottom: 1px solid rgba(255,255,255,0.3); }
        .logo { font-size:24px; font-weight:900; letter-spacing:-1px; }
        .logo span { color:var(--primary); }

        /* Kategoriyalar */
        .cats { display:flex; overflow-x:auto; padding:15px 20px; gap:12px; scrollbar-width:none; }
        .cats::-webkit-scrollbar { display:none; }
        .chip { padding:12px 24px; background:var(--white); border-radius:30px; font-size:14px; font-weight:700; white-space:nowrap; box-shadow: var(--shadow); transition:0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid transparent; }
        .chip.active { background:var(--primary); color:white; transform: scale(1.05); }

        /* Menyu Grid */
        .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; padding:0 16px 120px 16px; }
        .card { background:var(--white); border-radius:var(--radius); overflow:hidden; box-shadow: var(--shadow); transition: 0.3s; position: relative; border: 1px solid rgba(0,0,0,0.02); }
        .card:active { transform: scale(0.96); }
        .card img { width:100%; height:140px; object-fit:cover; background:#f1f1f1; transition: 0.5s; }
        .card-info { padding:14px; }
        .card-info h4 { font-size:15px; margin-bottom:4px; font-weight:800; color:#1e272e; }
        .card-info p { font-size:11px; color:#7f8c8d; height:32px; overflow:hidden; line-height:1.4; }
        .card-price-row { display:flex; justify-content:space-between; align-items:center; margin-top:12px; }
        .price { color:var(--primary); font-weight:900; font-size:15px; }

        /* Tugmalar */
        .add-btn { background:var(--primary); color:white; border:none; width:36px; height:36px; border-radius:12px; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .qty-box { display:flex; align-items:center; gap:10px; background:#f1f2f6; border-radius:12px; padding:4px 8px; }
        .qty-box button { background:none; border:none; font-size:18px; font-weight:bold; width:24px; color:var(--primary); }
        .qty-box span { font-weight:800; font-size:14px; min-width:15px; text-align:center; }

        /* Bottom Toolbar */
        .toolbar { position:fixed; bottom:20px; left:20px; right:20px; height:70px; background:rgba(45, 52, 54, 0.95); backdrop-filter:blur(10px); border-radius:25px; display:flex; justify-content:space-around; align-items:center; z-index:1001; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .tool-item { display:flex; flex-direction:column; align-items:center; color:#dfe6e9; font-size:10px; gap:4px; text-decoration:none; position:relative; width:60px; }
        .tool-item.active { color:var(--primary); }
        .tool-item i { font-size:22px; }
        .badge { position:absolute; top:-8px; right:8px; background:var(--accent); color:white; width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:bold; border:2px solid #2d3436; }

        /* Sahifalar */
        .page { display:none; min-height:100vh; animation: fadeIn 0.4s ease; }
        .page.active { display:block; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

        /* Tarix kartochkalari */
        .h-card { background:var(--white); margin:12px 16px; padding:18px; border-radius:20px; box-shadow: var(--shadow); border-left: 8px solid #dfe6e9; }
        .st-1 { border-left-color: #f1c40f; } /* Kutilmoqda */
        .st-2 { border-left-color: #3498db; } /* Tayyorlanmoqda */
        .st-3 { border-left-color: #e67e22; } /* Yo'lda */
        .st-4 { border-left-color: #2ecc71; } /* Yetkazildi */

        /* Buyurtma Berish Section */
        .cart-footer { position:fixed; bottom:100px; left:16px; right:16px; background:var(--white); padding:20px; border-radius:24px; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); }
        .btn-order { width:100%; padding:16px; border:none; background:var(--primary); color:white; border-radius:18px; font-weight:800; font-size:16px; margin-top:15px; box-shadow: 0 8px 20px rgba(255, 127, 80, 0.3); }
    </style>
</head>
<body>

    <div id="splash">
        <span class="loader"></span>
        <h2 style="margin-top:20px; font-weight:900; letter-spacing:2px">CAFE <span style="color:var(--primary)">777</span></h2>
    </div>

    <header>
        <div class="logo">CAFE <span>777</span></div>
        <div id="userName" style="font-weight:800; color:var(--primary)">Premium</div>
    </header>

    <main id="app">
        <section id="menu-p" class="page active">
            <div class="cats" id="catNav"></div>
            <div class="grid" id="menuItems"></div>
        </section>

        <section id="cart-p" class="page">
            <div style="padding:20px">
                <h2 style="font-weight:900; margin-bottom:20px">Savatchangiz üõí</h2>
                <div id="cartList"></div>
                <div style="height:250px"></div> <div class="cart-footer" id="cartFooter">
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <span style="font-weight:700; color:#636e72">Jami summa:</span>
                        <b id="totalPrice" style="font-size:22px; color:var(--primary)">0 so'm</b>
                    </div>
                    <button onclick="getLocation()" id="locBtn" style="width:100%; padding:12px; border:2px dashed var(--primary); background:none; color:var(--primary); border-radius:15px; margin-top:15px; font-weight:700">üìç Manzilni aniqlash</button>
                    <button onclick="sendOrder()" class="btn-order">BUYURTMANI YUBORISH</button>
                </div>
            </div>
        </section>

        <section id="history-p" class="page">
            <div style="padding:20px"><h2 style="font-weight:900">Buyurtmalar Tarixi üìú</h2></div>
            <div id="historyList"></div>
        </section>
    </main>

    <nav class="toolbar">
        <div class="tool-item active" onclick="changePage('menu', this)"><i class="fa-solid fa-utensils"></i><span>Menyu</span></div>
        <div class="tool-item" onclick="changePage('cart', this)"><i class="fa-solid fa-bag-shopping"></i><span id="badge" class="badge" style="display:none">0</span><span>Savat</span></div>
        <div class="tool-item" onclick="changePage('history', this)"><i class="fa-solid fa-clock-rotate-left"></i><span>Tarix</span></div>
    </nav>

    <script>
        // SOZLAMALAR
        const CONFIG = {
            MENU_SHEET: "https://docs.google.com/spreadsheets/d/1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk/gviz/tq?tqx=out:json",
            SCRIPT: "https://script.google.com/macros/s/AKfycbyczPTwYHrR8RkuMpFuuHwc-lrj57OTFXykW4oGkoZdxGqcKOCSxQYKd6pTegz53uSBjg/exec"
        };

        let products = [], cart = {}, userCoords = null;

        // Ilovani ishga tushirish
        async function init() {
            try {
                const res = await fetch(CONFIG.MENU_SHEET);
                const text = await res.text();
                const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
                
                products = json.table.rows
                    .filter(r => r.c && r.c[2] && r.c[2].v)
                    .map((r, i) => ({
                        id: i + 1,
                        cat: r.c[1]?.v || 'Boshqa',
                        name: r.c[2].v,
                        price: r.c[3]?.v || 0,
                        img: r.c[4]?.v || 'https://via.placeholder.com/300x200?text=777+Cafe',
                        desc: r.c[5]?.v || ''
                    }));

                renderCats();
                renderMenu('Barchasi');
                loadUserData();
            } catch (e) {
                Swal.fire('Xato', 'Ma\'lumot yuklashda xatolik!', 'error');
            } finally {
                setTimeout(() => {
                    document.getElementById('splash').style.opacity = '0';
                    setTimeout(() => document.getElementById('splash').remove(), 600);
                }, 1000);
            }
        }

        function renderCats() {
            const cats = ['Barchasi', ...new Set(products.map(p => p.cat))];
            const nav = document.getElementById('catNav');
            nav.innerHTML = cats.map(c => `<div class="chip" onclick="filterMenu('${c}', this)">${c}</div>`).join('');
            nav.querySelector('.chip').classList.add('active');
        }

        function filterMenu(cat, el) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderMenu(cat);
        }

        function renderMenu(cat) {
            const container = document.getElementById('menuItems');
            const filtered = cat === 'Barchasi' ? products : products.filter(p => p.cat === cat);
            
            container.innerHTML = filtered.map(p => `
                <div class="card">
                    <img src="${p.img}" loading="lazy" onclick="zoomImg('${p.img}')">
                    <div class="card-info">
                        <h4>${p.name}</h4>
                        <p>${p.desc}</p>
                        <div class="card-price-row">
                            <b class="price">${p.price.toLocaleString()} so'm</b>
                            <div id="btn-container-${p.id}">${btnLogic(p.id)}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function btnLogic(id) {
            const q = cart[id] || 0;
            return q > 0 ? `
                <div class="qty-box">
                    <button onclick="updateQty(${id}, -1)">-</button>
                    <span>${q}</span>
                    <button onclick="updateQty(${id}, 1)">+</button>
                </div>` : 
                `<button class="add-btn" onclick="updateQty(${id}, 1)"><i class="fa fa-plus"></i></button>`;
        }

        function updateQty(id, delta) {
            cart[id] = (cart[id] || 0) + delta;
            if(cart[id] <= 0) delete cart[id];
            
            const btnBox = document.getElementById(`btn-container-${id}`);
            if(btnBox) btnBox.innerHTML = btnLogic(id);
            
            updateBadge();
            if(document.getElementById('cart-p').classList.contains('active')) renderCart();
        }

        function updateBadge() {
            const count = Object.values(cart).reduce((a, b) => a + b, 0);
            const badge = document.getElementById('badge');
            badge.innerText = count;
            badge.style.display = count > 0 ? 'flex' : 'none';
        }

        function renderCart() {
            const list = document.getElementById('cartList');
            let total = 0, html = "";
            
            for(let id in cart) {
                const p = products.find(x => x.id == id);
                total += p.price * cart[id];
                html += `
                <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:15px; border-radius:18px; margin-bottom:12px; box-shadow:var(--shadow)">
                    <div style="display:flex; align-items:center; gap:12px">
                        <img src="${p.img}" style="width:50px; height:50px; border-radius:10px; object-fit:cover">
                        <div>
                            <b style="font-size:14px">${p.name}</b><br>
                            <small style="color:var(--primary)">${p.price.toLocaleString()} x ${cart[id]}</small>
                        </div>
                    </div>
                    <div class="qty-box">
                        <button onclick="updateQty(${id}, -1)">-</button>
                        <span>${cart[id]}</span>
                        <button onclick="updateQty(${id}, 1)">+</button>
                    </div>
                </div>`;
            }
            
            list.innerHTML = html || `<div style="text-align:center; padding:50px; color:#b2bec3"><i class="fa-solid fa-basket-shopping fa-3x"></i><p style="margin-top:15px">Savat bo'sh</p></div>`;
            document.getElementById('totalPrice').innerText = total.toLocaleString() + " so'm";
            document.getElementById('cartFooter').style.display = total > 0 ? 'block' : 'none';
        }

        async function sendOrder() {
            const user = JSON.parse(localStorage.getItem('c777_user'));
            if(!user) {
                const { value: formValues } = await Swal.fire({
                    title: 'Ma\'lumotlaringiz',
                    html: '<input id="swal-n" class="swal2-input" placeholder="Ismingiz">' +
                          '<input id="swal-p" class="swal2-input" placeholder="Telefoningiz" value="+998">',
                    focusConfirm: false,
                    preConfirm: () => [document.getElementById('swal-n').value, document.getElementById('swal-p').value]
                });
                if(!formValues || !formValues[0]) return;
                localStorage.setItem('c777_user', JSON.stringify({name: formValues[0], phone: formValues[1]}));
                loadUserData();
            }

            if(!userCoords) return Swal.fire('Manzil', 'Iltimos, manzilni aniqlang!', 'warning');

            Swal.fire({ title: 'Yuborilmoqda...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const u = JSON.parse(localStorage.getItem('c777_user'));
            const orderId = Date.now();
            let items = "", total = 0;
            
            for(let id in cart) {
                const p = products.find(x => x.id == id);
                items += `${p.name} (${cart[id]}x), `;
                total += p.price * cart[id];
            }

            try {
                const url = `${CONFIG.SCRIPT}?action=add&id=${orderId}&name=${encodeURIComponent(u.name)}&phone=${u.phone}&items=${encodeURIComponent(items)}&total=${total}&lat=${userCoords.latitude}&lng=${userCoords.longitude}`;
                await fetch(url, { mode: 'no-cors' });

                let history = JSON.parse(localStorage.getItem('c777_history') || "[]");
                history.unshift({id: orderId, items, total, status: 1});
                localStorage.setItem('c777_history', JSON.stringify(history));

                cart = {};
                updateBadge();
                Swal.fire('Tayyor!', 'Buyurtmangiz qabul qilindi!', 'success');
                changePage('history', document.querySelectorAll('.tool-item')[2]);
            } catch (e) {
                Swal.fire('Xato', 'Buyurtma yuborishda xatolik!', 'error');
            }
        }

        async function loadHistory() {
            const container = document.getElementById('historyList');
            const history = JSON.parse(localStorage.getItem('c777_history') || "[]");
            if(!history.length) { container.innerHTML = '<p style="text-align:center; padding:50px">Tarix bo\'sh</p>'; return; }

            const statusNames = ["", "Kutilmoqda ‚è≥", "Tayyorlanmoqda üë®‚Äçüç≥", "Yo'lda üö¥", "Yetkazildi ‚úÖ"];
            let html = "";
            
            for(let o of history) {
                if(o.status < 4) {
                    try {
                        const r = await fetch(`${CONFIG.SCRIPT}?orderId=${o.id}`);
                        const d = await r.json();
                        if(d.status) o.status = parseInt(d.status);
                    } catch(e){}
                }
                html += `
                <div class="h-card st-${o.status}">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px">
                        <span style="font-size:12px; color:#b2bec3">#${o.id.toString().slice(-6)}</span>
                        <b style="font-size:13px">${statusNames[o.status]}</b>
                    </div>
                    <div style="font-weight:700; margin-bottom:8px">${o.items}</div>
                    <div style="color:var(--primary); font-weight:900">${o.total.toLocaleString()} so'm</div>
                </div>`;
            }
            container.innerHTML = html;
            localStorage.setItem('c777_history', JSON.stringify(history));
        }

        function getLocation() {
            const btn = document.getElementById('locBtn');
            btn.innerText = "Aniqlanmoqda...";
            navigator.geolocation.getCurrentPosition(p => {
                userCoords = p.coords;
                btn.innerHTML = "‚úÖ Manzil aniqlandi";
                btn.style.borderColor = "#2ecc71";
                btn.style.color = "#2ecc71";
            }, () => {
                Swal.fire('GPS', 'Joylashuvni aniqlashga ruxsat bering!', 'error');
                btn.innerText = "üìç Manzilni aniqlash";
            });
        }

        function changePage(p, el) {
            document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
            document.getElementById(p + '-p').classList.add('active');
            document.querySelectorAll('.tool-item').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            if(p === 'cart') renderCart();
            if(p === 'history') loadHistory();
            window.scrollTo(0,0);
        }

        function zoomImg(src) {
            Swal.fire({ imageUrl: src, imageAlt: 'Taom', showConfirmButton: false, background: 'transparent' });
        }

        function loadUserData() {
            const u = JSON.parse(localStorage.getItem('c777_user'));
            if(u) document.getElementById('userName').innerText = u.name;
        }

        window.onload = init;
    </script>
</body>
</html>
