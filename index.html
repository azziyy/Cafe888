<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cafe 777 - Premium System</title>
    <style>
        :root {
            --primary: #ffbe0b; --secondary: #fb5607; --dark: #1a1a1a;
            --blue: #0088cc; --green: #2ecc71; --red: #ff4757; --gray: #f8f9fa;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--gray);
            margin: 0; padding: 0; overflow-x: hidden; padding-bottom: 80px;
        }

        /* 1. NAVBAR & NAVIGATION */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 12px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 1000;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
        }
        .nav-item { 
            text-align: center; font-size: 11px; color: #888; cursor: pointer;
            transition: 0.3s; flex: 1;
        }
        .nav-item.active { color: var(--secondary); transform: translateY(-5px); }
        .nav-item i { font-size: 22px; display: block; margin-bottom: 4px; }

        /* 2. PAGES CONTROL */
        .page { display: none; animation: fadeIn 0.4s ease; padding: 15px; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 3. CATEGORIES & CARDS */
        .category-nav {
            display: flex; gap: 10px; overflow-x: auto; padding: 10px 0;
            position: sticky; top: 0; background: var(--gray); z-index: 90;
        }
        .category-nav::-webkit-scrollbar { display: none; }
        .cat-btn {
            padding: 8px 18px; border-radius: 25px; border: none;
            background: white; font-weight: 600; white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .cat-btn.active { background: var(--primary); color: white; }

        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .card { 
            background: white; border-radius: 20px; overflow: hidden; position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s;
        }
        .card:active { transform: scale(0.96); }
        .fav-heart {
            position: absolute; top: 10px; right: 10px; font-size: 20px;
            color: #ddd; cursor: pointer; z-index: 10; transition: 0.3s;
            text-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .fav-heart.active { color: var(--red); transform: scale(1.2); }

        .card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
        .card-info { padding: 12px; text-align: center; }
        .card h4 { margin: 5px 0; font-size: 14px; height: 38px; overflow: hidden; }
        .card b { color: var(--secondary); display: block; margin-bottom: 10px; }

        /* 4. BUTTONS & UI */
        .btn-main {
            background: var(--dark); color: white; border: none; width: 100%;
            padding: 15px; border-radius: 15px; font-weight: bold; margin: 5px 0;
        }
        .counter-box { display: flex; align-items: center; justify-content: center; gap: 12px; }
        .c-btn { width: 32px; height: 32px; border-radius: 10px; border: none; background: #eee; font-weight: bold; }

        /* 5. HISTORY & STATUS */
        .history-card {
            background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px;
            border-left: 5px solid var(--blue);
        }
        .status-badge {
            padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: bold;
            float: right; text-transform: uppercase;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-accepted { background: #d4edda; color: #155724; }
        .status-cooking { background: #cce5ff; color: #004085; }
        .status-shipping { background: #f8d7da; color: #721c24; }

        /* 6. FULL SCREEN MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000; display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-body { background: white; width: 90%; max-width: 400px; border-radius: 25px; padding: 20px; position: relative; }

        /* TOAST ANIMATION */
        #toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: var(--dark); color: white; padding: 12px 25px;
            border-radius: 50px; z-index: 10000; transition: 0.5s; font-weight: 500;
        }
        #toast.show { top: 20px; }
    </style>
</head>
<body>

    <div id="toast">Xabar yuborildi!</div>

    <div id="page-home" class="page active">
        <h2 style="margin: 0 0 10px 0;">Menu üçî</h2>
        <div class="category-nav" id="catNav"></div>
        <div class="menu-grid" id="menuDisplay"></div>
    </div>

    <div id="page-favs" class="page">
        <h2>Sevimlilar ‚ù§Ô∏è</h2>
        <div id="favList" class="menu-grid"></div>
        <div id="favEmpty" style="text-align: center; margin-top: 50px; color: #999;">
            <p style="font-size: 50px;">üíî</p>
            <p>Hech narsa yo'q</p>
        </div>
    </div>

    <div id="page-cart" class="page">
        <h2>Savat üõí</h2>
        <div id="cartItems" style="background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px;"></div>
        <div style="font-size: 20px; font-weight: bold; margin-bottom: 20px;">
            Jami: <span id="totalPrice" style="color: var(--secondary);">0 so'm</span>
        </div>
        <button class="btn-main" id="locBtn" onclick="getLocation()" style="background: #eef1f6; color: #333;">üìç MANZILNI ANQLASH</button>
        <button class="btn-main" onclick="sendOrder()" style="background: var(--blue);">BUYURTMA BERISH</button>
    </div>

    <div id="page-history" class="page">
        <h2>Tarix üìú</h2>
        <div id="orderHistory"></div>
    </div>

    <div id="page-profile" class="page">
        <h2>Profil üë§</h2>
        <div style="background: white; padding: 20px; border-radius: 20px;">
            <p><b>Ism:</b> <span id="pName"></span></p>
            <p><b>Tel:</b> <span id="pPhone"></span></p>
            <button class="btn-main" onclick="openRegModal()" style="background: #eee; color: #333;">O'ZGARTIRISH</button>
        </div>
        <h3 style="margin-top: 25px;">Adminga yozish ‚úçÔ∏è</h3>
        <textarea id="adminMsg" placeholder="Xabaringizni yozing..." style="width:100%; height:100px; border-radius:15px; padding:10px; border:1px solid #ddd;"></textarea>
        <button class="btn-main" onclick="contactAdmin()" style="background: var(--dark);">XABARNI YUBORISH</button>
    </div>

    <div id="regModal" class="modal-overlay" style="display: flex;">
        <div class="modal-body">
            <h3>Ro'yxatdan o'tish</h3>
            <input type="text" id="regName" placeholder="Ismingiz" style="width:100%; padding:12px; margin:10px 0; border-radius:10px; border:1px solid #ddd;">
            <input type="tel" id="regPhone" value="+998 " style="width:100%; padding:12px; margin:10px 0; border-radius:10px; border:1px solid #ddd;">
            <button class="btn-main" onclick="saveReg()">SAQLASH</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="showPage('home', this)"><i>üè†</i>Asosiy</div>
        <div class="nav-item" onclick="showPage('favs', this)"><i>‚ù§Ô∏è</i>Sevimlilar</div>
        <div class="nav-item" onclick="showPage('cart', this)"><i>üõí</i>Savat</div>
        <div class="nav-item" onclick="showPage('history', this)"><i>üìú</i>Tarix</div>
        <div class="nav-item" onclick="showPage('profile', this)"><i>üë§</i>Profil</div>
    </div>

    <script>
        const BOT_TOKEN = "8032226679:AAETTGPvYZYSvF_QmdofXKibpOwt4E9Iitc";
        const CHAT_ID = "519326806";
        const SHEET_ID = "1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk";

        let products = [], cart = {}, favorites = [], history = [], userLoc = null, currentCat = 'Barchasi';

        // 1. STARTUP
        window.onload = () => {
            const savedName = localStorage.getItem('u_name');
            if(savedName) {
                document.getElementById('regModal').style.display = 'none';
                document.getElementById('pName').innerText = savedName;
                document.getElementById('pPhone').innerText = localStorage.getItem('u_phone');
            }
            favorites = JSON.parse(localStorage.getItem('u_favs') || '[]');
            history = JSON.parse(localStorage.getItem('u_history') || '[]');
            loadData();
            renderHistory();
        };

        // 2. DATA LOADING
        async function loadData() {
            try {
                const r = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`);
                const t = await r.text();
                const j = JSON.parse(t.substr(47).slice(0, -2));
                products = j.table.rows.map((r, i) => ({
                    id: i+1, cat: r.c[1]?.v || 'Boshqa', name: r.c[2]?.v || 'Nomsiz', 
                    price: r.c[3]?.v || 0, img: r.c[4]?.v || '', desc: r.c[5]?.v || ''
                }));
                renderCategories(); renderMenu();
            } catch (e) { showToast("Internet xatosi! üåê"); }
        }

        function renderCategories() {
            const cats = ['Barchasi', ...new Set(products.map(p => p.cat))];
            document.getElementById('catNav').innerHTML = cats.map(c => 
                `<button class="cat-btn ${currentCat===c?'active':''}" onclick="filterCat('${c}')">${c}</button>`).join('');
        }

        function renderMenu() {
            const filtered = currentCat === 'Barchasi' ? products : products.filter(p => p.cat === currentCat);
            document.getElementById('menuDisplay').innerHTML = filtered.map(p => createCard(p)).join('');
        }

        function createCard(p) {
            const isFav = favorites.includes(p.id);
            return `
                <div class="card">
                    <span class="fav-heart ${isFav?'active':''}" onclick="toggleFav(${p.id}, this)">‚ù§</span>
                    <img src="${p.img}">
                    <div class="card-info">
                        <h4>${p.name}</h4><b>${p.price.toLocaleString()} so'm</b>
                        <div class="counter-box">
                            <button class="c-btn" onclick="updateQty(${p.id},-1)">-</button>
                            <span id="qty-${p.id}">${cart[p.id]||0}</span>
                            <button class="c-btn" onclick="updateQty(${p.id},1)">+</button>
                        </div>
                    </div>
                </div>`;
        }

        // 3. CORE FUNCTIONS
        function toggleFav(id, el) {
            if(favorites.includes(id)) {
                favorites = favorites.filter(f => f !== id);
                el.classList.remove('active');
            } else {
                favorites.push(id);
                el.classList.add('active');
            }
            localStorage.setItem('u_favs', JSON.stringify(favorites));
            renderFavs();
        }

        function renderFavs() {
            const list = products.filter(p => favorites.includes(p.id));
            document.getElementById('favEmpty').style.display = list.length ? 'none' : 'block';
            document.getElementById('favList').innerHTML = list.map(p => createCard(p)).join('');
        }

        function updateQty(id, change) {
            cart[id] = (cart[id] || 0) + change;
            if(cart[id] <= 0) delete cart[id];
            
            // UI Update
            const els = document.querySelectorAll(`#qty-${id}`);
            els.forEach(e => e.innerText = cart[id] || 0);
            renderCart();
        }

        function renderCart() {
            let total = 0, html = "";
            for(let id in cart) {
                const p = products.find(x => x.id == id);
                total += p.price * cart[id];
                html += `<div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                    <span>${p.name} x${cart[id]}</span>
                    <b>${(p.price*cart[id]).toLocaleString()}</b>
                </div>`;
            }
            document.getElementById('cartItems').innerHTML = html || "Savat bo'sh üõí";
            document.getElementById('totalPrice').innerText = total.toLocaleString() + " so'm";
        }

        function getLocation() {
            const btn = document.getElementById('locBtn');
            btn.innerText = "Aniqlanmoqda...";
            navigator.geolocation.getCurrentPosition(p => {
                userLoc = `${p.coords.latitude},${p.coords.longitude}`;
                btn.innerText = "‚úÖ MANZIL ANIQLANDI";
                btn.style.background = "#d4edda";
            }, () => {
                showToast("GPSni yoqing! üìç");
                btn.innerText = "üìç MANZILNI ANIQLASH";
            });
        }

        // 4. ORDER & BOT (WEBHOOK SIMULATION VIA INLINE BUTTONS)
        async function sendOrder() {
            if(!Object.keys(cart).length) return showToast("Savat bo'sh! üõí");
            if(!userLoc) return showToast("Manzilni aniqlang! üìç");

            const orderId = Date.now().toString().slice(-6);
            let itemsText = "";
            for(let id in cart) itemsText += `- ${products.find(x=>x.id==id).name} (${cart[id]} dona)\n`;

            const msg = `üÜï BUYURTMA #${orderId}\nüë§ ${localStorage.getItem('u_name')}\nüìû ${localStorage.getItem('u_phone')}\n\n${itemsText}\nüí∞ Jami: ${document.getElementById('totalPrice').innerText}\nüìç Lokatsiya: https://www.google.com/maps?q=${userLoc}`;

            // Admin Bot Keyboard (Bu qism Telegram Bot API orqali tugmalar chiqaradi)
            const keyboard = {
                inline_keyboard: [
                    [{text: "‚úÖ Qabul qilish", callback_data: `st_accepted_${orderId}`}],
                    [{text: "üë®‚Äçüç≥ Tayyorlanmoqda", callback_data: `st_cooking_${orderId}`}],
                    [{text: "üöö Yetkazilmoqda", callback_data: `st_shipping_${orderId}`}]
                ]
            };

            try {
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_id: CHAT_ID, text: msg, reply_markup: keyboard })
                });

                // Save to history
                history.unshift({ id: orderId, time: new Date().toLocaleTimeString(), items: itemsText, status: 'pending' });
                localStorage.setItem('u_history', JSON.stringify(history));
                
                showToast("Buyurtma yuborildi! üöÄ");
                cart = {}; renderCart(); renderMenu(); renderHistory();
                showPage('history');
            } catch (e) { showToast("Xatolik! ‚ùå"); }
        }

        function renderHistory() {
            document.getElementById('orderHistory').innerHTML = history.map(h => `
                <div class="history-card">
                    <span class="status-badge status-${h.status}">${h.status === 'pending' ? 'Kutilmoqda' : h.status}</span>
                    <small>${h.time}</small>
                    <div style="font-weight:bold; margin-top:5px;">ID: #${h.id}</div>
                    <div style="font-size:13px; color:#666; white-space:pre-line;">${h.items}</div>
                </div>
            `).join('');
        }

        async function contactAdmin() {
            const msg = document.getElementById('adminMsg').value;
            if(!msg) return showToast("Xabarni yozing!");
            const text = `üí¨ ADMINGA XABAR\nKimdan: ${localStorage.getItem('u_name')}\n\n${msg}`;
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chat_id: CHAT_ID, text: text })
            });
            showToast("Xabar yuborildi! ‚úÖ");
            document.getElementById('adminMsg').value = "";
        }

        // 5. UTILS
        function showPage(pageId, navEl) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            if(navEl) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                navEl.classList.add('active');
            }
            if(pageId === 'favs') renderFavs();
        }

        function filterCat(c) {
            currentCat = c;
            renderCategories(); renderMenu();
        }

        function saveReg() {
            const n = document.getElementById('regName').value;
            const p = document.getElementById('regPhone').value;
            if(n.length < 3 || p.length < 10) return showToast("Ma'lumotlar xato!");
            localStorage.setItem('u_name', n);
            localStorage.setItem('u_phone', p);
            document.getElementById('regModal').style.display = 'none';
            document.getElementById('pName').innerText = n;
            document.getElementById('pPhone').innerText = p;
            showToast("Xush kelibsiz! ‚ú®");
        }

        function openRegModal() { document.getElementById('regModal').style.display = 'flex'; }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
