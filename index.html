<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>777 Cafe Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --p: #ffbe0b; --s: #fb5607; --d: #1a1a1a; --g: #f8f9fa; --w: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--g); margin: 0; padding-bottom: 80px; transition: 0.3s; }
        
        /* Header */
        .header { background: var(--w); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .logo { font-weight: 900; font-size: 22px; color: var(--d); } .logo span { color: var(--p); }
        
        /* Menu Grid */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; }
        .card { background: var(--w); border-radius: 20px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.04); position: relative; }
        .card img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .card-body { padding: 12px; text-align: center; }
        .price { color: var(--s); font-weight: 800; font-size: 16px; margin: 5px 0; }
        .add-btn { background: var(--d); color: var(--w); border: none; padding: 8px 15px; border-radius: 12px; width: 100%; font-weight: 600; }

        /* Navigation Toolbar */
        .toolbar { position: fixed; bottom: 0; width: 100%; height: 75px; background: var(--w); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
        .t-item { display: flex; flex-direction: column; align-items: center; color: #b2bec3; font-size: 11px; font-weight: 700; cursor: pointer; text-decoration: none; }
        .t-item.active { color: var(--s); }
        .t-item i { font-size: 24px; margin-bottom: 4px; }
        
        .page { display: none; padding: 15px; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; background: var(--p); color: var(--w); }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo">CAFE <span>777</span></div>
        <div id="u-name" onclick="showP('profile')" style="font-weight: 700; color: var(--s);">Kirish</div>
    </header>

    <main>
        <section id="p-home" class="page active">
            <div id="cat-nav" style="display: flex; overflow-x: auto; padding-bottom: 10px; gap: 10px;"></div>
            <div id="product-list" class="grid"></div>
        </section>

        <section id="p-cart" class="page">
            <div style="background: var(--w); padding: 20px; border-radius: 25px;">
                <h3>Savatcha üõí</h3>
                <div id="cart-content"></div>
                <hr>
                <div style="display: flex; justify-content: space-between; font-size: 20px; font-weight: 900;">
                    <span>Jami:</span> <span id="total-val">0</span> so'm
                </div>
                <button onclick="getLoc()" id="loc-btn" style="width:100%; margin-top:20px; padding:15px; border-radius:15px; border:2px dashed #ccc; background:none; font-weight:bold;">üìç Manzilni aniqlash</button>
                <button onclick="send()" style="width:100%; margin-top:10px; padding:18px; border-radius:15px; border:none; background:var(--s); color:white; font-weight:900; font-size:16px;">BUYURTMA BERISH</button>
            </div>
        </section>

        <section id="p-history" class="page">
            <h3>Buyurtmalar tarixi üìú</h3>
            <div id="history-content"></div>
        </section>

        <section id="p-profile" class="page">
            <div style="background: var(--w); padding: 25px; border-radius: 25px; text-align: center;">
                <h3>Profil üë§</h3>
                <input type="text" id="in-name" placeholder="Ismingiz" style="width:100%; padding:15px; margin:10px 0; border-radius:12px; border:1px solid #eee;">
                <input type="tel" id="in-phone" value="+998" style="width:100%; padding:15px; margin:10px 0; border-radius:12px; border:1px solid #eee;">
                <button onclick="saveU()" style="width:100%; padding:15px; border-radius:12px; border:none; background:var(--p); color:white; font-weight:bold;">SAQLASH</button>
            </div>
        </section>
    </main>

    <nav class="toolbar">
        <div class="t-item active" onclick="showP('home', this)"><i class="fa fa-utensils"></i><span>Menyu</span></div>
        <div class="t-item" onclick="showP('cart', this)"><i class="fa fa-shopping-basket"></i><span>Savat</span></div>
        <div class="t-item" onclick="showP('history', this)"><i class="fa fa-history"></i><span>Tarix</span></div>
        <div class="t-item" onclick="showP('profile', this)"><i class="fa fa-user"></i><span>Profil</span></div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const SCRIPT = "https://script.google.com/macros/s/AKfycbwaCe2zkMZzXgTfadjKv-ZNLXo0vvEEO99XggnbWEPxDb-khrtRh1lGtzGSjzMjimvQmA/exec";
        const SHEET = "1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk";
        
        let products = [], cart = {}, user = JSON.parse(localStorage.getItem('user777')), loc = null;

        async function init() {
            const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET}/gviz/tq?tqx=out:json`);
            const text = await res.text();
            const json = JSON.parse(text.substring(47, text.length - 2));
            products = json.table.rows.map((r, i) => ({ id: i, cat: r.c[1]?.v, name: r.c[2].v, price: r.c[3].v, img: r.c[4].v }));
            renderMenu();
            if(user) document.getElementById('u-name').innerText = user.name;
        }

        function showP(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('p-' + id).classList.add('active');
            document.querySelectorAll('.t-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            if(id === 'cart') renderCart();
            if(id === 'history') loadHistory();
        }

        function renderMenu() {
            document.getElementById('product-list').innerHTML = products.map(p => `
                <div class="card">
                    <img src="${p.img}">
                    <div class="card-body">
                        <b>${p.name}</b>
                        <div class="price">${p.price.toLocaleString()} so'm</div>
                        <button class="add-btn" onclick="add(${p.id})">Savatga</button>
                    </div>
                </div>
            `).join('');
        }

        function add(id) {
            cart[id] = (cart[id] || 0) + 1;
            Swal.fire({ toast: true, position: 'top', icon: 'success', title: 'Savatga qo\'shildi', showConfirmButton: false, timer: 1000 });
        }

        function renderCart() {
            let h = "", tot = 0;
            for(let id in cart) {
                const p = products[id]; tot += p.price * cart[id];
                h += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>${p.name} (x${cart[id]})</span>
                    <b>${(p.price*cart[id]).toLocaleString()}</b>
                </div>`;
            }
            document.getElementById('cart-content').innerHTML = h || "Savat bo'sh";
            document.getElementById('total-val').innerText = tot.toLocaleString();
        }

        function getLoc() {
            navigator.geolocation.getCurrentPosition(p => {
                loc = { lat: p.coords.latitude, lng: p.coords.longitude };
                document.getElementById('loc-btn').innerText = "‚úÖ Manzil aniqlandi";
            }, () => Swal.fire('Xato', 'GPSni yoqing', 'error'));
        }

        async function send() {
            if(!user) return showP('profile');
            if(!loc) return Swal.fire('Manzil', 'Joylashuvni aniqlang', 'info');
            
            let items = ""; for(let id in cart) items += products[id].name + " (" + cart[id] + "x), ";
            const url = `${SCRIPT}?action=add&clientId=${user.phone}&name=${encodeURIComponent(user.name)}&phone=${user.phone}&items=${encodeURIComponent(items)}&total=${document.getElementById('total-val').innerText}&lat=${loc.lat}&lng=${loc.lng}`;
            
            Swal.fire({ title: 'Yuborilmoqda...', didOpen: () => Swal.showLoading() });
            await fetch(url, { mode: 'no-cors' });
            cart = {}; Swal.fire('Rahmat!', 'Buyurtmangiz qabul qilindi', 'success');
            showP('history');
        }

        async function loadHistory() {
            if(!user) return;
            const res = await fetch(`${SCRIPT}?action=getOrders&clientId=${user.phone}`);
            const data = await res.json();
            const statuslar = ["", "üÜï Yangi", "‚úÖ Qabul", "üë®‚Äçüç≥ Tayyor", "üö¥ Yo'lda", "üèÅ Yetkazildi"];
            document.getElementById('history-content').innerHTML = data.map(o => `
                <div style="background:white; padding:15px; border-radius:20px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between;">
                        <b>ID: ${o.orderId}</b>
                        <span class="status-badge">${statuslar[o.status] || o.status}</span>
                    </div>
                    <p style="font-size:13px; color:#666;">${o.items}</p>
                    <b>${o.total} so'm</b>
                </div>
            `).join('');
        }

        function saveU() {
            const n = document.getElementById('in-name').value, p = document.getElementById('in-phone').value;
            if(!n || p.length < 9) return Swal.fire('Xato', 'Ma\'lumotlarni to\'ldiring', 'error');
            user = { name: n, phone: p };
            localStorage.setItem('user777', JSON.stringify(user));
            document.getElementById('u-name').innerText = n;
            Swal.fire('Saqlandi', 'Profil yangilandi', 'success');
            showP('home');
        }

        init();
    </script>
</body>
</html>
