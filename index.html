<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cafe 777 - Premium System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #ffbe0b;
            --secondary: #fb5607;
            --accent: #3a86ff;
            --dark: #1a1a1a;
            --light: #f8f9fa;
            --white: #ffffff;
            --success: #06d6a0;
        }

        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--light); margin: 0; padding-bottom: 80px; color: var(--dark); overflow-x: hidden; }

        /* Animatsiyalar */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .page { display: none; padding: 20px; animation: fadeIn 0.4s ease-out; }
        .page.active { display: block; }

        /* Header va Kategoriyalar */
        .header { background: var(--white); padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 0 0 30px 30px; }
        .cat-container { display: flex; overflow-x: auto; padding: 10px 0; gap: 10px; scrollbar-width: none; }
        .cat-item { padding: 8px 18px; background: var(--white); border-radius: 20px; white-space: nowrap; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; transition: 0.3s; font-size: 14px; font-weight: 600; border: 1px solid #eee; }
        .cat-item.active { background: var(--secondary); color: white; border-color: var(--secondary); }

        /* Mahsulot kartochkasi */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: var(--white); border-radius: 20px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); position: relative; animation: scaleIn 0.3s ease; }
        .card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
        .fav-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.8); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; z-index: 5; }
        .fav-btn.active i { color: #ef476f; }
        .card-info { padding: 12px; }
        .card-price { color: var(--secondary); font-weight: 800; font-size: 15px; }

        /* Form elementlari */
        input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #ddd; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--accent); box-shadow: 0 0 8px rgba(58, 134, 255, 0.2); }
        .btn { border: none; padding: 15px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.3s; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: var(--dark); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }

        /* Navigatsiya paneli */
        .navbar { position: fixed; bottom: 0; width: 100%; background: var(--white); display: flex; padding: 12px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 1000; border-radius: 25px 25px 0 0; }
        .nav-item { flex: 1; text-align: center; font-size: 10px; color: #888; font-weight: bold; cursor: pointer; position: relative; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 4px; transition: 0.3s; }
        .nav-item.active { color: var(--secondary); }
        .nav-item.active i { transform: translateY(-5px); color: var(--secondary); }

        /* Toast va Qalqib chiquvchi oyna */
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--dark); color: white; padding: 12px 25px; border-radius: 30px; display: none; z-index: 2000; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        /* Tarix Kartasi */
        .history-item { background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid var(--accent); animation: fadeIn 0.3s ease; }
        .status-badge { background: #eef2f7; padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 800; color: var(--accent); }

    </style>
</head>
<body>

    <div id="toast"></div>

    <div id="p-reg" class="page active">
        <div style="text-align: center; margin-top: 50px;">
            <div style="font-size: 60px; animation: pulse 2s infinite;">üçï</div>
            <h2>Cafe 777</h2>
            <p>Xush kelibsiz! Ma'lumotlarni kiriting.</p>
        </div>
        <div style="max-width: 400px; margin: 0 auto; padding: 20px;">
            <label>Ismingiz</label>
            <input type="text" id="uName" placeholder="Masalan: Azizbek">
            <label>Telefon raqam</label>
            <input type="tel" id="uPhone" value="+998 " maxlength="17">
            <button class="btn btn-primary" onclick="handleAuth()">DAVOM ETISH <i class="fa-solid fa-arrow-right"></i></button>
        </div>
    </div>

    <div id="app" style="display: none;">
        <div class="header">
            <h3 style="margin: 0;">Cafe 777 Menu</h3>
            <div id="userBadge" style="font-size: 11px; color: #777; margin-top: 5px;"></div>
        </div>

        <div id="p-home" class="page">
            <div class="cat-container" id="catBox"></div>
            <div class="grid" id="menuGrid"></div>
        </div>

        <div id="p-cart" class="page">
            <h2>Savat üõí</h2>
            <div id="cartList"></div>
            <div style="display:flex; justify-content:space-between; margin: 20px 0; font-weight: 900; font-size: 20px;">
                <span>Jami:</span> <span id="cartTotal">0 so'm</span>
            </div>
            <button class="btn btn-secondary" onclick="askGeo()" id="locBtn" style="margin-bottom:10px;"><i class="fa-solid fa-location-dot"></i> MANZILNI ANIQALASH</button>
            <button class="btn btn-primary" onclick="makeOrder()"><i class="fa-solid fa-paper-plane"></i> BUYURTMA BERISH</button>
        </div>

        <div id="p-fav" class="page">
            <h2>Sevimlilar ‚ù§Ô∏è</h2>
            <div class="grid" id="favGrid"></div>
        </div>

        <div id="p-history" class="page">
            <h2>Tarix va Status üìú</h2>
            <div id="historyBox"></div>
        </div>

        <div id="p-settings" class="page">
            <h2>Profil va Aloqa ‚öôÔ∏è</h2>
            <div style="background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px;">
                <p><b>Ism:</b> <span id="set-name"></span></p>
                <p><b>ID:</b> <span id="set-id"></span></p>
                <button class="btn btn-secondary" onclick="localStorage.clear(); location.reload();" style="padding: 10px;">Chiqish</button>
            </div>
            <h3>Adminga yozish ‚úçÔ∏è</h3>
            <textarea id="adminMsg" style="width: 100%; height: 100px; border-radius: 15px; padding: 15px; border: 1px solid #ddd;"></textarea>
            <button class="btn btn-primary" style="margin-top:10px;" onclick="sendToAdmin()">XABARNI YUBORISH</button>
        </div>

        <nav class="navbar">
            <div class="nav-item active" onclick="go('home', this)"><i class="fa-solid fa-house"></i>Menyu</div>
            <div class="nav-item" onclick="go('fav', this)"><i class="fa-solid fa-heart"></i>Sevimlilar</div>
            <div class="nav-item" onclick="go('cart', this)"><i class="fa-solid fa-cart-shopping"></i>Savat</div>
            <div class="nav-item" onclick="go('history', this)"><i class="fa-solid fa-clock-rotate-left"></i>Tarix</div>
            <div class="nav-item" onclick="go('settings', this)"><i class="fa-solid fa-user-gear"></i>Admin</div>
        </nav>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzwNcXLilCiuKoZ6oOzwGrwX1eqMncEUVZHKcOZeHrmkXUt8uwRngtn-jWqCOTlkX2AYw/exec";
        const BOT_TOKEN = "8032226679:AAETTGPvYZYSvF_QmdofXKibpOwt4E9Iitc";
        const ADMIN_ID = "519326806";
        const PRODUCTS_SHEET_ID = "1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk";

        let state = {
            products: [],
            cart: {},
            favorites: JSON.parse(localStorage.getItem('cafe_favs') || '[]'),
            history: JSON.parse(localStorage.getItem('cafe_history') || '[]'),
            geo: null,
            activeCat: 'Hammasi'
        };

        // TELEFON RAQAM FORMATI
        document.getElementById('uPhone').addEventListener('input', e => {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,2})(\d{0,3})(\d{0,2})(\d{0,2})/);
            e.target.value = !x[2] ? "+998 " : "+998 " + x[2] + (x[3] ? " " + x[3] : "") + (x[4] ? " " + x[4] : "") + (x[5] ? " " + x[5] : "");
        });

        // AUTH & ID YARATISH
        function handleAuth() {
            let n = document.getElementById('uName').value.trim();
            let p = document.getElementById('uPhone').value.trim();
            if(n.length < 4 || p.length < 17) return showMsg("Ma'lumotlar xato!");
            
            let id = n.substring(0,4).toUpperCase() + p.replace(/\s/g,'').slice(-4);
            localStorage.setItem('cafe_user', JSON.stringify({id, name: n, phone: p}));
            location.reload();
        }

        window.onload = () => {
            let user = localStorage.getItem('cafe_user');
            if(user) {
                user = JSON.parse(user);
                document.getElementById('p-reg').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('userBadge').innerText = "Foydalanuvchi ID: " + user.id;
                document.getElementById('set-name').innerText = user.name;
                document.getElementById('set-id').innerText = user.id;
                loadProducts();
                setInterval(syncStatuses, 10000);
            }
        };

        async function loadProducts() {
            try {
                const r = await fetch(`https://docs.google.com/spreadsheets/d/${PRODUCTS_SHEET_ID}/gviz/tq?tqx=out:json`);
                const t = await r.text();
                const j = JSON.parse(t.substring(47).slice(0,-2));
                state.products = j.table.rows.map((row, i) => ({
                    id: i,
                    cat: row.c[1]?.v || "Boshqa",
                    name: row.c[2]?.v || "Nomsiz",
                    price: row.c[3]?.v || 0,
                    img: row.c[4]?.v || "https://via.placeholder.com/150"
                }));
                renderCategories();
                renderMenu();
            } catch(e) { showMsg("Xatolik yuz berdi!"); }
        }

        function renderCategories() {
            let cats = ['Hammasi', ...new Set(state.products.map(p => p.cat))];
            document.getElementById('catBox').innerHTML = cats.map(c => 
                `<div class="cat-item ${state.activeCat === c ? 'active' : ''}" onclick="filterCat('${c}')">${c}</div>`
            ).join('');
        }

        function filterCat(c) {
            state.activeCat = c;
            renderCategories();
            renderMenu();
        }

        function renderMenu() {
            let filtered = state.activeCat === 'Hammasi' ? state.products : state.products.filter(p => p.cat === state.activeCat);
            document.getElementById('menuGrid').innerHTML = filtered.map(p => `
                <div class="card">
                    <div class="fav-btn ${state.favorites.includes(p.id) ? 'active' : ''}" onclick="toggleFav(${p.id})">
                        <i class="fa-solid fa-heart"></i>
                    </div>
                    <img src="${p.img}" onclick="addToCart(${p.id})">
                    <div class="card-info">
                        <div style="font-size:13px; font-weight:700; height:34px; overflow:hidden;">${p.name}</div>
                        <div class="card-price">${p.price.toLocaleString()} so'm</div>
                    </div>
                </div>
            `).join('');
        }

        // SEVIMLILAR
        function toggleFav(id) {
            if(state.favorites.includes(id)) {
                state.favorites = state.favorites.filter(f => f !== id);
            } else {
                state.favorites.push(id);
                showMsg("Sevimlilarga qo'shildi ‚ù§Ô∏è");
            }
            localStorage.setItem('cafe_favs', JSON.stringify(state.favorites));
            renderMenu();
            renderFavs();
        }

        function renderFavs() {
            let favs = state.products.filter(p => state.favorites.includes(p.id));
            document.getElementById('favGrid').innerHTML = favs.map(p => `
                <div class="card">
                    <div class="fav-btn active" onclick="toggleFav(${p.id})"><i class="fa-solid fa-heart"></i></div>
                    <img src="${p.img}">
                    <div class="card-info">
                        <div>${p.name}</div>
                        <div class="card-price">${p.price.toLocaleString()} so'm</div>
                    </div>
                </div>
            `).join('');
        }

        // SAVAT
        function addToCart(id) {
            state.cart[id] = (state.cart[id] || 0) + 1;
            showMsg("Savatga qo'shildi! üõí");
            renderCart();
        }

        function renderCart() {
            let html = "", total = 0;
            for(let id in state.cart) {
                let p = state.products[id];
                let qty = state.cart[id];
                total += p.price * qty;
                html += `
                    <div style="display:flex; justify-content:space-between; background:white; padding:10px; border-radius:12px; margin-bottom:10px;">
                        <span>${p.name} (x${qty})</span>
                        <b>${(p.price * qty).toLocaleString()} so'm</b>
                    </div>
                `;
            }
            document.getElementById('cartList').innerHTML = html || "<p>Savat bo'sh</p>";
            document.getElementById('cartTotal').innerText = total.toLocaleString() + " so'm";
        }

        function askGeo() {
            navigator.geolocation.getCurrentPosition(pos => {
                state.geo = pos.coords.latitude + "," + pos.coords.longitude;
                document.getElementById('locBtn').innerHTML = "‚úÖ MANZIL ANIQLANDI";
                document.getElementById('locBtn').style.background = "#06d6a0";
            });
        }

        // BUYURTMA BERISH
        async function makeOrder() {
            if(Object.keys(state.cart).length === 0) return showMsg("Savat bo'sh!");
            if(!state.geo) return showMsg("Manzilni aniqlang!");

            let user = JSON.parse(localStorage.getItem('cafe_user'));
            let orderId = Math.floor(1000 + Math.random() * 9000);
            let itemsText = Object.keys(state.cart).map(id => `‚Ä¢ ${state.products[id].name} (x${state.cart[id]})`).join('\n');
            let phoneClean = user.phone.replace(/\s/g,'');

            // 1. Jadvalga saqlash
            fetch(`${SCRIPT_URL}?method=save&orderId=${orderId}&details=${encodeURIComponent(user.name + "\n" + itemsText)}`);

            // 2. Botga yuborish
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    chat_id: ADMIN_ID,
                    text: `üÜï BUYURTMA #${orderId}\nüÜî ID: ${user.id}\nüë§ ${user.name}\nüìû ${phoneClean}\n\n${itemsText}\nüìç Manzil: https://www.google.com/maps?q=${state.geo}`,
                    reply_markup: {
                        inline_keyboard: [[{text: "‚úÖ Qabul qilish", callback_data: `ok_${orderId}`}]]
                    }
                })
            });

            state.history.unshift({id: orderId, items: itemsText, status: "Kutilmoqda ‚è≥"});
            localStorage.setItem('cafe_history', JSON.stringify(state.history));
            state.cart = {};
            renderCart();
            showMsg("Buyurtma yuborildi! üöÄ");
            go('history', document.querySelectorAll('.nav-item')[3]);
        }

        // STATUSLARNI SINXRONLASH
        async function syncStatuses() {
            for(let order of state.history) {
                if(order.status.includes("Yetkazildi")) continue;
                try {
                    const r = await fetch(`${SCRIPT_URL}?orderId=${order.id}`);
                    const j = await r.json();
                    if(j.status && j.status !== order.status) {
                        order.status = j.status;
                        localStorage.setItem('cafe_history', JSON.stringify(state.history));
                        renderHistory();
                    }
                } catch(e){}
            }
        }

        function renderHistory() {
            document.getElementById('historyBox').innerHTML = state.history.map(h => `
                <div class="history-item">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <b>Buyurtma #${h.id}</b>
                        <span class="status-badge">${h.status}</span>
                    </div>
                    <div style="font-size:12px; color:#666;">${h.items.replace(/\n/g, '<br>')}</div>
                </div>
            `).join('') || "<p>Tarix mavjud emas</p>";
        }

        // ADMIN BILAN ALOQA
        function sendToAdmin() {
            let msgText = document.getElementById('adminMsg').value.trim();
            if(!msgText) return;
            let user = JSON.parse(localStorage.getItem('cafe_user'));
            
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    chat_id: ADMIN_ID,
                    text: `üí¨ XABAR (ID: ${user.id})\nüë§ ${user.name}:\n\n${msgText}`
                })
            });
            document.getElementById('adminMsg').value = "";
            showMsg("Xabar yuborildi! ‚úÖ");
        }

        // NAVIGATSIYA
        function go(p, el) {
            document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
            document.getElementById('p-'+p).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            if(p === 'fav') renderFavs();
            if(p === 'history') renderHistory();
        }

        function showMsg(m) {
            let t = document.getElementById('toast');
            t.innerText = m;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }
    </script>
</body>
</html>
