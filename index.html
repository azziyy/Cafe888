<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cafe 777 - Premium System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #ffbe0b; --secondary: #fb5607; --dark: #1a1a1a;
            --blue: #0088cc; --green: #2ecc71; --red: #ff4757; --gray: #f0f2f5;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--gray); margin: 0; overflow-x: hidden; }

        /* REGISTRATSIYA */
        .full-screen-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 5000; display: none;
            flex-direction: column; align-items: center; justify-content: center; padding: 30px;
        }
        .full-screen-modal.hide { transform: translateY(-100%); opacity: 0; transition: 0.5s; }

        /* MENU VA KARTALAR */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; max-width: 600px; margin: auto; }
        .card { background: white; border-radius: 20px; overflow: hidden; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
        
        /* SEVIMLILAR (YURAKCHA) */
        .fav-heart {
            position: absolute; top: 10px; right: 10px; font-size: 22px;
            color: rgba(255,255,255,0.8); cursor: pointer; z-index: 10;
            text-shadow: 0 0 5px rgba(0,0,0,0.3); transition: 0.3s;
        }
        .fav-heart.active { color: var(--red); }

        /* STATUS VA CHAT QISMI */
        .status-box { background: white; margin: 15px; padding: 20px; border-radius: 20px; border-left: 5px solid var(--blue); }
        .chat-area { height: 250px; overflow-y: auto; background: #eee; border-radius: 15px; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 12px; font-size: 14px; max-width: 80%; }
        .msg.admin { background: white; align-self: flex-start; }
        .msg.user { background: var(--blue); color: white; align-self: flex-end; }

        /* UMUMIY STYLES */
        input { width: 100%; padding: 15px; margin: 8px 0; border: 2px solid #eee; border-radius: 12px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 14px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-order { background: var(--blue); color: white; }
    </style>
</head>
<body>

    <div id="regScreen" class="full-screen-modal" style="display: flex;">
        <h2 style="margin: 0;">Cafe 777</h2>
        <p style="color: #888;">Ism va raqamingizni kiriting</p>
        <input type="text" id="regName" placeholder="Ismingiz">
        <input type="tel" id="regPhone" value="+998 " oninput="fixPhone(this)" maxlength="19">
        <button class="btn" style="background: var(--dark); color: white; margin-top: 15px;" onclick="saveRegistration()">KIRISH</button>
    </div>

    <div id="catNav" style="display:flex; gap:10px; overflow-x:auto; padding:15px; background:white;"></div>
    <div id="menuDisplay" class="menu-grid"></div>

    <div style="width: 92%; max-width: 450px; margin: auto;">
        <div id="orderStatusUI" class="status-box">
            <h4 style="margin:0 0 10px 0;">Buyurtma holati üöö</h4>
            <div id="statusText" style="color: var(--blue); font-weight: bold;">Hali buyurtma yo'q</div>
        </div>

        <div class="status-box">
            <h4 style="margin:0 0 10px 0;">Admin bilan chat üí¨</h4>
            <div id="chatDisplay" class="chat-area"></div>
            <div style="display:flex; gap:5px; margin-top:10px;">
                <input type="text" id="userMsg" placeholder="Xabar..." style="margin:0; padding:10px;">
                <button class="btn" style="width:auto; padding:0 20px; background:var(--blue); color:white;" onclick="sendToAdmin()">Yuborish</button>
            </div>
        </div>
    </div>

    <div style="background: white; margin: 20px auto; padding: 25px; border-radius: 25px; width: 92%; max-width: 450px;">
        <h3>Savat üõí</h3>
        <div id="cartList"></div>
        <div style="display:flex; justify-content:space-between; margin:15px 0; font-weight:bold;">
            <span>Jami:</span><span id="totalPrice">0 so'm</span>
        </div>
        <button class="btn" onclick="getLocation()" id="locBtn" style="background:#f0f2f5; margin-bottom:10px;">üìç MANZILNI ANIQLASH</button>
        <button class="btn btn-order" id="submitBtn" onclick="sendOrder()">BUYURTMA BERISH</button>
    </div>

    <script>
        const BOT_TOKEN = "8032226679:AAETTGPvYZYSvF_QmdofXKibpOwt4E9Iitc";
        const ADMIN_ID = "519326806";
        const SHEET_ID = "1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk";

        let products = [], cart = {}, favorites = [], userCoords = null, userID = "";

        // TELEFON FORMATI (+998 93 978 29 26)
        function fixPhone(input) {
            let val = input.value.replace(/[^\d]/g, ''); 
            if (!val.startsWith('998')) val = '998' + val;
            let res = "+998 ";
            if (val.length > 3) res += val.substring(3, 5) + " ";
            if (val.length > 5) res += val.substring(5, 8) + " ";
            if (val.length > 8) res += val.substring(8, 10) + " ";
            if (val.length > 10) res += val.substring(10, 12);
            input.value = res.trim();
        }

        // REGISTRATSIYA VA ID GENERATSIYA
        function saveRegistration() {
            const n = document.getElementById('regName').value.trim();
            const p = document.getElementById('regPhone').value.trim();
            if(n.length < 3 || p.length < 17) return alert("Ma'lumotlarni to'liq kiriting!");
            
            userID = "ID" + Math.floor(1000 + Math.random() * 9000); // Unikal ID
            localStorage.setItem('c777_user', JSON.stringify({name: n, phone: p, id: userID}));
            
            document.getElementById('regScreen').classList.add('hide');
            setTimeout(() => { document.getElementById('regScreen').style.display = 'none'; }, 500);
            loadData();
        }

        // SEVIMLILAR (YURAKCHA)
        function toggleFav(id) {
            const idx = favorites.indexOf(id);
            if(idx > -1) favorites.splice(idx, 1);
            else favorites.push(id);
            localStorage.setItem('c777_favs', JSON.stringify(favorites));
            renderMenu();
        }

        async function loadData() {
            try {
                const r = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`);
                const t = await r.text();
                const j = JSON.parse(t.substr(47).slice(0, -2));
                products = j.table.rows.map((r, i) => ({
                    id: i+1, cat: r.c[1]?.v || 'Taom', name: r.c[2]?.v || 'Nomsiz', 
                    price: r.c[3]?.v || 0, img: r.c[4]?.v || ''
                }));
                renderMenu();
            } catch (e) { console.log(e); }
        }

        function renderMenu() {
            document.getElementById('menuDisplay').innerHTML = products.map(p => `
                <div class="card">
                    <i class="fa${favorites.includes(p.id)?'s':'r'} fa-heart fav-heart ${favorites.includes(p.id)?'active':''}" onclick="toggleFav(${p.id})"></i>
                    <img src="${p.img}" onclick="viewProduct(${p.id})">
                    <div style="padding:10px; text-align:center;">
                        <h4>${p.name}</h4>
                        <b>${p.price.toLocaleString()} so'm</b>
                        <button onclick="updateQty(${p.id}, 1)" style="background:var(--dark); color:white; border:none; padding:8px 15px; border-radius:10px;">+ Savatga</button>
                    </div>
                </div>`).join('');
        }

        function updateQty(id, c) {
            cart[id] = (cart[id]||0) + c;
            if(cart[id] <= 0) delete cart[id];
            renderCart();
        }

        function renderCart() {
            let t = 0, h = "";
            for(let id in cart) {
                let p = products.find(x => x.id == id);
                t += p.price * cart[id];
                h += `<div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:5px;">
                        <span>${p.name} x${cart[id]}</span>
                        <span>${(p.price*cart[id]).toLocaleString()}</span>
                    </div>`;
            }
            document.getElementById('cartList').innerHTML = h || "Savat bo'sh";
            document.getElementById('totalPrice').innerText = t.toLocaleString() + " so'm";
        }

        function getLocation() {
            navigator.geolocation.getCurrentPosition(p => {
                userCoords = { lat: p.coords.latitude, lon: p.coords.longitude };
                document.getElementById('locBtn').innerText = "‚úÖ MANZIL ANIQLANDI";
                document.getElementById('locBtn').style.background = "#eaffea";
            });
        }

        // BUYURTMA VA BOT TUGMALARI
        async function sendOrder() {
            if(!Object.keys(cart).length || !userCoords) return alert("Savat yoki manzil bo'sh!");
            const user = JSON.parse(localStorage.getItem('c777_user'));
            
            let items = "";
            for(let id in cart) items += `- ${products.find(x=>x.id==id).name} x${cart[id]}\n`;
            
            const msg = `üöÄ YANGI BUYURTMA\nüÜî ID: ${user.id}\nüë§: ${user.name}\nüìû: ${user.phone.replace(/\s+/g, '')}\n\n${items}üí∞ JAMI: ${document.getElementById('totalPrice').innerText}\n\nüìç Manzil: https://www.google.com/maps?q=${userCoords.lat},${userCoords.lon}`;

            const keyboard = {
                inline_keyboard: [
                    [{text: "‚úÖ Qabul qilish", callback_data: `st_qabul_${user.id}`}, {text: "üë®‚Äçüç≥ Tayyorlash", callback_data: `st_tayyor_${user.id}`}],
                    [{text: "üöö Yetkazish", callback_data: `st_yolda_${user.id}`}, {text: "üèÅ Yakunlash", callback_data: `st_ok_${user.id}`}]
                ]
            };

            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ chat_id: ADMIN_ID, text: msg, reply_markup: keyboard })
            });
            alert("Buyurtma yuborildi!");
            cart = {}; renderCart();
        }

        // ADMIN BILAN CHAT
        async function sendToAdmin() {
            const txt = document.getElementById('userMsg').value;
            if(!txt) return;
            const user = JSON.parse(localStorage.getItem('c777_user'));
            
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ chat_id: ADMIN_ID, text: `üí¨ XABAR\nüÜî ${user.id}\nüë§ ${user.name}:\n${txt}` })
            });
            
            addChatMessage('user', txt);
            document.getElementById('userMsg').value = "";
        }

        function addChatMessage(type, txt) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = txt;
            document.getElementById('chatDisplay').appendChild(div);
            document.getElementById('chatDisplay').scrollTop = 99999;
        }

        // BOTDAN KELADIGAN JAVOBLARNI VA STATUSLARNI TEKSHIRISH
        async function checkUpdates() {
            const user = JSON.parse(localStorage.getItem('c777_user'));
            if(!user) return;

            try {
                const r = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=-10`);
                const d = await r.json();
                
                d.result.forEach(u => {
                    // Statuslarni tekshirish (Callback query orqali)
                    if(u.callback_query && u.callback_query.data.includes(user.id)) {
                        const data = u.callback_query.data;
                        if(data.includes('qabul')) document.getElementById('statusText').innerText = "‚úÖ Buyurtma qabul qilindi";
                        if(data.includes('tayyor')) document.getElementById('statusText').innerText = "üë®‚Äçüç≥ Taom tayyorlanmoqda";
                        if(data.includes('yolda')) document.getElementById('statusText').innerText = "üöö Kuryer yo'lda";
                        if(data.includes('ok')) document.getElementById('statusText').innerText = "üèÅ Buyurtma yakunlandi";
                    }

                    // Admin xabarini tekshirish (ID, xabar formati)
                    if(u.message && u.message.text) {
                        const msg = u.message.text;
                        if(msg.startsWith(user.id + ",")) {
                            const realMsg = msg.split(',')[1];
                            const msgID = u.message.message_id;
                            // Takroriy xabar kelmasligi uchun saqlash
                            if(!localStorage.getItem('m_'+msgID)) {
                                addChatMessage('admin', realMsg);
                                localStorage.setItem('m_'+msgID, '1');
                            }
                        }
                    }
                });
            } catch(e) {}
        }

        setInterval(checkUpdates, 3000);

        window.onload = () => {
            const saved = localStorage.getItem('c777_user');
            if(saved) {
                userID = JSON.parse(saved).id;
                document.getElementById('regScreen').style.display = 'none';
            }
            favorites = JSON.parse(localStorage.getItem('c777_favs') || "[]");
            loadData();
        };
    </script>
</body>
</html>
