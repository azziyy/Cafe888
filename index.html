<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cafe 777 Premium</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --secondary: #fb5607; --dark: #1a1a1a; --light: #f8f9fa; 
            --white: #ffffff; --gray: #8d99ae; --shadow: 0 10px 25px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--light); margin: 0; padding-bottom: 110px; color: var(--dark); }

        .page { display: none; padding: 20px; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }

        /* --- Image & Description Modal --- */
        #imgModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 3000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px); padding: 20px;
        }
        #imgModal img { max-width: 100%; max-height: 60%; border-radius: 25px; object-fit: cover; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        #modalDesc { color: white; margin-top: 20px; text-align: center; max-width: 90%; font-size: 16px; line-height: 1.5; }
        .close-modal { position: absolute; top: 25px; right: 25px; color: white; font-size: 35px; cursor: pointer; }

        /* --- Product Card --- */
        .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .product-card { background: var(--white); border-radius: 25px; overflow: hidden; box-shadow: var(--shadow); transition: 0.3s; }
        .img-container { width: 100%; aspect-ratio: 1/1; position: relative; cursor: pointer; }
        .img-container img { width: 100%; height: 100%; object-fit: cover; }
        
        .p-info { padding: 12px; }
        .p-name { font-size: 14px; font-weight: 700; margin-bottom: 4px; display: block; }
        .p-desc { font-size: 11px; color: var(--gray); line-height: 1.3; height: 28px; overflow: hidden; margin-bottom: 8px; }
        .p-price { color: var(--secondary); font-weight: 800; font-size: 15px; }

        /* --- History Section --- */
        .history-item { 
            background: white; padding: 15px; border-radius: 20px; margin-bottom: 12px; 
            box-shadow: var(--shadow); border-left: 6px solid var(--secondary);
        }
        .status-pill { 
            background: #f0f0f0; padding: 5px 12px; border-radius: 10px; 
            font-size: 11px; font-weight: 700; color: var(--secondary); 
        }

        /* --- Buttons --- */
        .btn-main { width: 100%; background: var(--secondary); color: white; border: none; padding: 12px; border-radius: 15px; font-weight: 700; cursor: pointer; }
        .qty-box { display: flex; align-items: center; justify-content: space-between; background: var(--dark); border-radius: 12px; padding: 5px; color: white; }

        /* --- Navbar --- */
        .navbar {
            position: fixed; bottom: 20px; left: 5%; width: 90%;
            background: white; display: flex; padding: 12px; border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 1000;
        }
        .nav-item { flex: 1; text-align: center; color: var(--gray); font-size: 10px; font-weight: 700; }
        .nav-item.active { color: var(--secondary); transform: translateY(-3px); transition: 0.3s; }
        .nav-item i { font-size: 20px; display: block; }
    </style>
</head>
<body>

    <div id="imgModal" onclick="closeModal()">
        <span class="close-modal">&times;</span>
        <img id="modalImg" src="">
        <h3 id="modalTitle" style="color:white; margin-bottom:5px;"></h3>
        <p id="modalDesc"></p>
        <div id="modalPrice" style="color:var(--secondary); font-weight:800; font-size:20px;"></div>
    </div>

    <div id="p-reg" class="page active">
        <div style="height:90vh; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <div style="text-align:center; width:85%;">
                <h1 style="font-size:40px; color:var(--secondary); margin:0;">Cafe 777</h1>
                <p style="color:var(--gray); margin-bottom:30px;">Premium xizmat ko'rsatish ilovasi</p>
                <input type="text" id="userName" placeholder="Ismingiz" style="width:100%; padding:18px; border-radius:18px; border:2px solid #eee; margin-bottom:15px;">
                <input type="tel" id="userPhone" value="+998 " style="width:100%; padding:18px; border-radius:18px; border:2px solid #eee; margin-bottom:20px;">
                <button onclick="login()" class="btn-main" style="padding:20px;">BOSHLASH</button>
            </div>
        </div>
    </div>

    <div id="app" style="display:none;">
        <div id="p-home" class="page">
            <div id="catBox" style="display:flex; overflow-x:auto; gap:10px; padding-bottom:15px;"></div>
            <div class="product-grid" id="menuGrid"></div>
        </div>

        <div id="p-history" class="page">
            <h2 style="font-weight:800;">Buyurtmalarim üìú</h2>
            <div id="historyList"></div>
        </div>

        <div id="p-cart" class="page">
            <h2 style="font-weight:800;">Savat üõí</h2>
            <div id="cartList"></div>
            <div id="cartSummary" style="display:none; background:white; padding:20px; border-radius:25px; margin-top:20px;">
                <h3 id="totalPrice">Jami: 0 so'm</h3>
                <button onclick="getLocation()" id="locBtn" class="btn-main" style="background:#2ecc71; margin-bottom:10px;">üìç MANZILNI ANIQLASH</button>
                <button onclick="sendOrder()" class="btn-main">YUBORISH</button>
            </div>
        </div>

        <nav class="navbar">
            <div class="nav-item active" onclick="nav('home', this)"><i class="fas fa-home"></i>Menyu</div>
            <div class="nav-item" onclick="nav('cart', this)"><i class="fas fa-shopping-bag"></i>Savat</div>
            <div class="nav-item" onclick="nav('history', this)"><i class="fas fa-list-ul"></i>Tarix</div>
        </nav>
    </div>

    <script>
        const BOT_TOKEN = "8032226679:AAETTGPvYZYSvF_QmdofXKibpOwt4E9Iitc";
        const ADMIN_ID = "519326806";
        const SHEET_ID = "1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk";

        let state = {
            products: [], cart: {}, activeCat: 'Hammasi', loc: null,
            user: JSON.parse(localStorage.getItem('c7_user')),
            history: JSON.parse(localStorage.getItem('c7_history') || '[]')
        };

        window.onload = () => { if(state.user) showMain(); };

        function login() {
            let n = document.getElementById('userName').value;
            let p = document.getElementById('userPhone').value;
            if(n.length < 3) return Swal.fire('Xato', 'Ismni kiriting', 'error');
            state.user = {name: n, phone: p};
            localStorage.setItem('c7_user', JSON.stringify(state.user));
            showMain();
        }

        function showMain() {
            document.getElementById('p-reg').style.display='none';
            document.getElementById('app').style.display='block';
            loadData();
        }

        async function loadData() {
            const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`);
            const text = await res.text();
            const data = JSON.parse(text.substring(47).slice(0, -2));
            state.products = data.table.rows.map((r, i) => ({
                id: i, 
                cat: r.c[1]?.v || "Boshqa", 
                name: r.c[2]?.v, 
                price: r.c[3]?.v, 
                img: r.c[4]?.v,
                desc: r.c[5]?.v || "Mazali mahsulot" // 6-ustundan tavsifni olamiz
            }));
            renderCats(); renderMenu();
        }

        function openLightbox(id) {
            let p = state.products[id];
            document.getElementById('modalImg').src = p.img;
            document.getElementById('modalTitle').innerText = p.name;
            document.getElementById('modalDesc').innerText = p.desc;
            document.getElementById('modalPrice').innerText = p.price.toLocaleString() + " so'm";
            document.getElementById('imgModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('imgModal').style.display = 'none'; }

        function renderMenu() {
            let filtered = state.activeCat === 'Hammasi' ? state.products : state.products.filter(p => p.cat === state.activeCat);
            document.getElementById('menuGrid').innerHTML = filtered.map(p => `
                <div class="product-card animate__animated animate__zoomIn">
                    <div class="img-container" onclick="openLightbox(${p.id})">
                        <img src="${p.img}">
                    </div>
                    <div class="p-info">
                        <b class="p-name">${p.name}</b>
                        <p class="p-desc">${p.desc}</p>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b class="p-price">${p.price.toLocaleString()}</b>
                            <button onclick="add(${p.id})" style="background:var(--secondary); color:white; border:none; border-radius:8px; padding:5px 10px;"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderCats() {
            let cats = ['Hammasi', ...new Set(state.products.map(p => p.cat))];
            document.getElementById('catBox').innerHTML = cats.map(c => `
                <div onclick="state.activeCat='${c}'; renderCats(); renderMenu();" 
                     style="padding:8px 18px; background:${state.activeCat===c?'var(--secondary)':'white'}; 
                            color:${state.activeCat===c?'white':'var(--gray)'}; border-radius:15px; white-space:nowrap; font-weight:600; box-shadow:var(--shadow);">
                    ${c}
                </div>
            `).join('');
        }

        function add(id) {
            state.cart[id] = (state.cart[id] || 0) + 1;
            Swal.fire({ toast:true, position:'top', icon:'success', title:'Savatga qo\'shildi', showConfirmButton:false, timer:1000 });
        }

        function nav(p, el) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('p-'+p).classList.add('active');
            el.classList.add('active');
            if(p === 'cart') renderCart();
            if(p === 'history') renderHistory();
        }

        function renderCart() {
            let keys = Object.keys(state.cart), total = 0;
            if(!keys.length) { document.getElementById('cartList').innerHTML = "Savat bo'sh"; document.getElementById('cartSummary').style.display='none'; return; }
            document.getElementById('cartSummary').style.display='block';
            document.getElementById('cartList').innerHTML = keys.map(id => {
                let p = state.products[id]; total += p.price * state.cart[id];
                return `<div style="display:flex; justify-content:space-between; background:white; padding:15px; border-radius:15px; margin-bottom:10px; box-shadow:var(--shadow);">
                    <span><b>${p.name}</b><br><small>${state.cart[id]} dona</small></span>
                    <b>${(p.price*state.cart[id]).toLocaleString()} so'm</b>
                </div>`;
            }).join('');
            document.getElementById('totalPrice').innerText = "Jami: " + total.toLocaleString() + " so'm";
        }

        function getLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                state.loc = `http://maps.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
                document.getElementById('locBtn').innerText = "‚úÖ MANZIL ANIQLANDI";
                Swal.fire('Rahmat', 'Manzil olindi', 'success');
            }, () => Swal.fire('Xato', 'Geolokatsiyani yoqing', 'error'));
        }

        async function sendOrder() {
            if(!state.loc) return Swal.fire('Manzil?', 'Joylashuvni aniqlang', 'warning');
            let orderId = "#" + Math.floor(Math.random()*9000 + 1000);
            let items = Object.keys(state.cart).map(id => `${state.products[id].name} (x${state.cart[id]})`).join('\n');
            let total = document.getElementById('totalPrice').innerText;

            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    chat_id: ADMIN_ID,
                    text: `üÜï BUYURTMA ${orderId}\nüë§ ${state.user.name}\nüìû ${state.user.phone}\nüì¶ ${items}\nüí∞ ${total}\nüìç ${state.loc}`,
                    reply_markup: { inline_keyboard: [[{ text: "‚úÖ Qabul qilish", callback_data: `ok_${orderId}` }]] }
                })
            });

            state.history.unshift({ id: orderId, status: "Kutilmoqda ‚è≥", total: total, time: new Date().toLocaleTimeString() });
            localStorage.setItem('c7_history', JSON.stringify(state.history));
            
            state.cart = {};
            Swal.fire('Tayyor!', 'Buyurtma yuborildi', 'success').then(() => nav('history', document.querySelectorAll('.nav-item')[2]));
        }

        function renderHistory() {
            document.getElementById('historyList').innerHTML = state.history.map(h => `
                <div class="history-item animate__animated animate__fadeInUp">
                    <div style="display:flex; justify-content:space-between;">
                        <b>ID: ${h.id}</b>
                        <span class="status-pill">${h.status}</span>
                    </div>
                    <div style="margin-top:8px;">
                        <span style="font-size:18px; font-weight:800; color:var(--secondary)">${h.total}</span><br>
                        <small style="color:var(--gray)">${h.time}</small>
                    </div>
                </div>
            `).join('') || "<p style='text-align:center; color:var(--gray);'>Buyurtmalar yo'q</p>";
        }
    </script>
</body>
    </html>
    
