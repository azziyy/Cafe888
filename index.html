<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cafe 777 - Professional System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #ffbe0b; --secondary: #fb5607; --dark: #1a1a1a;
            --blue: #0088cc; --green: #2ecc71; --red: #ff4757; --gray: #f0f2f5;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--gray); margin: 0; overflow-x: hidden; }

        /* 1. REGISTRATSIYA MODALI */
        #regScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 10000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 30px;
            transition: 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #regScreen.hide { transform: translateY(-100%); visibility: hidden; }

        /* 2. HEADER VA NAVIGATSIYA */
        .header {
            width: 100%; background: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .badge { background: var(--red); color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; position: absolute; top: -5px; right: -5px; }

        /* 3. MENU CARDLARI VA ANIMATSIYALAR */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; }
        .card { 
            background: white; border-radius: 20px; overflow: hidden; position: relative; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); animation: zoomIn 0.5s ease;
        }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .fav-icon {
            position: absolute; top: 10px; right: 10px; z-index: 10;
            font-size: 20px; color: #ddd; transition: 0.3s; cursor: pointer;
            text-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .fav-icon.active { color: var(--red); transform: scale(1.2); }

        .card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; cursor: pointer; transition: 0.5s; }

        /* 4. MAHSULOT MODALI (ZOOM) */
        #productModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9000; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
        .modal-content {
            background: white; width: 90%; max-width: 400px; border-radius: 30px; overflow: hidden;
            transform: scale(0.5); opacity: 0; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-content.show { transform: scale(1); opacity: 1; }

        /* 5. STATUS VA CHAT */
        .status-container { background: white; margin: 15px; padding: 20px; border-radius: 20px; border-left: 6px solid var(--blue); }
        .step { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; color: #888; transition: 0.3s; }
        .step.done { color: var(--green); font-weight: bold; }
        .step .dot { width: 12px; height: 12px; border-radius: 50%; background: #ddd; }
        .step.done .dot { background: var(--green); box-shadow: 0 0 10px var(--green); }

        .chat-box { height: 250px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 15px; display: flex; flex-direction: column; gap: 10px; }
        .m { padding: 10px 15px; border-radius: 18px; max-width: 80%; font-size: 14px; line-height: 1.4; }
        .m.admin { background: #e8e8e8; align-self: flex-start; border-bottom-left-radius: 2px; }
        .m.user { background: var(--blue); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }

        /* TUGMALAR */
        .btn-p { background: var(--dark); color: white; border: none; width: 100%; padding: 16px; border-radius: 15px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-p:active { transform: scale(0.95); }
        .btn-loc { background: #eee; color: #333; margin-bottom: 10px; }
        input { width: 100%; padding: 15px; margin: 8px 0; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; }

        /* DRAWER */
        .drawer { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background: white; z-index: 5501; transition: 0.4s; box-shadow: 10px 0 30px rgba(0,0,0,0.1); }
        .drawer.open { left: 0; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 5500; display: none; }
    </style>
</head>
<body>

    <div id="regScreen">
        <div style="font-size: 60px;">üëë</div>
        <h2 style="margin: 10px 0;">Cafe 777</h2>
        <p style="color: #888; margin-bottom: 20px;">Ro'yxatdan o'ting</p>
        <input type="text" id="uName" placeholder="Ism Familiyangiz">
        <input type="tel" id="uPhone" value="+998 " maxlength="17" oninput="formatPhone(this)">
        <button class="btn-p" onclick="completeReg()" style="margin-top: 20px;">SAQLASH VA KIRISH</button>
    </div>

    <div id="overlay" class="overlay" onclick="closeDrawer()"></div>
    <div id="drawer" class="drawer">
        <div style="background:var(--primary); padding:40px 20px; color:white; text-align:center;">
            <div style="font-size:40px;">üë§</div>
            <h3 id="sideName" style="margin:5px 0;"></h3>
            <small id="sidePhone"></small>
        </div>
        <nav style="padding: 20px;">
            <div onclick="showPage('home')" style="padding:15px 0; border-bottom:1px solid #eee;"><i class="fas fa-home"></i> Menyu</div>
            <div onclick="showPage('favs')" style="padding:15px 0; border-bottom:1px solid #eee;"><i class="fas fa-heart"></i> Sevimlilar</div>
            <div onclick="showPage('status')" style="padding:15px 0; border-bottom:1px solid #eee;"><i class="fas fa-truck"></i> Buyurtma holati</div>
            <div onclick="showPage('chat')" style="padding:15px 0;"><i class="fas fa-comment"></i> Xabarlar <span id="chatDot" style="color:red; display:none;">‚óè</span></div>
        </nav>
    </div>

    <header class="header">
        <button onclick="openDrawer()" style="background:none; border:none; font-size:24px;">‚ò∞</button>
        <b style="letter-spacing:1px;">CAFE 777</b>
        <div onclick="showPage('favs')" style="position:relative;">‚ù§Ô∏è<span id="fCount" class="badge">0</span></div>
    </header>

    <main id="p-home">
        <div id="catNav" style="display:flex; gap:10px; overflow-x:auto; padding:15px; background:white;"></div>
        <div class="menu-grid" id="menuDisplay"></div>
    </main>

    <main id="p-favs" style="display:none; padding:20px;">
        <h3>Sevimlilar ‚ù§Ô∏è</h3>
        <div class="menu-grid" id="favDisplay"></div>
    </main>

    <main id="p-status" style="display:none; padding:20px;">
        <h3>Buyurtma kuzatuvi üöö</h3>
        <div id="statusUI">Hozircha faol buyurtma yo'q.</div>
    </main>

    <main id="p-chat" style="display:none; padding:20px;">
        <h3>Xabarlar üí¨</h3>
        <div id="chatDisplay" class="chat-box"></div>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <input type="text" id="chatMsg" placeholder="Xabaringiz...">
            <button onclick="sendMessage()" style="background:var(--blue); color:white; border:none; border-radius:12px; padding:0 15px;">Yuborish</button>
        </div>
    </main>

    <div id="productModal" onclick="if(event.target==this) closeProduct()">
        <div class="modal-content" id="mContent">
            <img id="mImg" style="width:100%;">
            <div style="padding:20px;">
                <h2 id="mTitle" style="margin:0;"></h2>
                <p id="mDesc" style="color:#666; margin:10px 0;"></p>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <b id="mPrice" style="font-size:20px; color:var(--secondary);"></b>
                    <button class="btn-p" onclick="closeProduct()" style="width:auto; padding:10px 20px;">Yopish</button>
                </div>
            </div>
        </div>
    </div>

    <div style="background:white; margin:15px; padding:20px; border-radius:25px; box-shadow:0 10px 30px rgba(0,0,0,0.05);">
        <h3>Savat üõí</h3>
        <div id="cartItems" style="margin-bottom:10px; font-size:14px; color:#555;"></div>
        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:18px; margin-bottom:15px;">
            <span>Jami:</span><span id="totalSum">0 so'm</span>
        </div>
        <button class="btn-p btn-loc" id="locBtn" onclick="getLocation()">üìç MANZILNI ANIQLASH</button>
        <button class="btn-p" id="orderBtn" onclick="placeOrder()">BUYURTMA BERISH</button>
    </div>

    <script>
        const BOT_TOKEN = "8032226679:AAETTGPvYZYSvF_QmdofXKibpOwt4E9Iitc";
        const ADMIN_ID = "519326806";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk/gviz/tq?tqx=out:json";

        let products = [], cart = {}, favorites = [], myLoc = null, userID = "";

        // FORMAT TELEFON
        function formatPhone(i) {
            let v = i.value.replace(/[^\d]/g, '');
            if(!v.startsWith('998')) v = '998' + v;
            let res = "+998 ";
            if(v.length > 3) res += v.substring(3, 5) + " ";
            if(v.length > 5) res += v.substring(5, 8) + " ";
            if(v.length > 8) res += v.substring(8, 10) + " ";
            if(v.length > 10) res += v.substring(10, 12);
            i.value = res.trim();
        }

        // REGISTRATSIYA
        function completeReg() {
            const name = document.getElementById('uName').value;
            const phone = document.getElementById('uPhone').value;
            if(name.length < 3 || phone.length < 17) return alert("Ma'lumotlarni to'liq kiriting!");
            
            userID = "ID" + Math.floor(Math.random() * 999999);
            localStorage.setItem('c777_user', JSON.stringify({name, phone, userID}));
            
            document.getElementById('regScreen').classList.add('hide');
            loadAppData();
        }

        // MA'LUMOTLARNI YUKLASH
        async function loadAppData() {
            const user = JSON.parse(localStorage.getItem('c777_user'));
            if(!user) return;
            
            document.getElementById('regScreen').style.display = 'none';
            document.getElementById('sideName').innerText = user.name;
            document.getElementById('sidePhone').innerText = user.phone;
            userID = user.userID;

            try {
                const r = await fetch(SHEET_URL);
                const t = await r.text();
                const j = JSON.parse(t.substr(47).slice(0,-2));
                products = j.table.rows.map((r,i) => ({
                    id: i+1, cat: r.c[1]?.v, name: r.c[2]?.v, price: r.c[3]?.v, img: r.c[4]?.v, desc: r.c[5]?.v || "Ajoyib ta'm!"
                }));
                renderMenu();
            } catch(e) { alert("Internet xatosi!"); }
        }

        function renderMenu() {
            const display = document.getElementById('menuDisplay');
            display.innerHTML = products.map(p => `
                <div class="card">
                    <i class="fas fa-heart fav-icon ${favorites.includes(p.id)?'active':''}" onclick="toggleFav(${p.id}, this)"></i>
                    <img src="${p.img}" onclick="openProduct(${p.id})">
                    <div style="padding:10px; text-align:center;">
                        <h4 style="margin:5px 0; font-size:14px;">${p.name}</h4>
                        <b style="color:var(--secondary)">${p.price.toLocaleString()} so'm</b>
                        <button onclick="addToCart(${p.id})" style="width:100%; margin-top:8px; border:none; background:var(--dark); color:white; border-radius:8px; padding:5px;">+ Savat</button>
                    </div>
                </div>
            `).join('');
        }

        // MODAL FUNKSIYALARI
        function openProduct(id) {
            const p = products.find(x => x.id == id);
            document.getElementById('mImg').src = p.img;
            document.getElementById('mTitle').innerText = p.name;
            document.getElementById('mDesc').innerText = p.desc;
            document.getElementById('mPrice').innerText = p.price.toLocaleString() + " so'm";
            document.getElementById('productModal').style.display = 'flex';
            setTimeout(() => document.getElementById('mContent').classList.add('show'), 10);
        }

        function closeProduct() {
            document.getElementById('mContent').classList.remove('show');
            setTimeout(() => document.getElementById('productModal').style.display = 'none', 300);
        }

        // SAVAT VA SEVIMLILAR
        function addToCart(id) {
            cart[id] = (cart[id] || 0) + 1;
            updateCartUI();
        }

        function toggleFav(id, el) {
            const idx = favorites.indexOf(id);
            if(idx === -1) { favorites.push(id); el.classList.add('active'); }
            else { favorites.splice(idx, 1); el.classList.remove('active'); }
            document.getElementById('fCount').innerText = favorites.length;
        }

        function updateCartUI() {
            let total = 0, html = "";
            for(let id in cart) {
                const p = products.find(x => x.id == id);
                total += p.price * cart[id];
                html += `<div>${p.name} x${cart[id]}</div>`;
            }
            document.getElementById('cartItems').innerHTML = html || "Savat bo'sh";
            document.getElementById('totalSum').innerText = total.toLocaleString() + " so'm";
        }

        // MANZIL
        function getLocation() {
            const btn = document.getElementById('locBtn');
            btn.innerText = "Aniqlanmoqda...";
            navigator.geolocation.getCurrentPosition(pos => {
                myLoc = `${pos.coords.latitude},${pos.coords.longitude}`;
                btn.innerText = "‚úÖ MANZIL ANIQLANDI";
                btn.style.background = "#eaffea";
            }, () => { alert("GPS-ni yoqing!"); btn.innerText = "üìç MANZILNI ANIQLASH"; });
        }

        // BUYURTMA BERISH
        async function placeOrder() {
            if(!Object.keys(cart).length) return alert("Savat bo'sh!");
            if(!myLoc) return alert("Avval manzilni aniqlang!");

            const user = JSON.parse(localStorage.getItem('c777_user'));
            let items = "";
            for(let id in cart) items += `- ${products.find(x=>x.id==id).name} x${cart[id]}\n`;

            const text = `üöÄ YANGI BUYURTMA\nüë§: ${user.name}\nüìû: ${user.phone}\nüÜî: ${user.userID}\n\n${items}\nüí∞ JAMI: ${document.getElementById('totalSum').innerText}\nüìç Manzil: https://www.google.com/maps?q=${myLoc}`;

            const keyboard = {
                inline_keyboard: [
                    [{text: "‚úÖ Qabul qilish", callback_data: `st_qabul_${user.userID}`}],
                    [{text: "üë®‚Äçüç≥ Tayyorlanmoqda", callback_data: `st_tayyor_${user.userID}`}],
                    [{text: "üöö Yetkazilmoqda", callback_data: `st_yolda_${user.userID}`}]
                ]
            };

            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ chat_id: ADMIN_ID, text: text, reply_markup: keyboard })
            });

            alert("Buyurtma yuborildi!");
            localStorage.setItem('last_status', 'yuborildi');
            updateStatusUI();
            cart = {}; updateCartUI();
        }

        // REAL-TIME STATUS VA CHAT (TELEGRAMDAN TEKSHIRISH)
        async function syncWithTelegram() {
            try {
                const r = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=-1`);
                const d = await r.json();
                if(!d.result.length) return;

                const last = d.result[0];
                
                // Status o'zgarishi (Agar admin callback yoki maxsus xabar yuborsa)
                if(last.message && last.message.text.includes(userID)) {
                    const txt = last.message.text.toLowerCase();
                    if(txt.includes("qabul")) localStorage.setItem('last_status', 'qabul');
                    if(txt.includes("tayyor")) localStorage.setItem('last_status', 'tayyor');
                    if(txt.includes("yolda")) localStorage.setItem('last_status', 'yolda');
                    updateStatusUI();
                }

                // Chat (Admin javobi)
                // Admin mijozning xabariga REPLY qilgan bo'lishi kerak
                if(last.message && last.message.reply_to_message && last.message.reply_to_message.text.includes(userID)) {
                    const msg = last.message.text;
                    const history = JSON.parse(localStorage.getItem('chat_hist') || "[]");
                    if(!history.find(h => h.txt == msg)) {
                        history.push({type: 'admin', txt: msg});
                        localStorage.setItem('chat_hist', JSON.stringify(history));
                        renderChat();
                        document.getElementById('chatDot').style.display = 'inline';
                    }
                }
            } catch(e) {}
        }
        setInterval(syncWithTelegram, 3000);

        function updateStatusUI() {
            const s = localStorage.getItem('last_status');
            if(!s) return;
            const container = document.getElementById('statusUI');
            container.innerHTML = `
                <div class="status-container">
                    <div class="step ${s=='yuborildi'||s=='qabul'||s=='tayyor'||s=='yolda'?'done':''}"> <div class="dot"></div> Buyurtma yuborildi</div>
                    <div class="step ${s=='qabul'||s=='tayyor'||s=='yolda'?'done':''}"> <div class="dot"></div> Admin qabul qildi</div>
                    <div class="step ${s=='tayyor'||s=='yolda'?'done':''}"> <div class="dot"></div> Taom tayyorlandi</div>
                    <div class="step ${s=='yolda'?'done':''}"> <div class="dot"></div> Kuryer yo'lda</div>
                </div>
            `;
        }

        function sendMessage() {
            const inp = document.getElementById('chatMsg');
            if(!inp.value) return;
            const txt = inp.value;
            const history = JSON.parse(localStorage.getItem('chat_hist') || "[]");
            history.push({type: 'user', txt: txt});
            localStorage.setItem('chat_hist', JSON.stringify(history));

            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ chat_id: ADMIN_ID, text: `üí¨ MIJOZ (${userID}):\n${txt}` })
            });

            inp.value = ""; renderChat();
        }

        function renderChat() {
            const hist = JSON.parse(localStorage.getItem('chat_hist') || "[]");
            document.getElementById('chatDisplay').innerHTML = hist.map(h => `<div class="m ${h.type}">${h.txt}</div>`).join('');
            const d = document.getElementById('chatDisplay'); d.scrollTop = d.scrollHeight;
        }

        // NAVIGATSIYA
        function showPage(p) {
            ['home', 'favs', 'status', 'chat'].forEach(id => document.getElementById('p-'+id).style.display = 'none');
            document.getElementById('p-'+p).style.display = 
