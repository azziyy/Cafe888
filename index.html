<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cafe 777 - Professional System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #ffbe0b; --secondary: #fb5607; --dark: #1a1a1a;
            --blue: #0088cc; --green: #2ecc71; --red: #ff4757; --gray: #f0f2f5;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--gray); margin: 0; overflow-x: hidden; }

        /* 1. REGISTRATSIYA MODALI */
        #regScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 10000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 30px;
            transition: 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #regScreen.hide { transform: translateY(-120%); opacity: 0; pointer-events: none; }

        /* 2. HEADER VA NAVIGATSIYA */
        .header {
            width: 100%; background: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .badge { background: var(--red); color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; position: absolute; top: -5px; right: -5px; }

        /* 3. MENU CARDLARI VA ANIMATSIYALAR */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; }
        .card { 
            background: white; border-radius: 20px; overflow: hidden; position: relative; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); animation: zoomIn 0.5s ease;
        }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .fav-icon {
            position: absolute; top: 10px; right: 10px; z-index: 10;
            font-size: 20px; color: #ddd; transition: 0.3s; cursor: pointer;
        }
        .fav-icon.active { color: var(--red); transform: scale(1.2); }

        .card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; cursor: pointer; transition: 0.5s; }

        /* 4. MAHSULOT MODALI (ZOOM EFFECT) */
        #productModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9000; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
        .modal-content {
            background: white; width: 90%; max-width: 400px; border-radius: 30px; overflow: hidden;
            transform: scale(0.1); opacity: 0; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-content.show { transform: scale(1); opacity: 1; }

        /* 5. STATUS VA CHAT */
        .status-box { background: white; margin: 15px; padding: 20px; border-radius: 20px; border-left: 6px solid var(--blue); }
        .step { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; color: #888; transition: 0.3s; }
        .step.done { color: var(--green); font-weight: bold; }
        .step .dot { width: 14px; height: 14px; border-radius: 50%; background: #ddd; }
        .step.done .dot { background: var(--green); box-shadow: 0 0 10px var(--green); }

        .chat-box { height: 300px; overflow-y: auto; padding: 10px; background: #f0f2f5; border-radius: 15px; display: flex; flex-direction: column; gap: 10px; }
        .m { padding: 12px 16px; border-radius: 20px; max-width: 80%; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .m.admin { background: white; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #eee; }
        .m.user { background: var(--blue); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }

        /* TUGMALAR */
        .btn-p { background: var(--dark); color: white; border: none; width: 100%; padding: 16px; border-radius: 15px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-p:active { transform: scale(0.95); }
        .btn-loc { background: #eee; color: #333; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }

        input { width: 100%; padding: 15px; margin: 8px 0; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; }

        /* DRAWER */
        .drawer { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background: white; z-index: 5501; transition: 0.4s; }
        .drawer.open { left: 0; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 5500; display: none; }
    </style>
</head>
<body>

    <div id="regScreen">
        <div style="font-size: 70px; animation: bounce 2s infinite;">üçï</div>
        <h2 style="margin: 10px 0;">Cafe 777</h2>
        <p style="color: #888; margin-bottom: 25px;">Davom etish uchun ro'yxatdan o'ting</p>
        <input type="text" id="uName" placeholder="Ismingiz">
        <input type="tel" id="uPhone" value="+998 " maxlength="17" oninput="formatPhone(this)">
        <button class="btn-p" onclick="completeReg()" style="margin-top: 20px; background: var(--secondary);">SAQLASH VA KIRISH</button>
    </div>

    <div id="overlay" class="overlay" onclick="closeDrawer()"></div>
    <div id="drawer" class="drawer">
        <div style="background:var(--primary); padding:40px 20px; color:var(--dark); text-align:center;">
            <div style="font-size:50px; background:white; width:80px; height:80px; border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center;">üë§</div>
            <h3 id="sideName" style="margin:5px 0;">Mehmon</h3>
            <small id="sidePhone" style="opacity:0.7;"></small>
        </div>
        <nav style="padding: 15px;">
            <div onclick="showPage('home')" style="padding:15px; font-weight:600; cursor:pointer;"><i class="fas fa-utensils"></i> &nbsp; Menyu</div>
            <div onclick="showPage('favs')" style="padding:15px; font-weight:600; cursor:pointer;"><i class="fas fa-heart"></i> &nbsp; Sevimlilar</div>
            <div onclick="showPage('status')" style="padding:15px; font-weight:600; cursor:pointer;"><i class="fas fa-truck"></i> &nbsp; Buyurtma holati</div>
            <div onclick="showPage('chat')" style="padding:15px; font-weight:600; cursor:pointer; display:flex; justify-content:space-between;">
                <span><i class="fas fa-comment"></i> &nbsp; Xabarlar</span>
                <span id="chatDot" style="color:var(--red); display:none;">‚óè</span>
            </div>
        </nav>
    </div>

    <header class="header">
        <button onclick="openDrawer()" style="background:none; border:none; font-size:24px;">‚ò∞</button>
        <b style="letter-spacing:1px; font-size:20px;">CAFE 777</b>
        <div onclick="showPage('favs')" style="position:relative; font-size:22px;">‚ù§Ô∏è<span id="fCount" class="badge">0</span></div>
    </header>

    <main id="p-home">
        <div id="catNav" style="display:flex; gap:10px; overflow-x:auto; padding:15px; background:white; scrollbar-width: none;"></div>
        <div class="menu-grid" id="menuDisplay"></div>
    </main>

    <main id="p-favs" style="display:none; padding:20px;">
        <h3 style="display:flex; align-items:center; gap:10px;">Sevimlilar ‚ù§Ô∏è</h3>
        <div class="menu-grid" id="favDisplay"></div>
    </main>

    <main id="p-status" style="display:none; padding:20px;">
        <h3>Buyurtma kuzatuvi üì¶</h3>
        <div id="statusUI">Hozircha faol buyurtma yo'q.</div>
    </main>

    <main id="p-chat" style="display:none; padding:20px;">
        <h3>Admin bilan bog'lanish üí¨</h3>
        <div id="chatDisplay" class="chat-box"></div>
        <div style="display:flex; gap:8px; margin-top:15px;">
            <input type="text" id="chatMsg" placeholder="Xabaringizni yozing..." style="margin:0;">
            <button onclick="sendMessage()" style="background:var(--blue); color:white; border:none; border-radius:12px; padding:0 20px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </main>

    <div id="productModal" onclick="if(event.target==this) closeProduct()">
        <div class="modal-content" id="mContent">
            <img id="mImg" style="width:100%; height:300px; object-fit:cover;">
            <div style="padding:25px;">
                <h2 id="mTitle" style="margin:0; font-size:24px;"></h2>
                <p id="mDesc" style="color:#666; margin:15px 0; line-height:1.6;"></p>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <b id="mPrice" style="font-size:22px; color:var(--secondary);"></b>
                    <button class="btn-p" onclick="closeProduct()" style="width:auto; padding:12px 30px;">Yopish</button>
                </div>
            </div>
        </div>
    </div>

    <div style="background:white; margin:15px; padding:25px; border-radius:25px; box-shadow:0 10px 40px rgba(0,0,0,0.08);">
        <h3 style="margin-top:0;">Savat üõí</h3>
        <div id="cartItems" style="margin-bottom:15px; font-size:15px; color:#555;"></div>
        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:20px; margin-bottom:20px; border-top:1px solid #eee; padding-top:15px;">
            <span>Jami summa:</span><span id="totalSum">0 so'm</span>
        </div>
        <button class="btn-p btn-loc" id="locBtn" onclick="getLocation()">
            <i class="fas fa-map-marker-alt"></i> MANZILNI ANIQLASH
        </button>
        <button class="btn-p" id="orderBtn" onclick="placeOrder()" style="background:var(--dark);">BUYURTMA BERISH</button>
    </div>

    <script>
        const BOT_TOKEN = "8032226679:AAETTGPvYZYSvF_QmdofXKibpOwt4E9Iitc";
        const ADMIN_ID = "519326806";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk/gviz/tq?tqx=out:json";

        let products = [], cart = {}, favorites = [], myLoc = null, userID = "";

        // TELEFON FORMATINI TO'G'IRLASH
        function formatPhone(i) {
            let v = i.value.replace(/[^\d]/g, '');
            if(!v.startsWith('998')) v = '998' + v;
            let res = "+998 ";
            if(v.length > 3) res += v.substring(3, 5) + " ";
            if(v.length > 5) res += v.substring(5, 8) + " ";
            if(v.length > 8) res += v.substring(8, 10) + " ";
            if(v.length > 10) res += v.substring(10, 12);
            i.value = res.trim();
        }

        // 1. RO'YXATDAN O'TISH (MUAMMO TUZATILDI)
        function completeReg() {
            const name = document.getElementById('uName').value.trim();
            const phone = document.getElementById('uPhone').value.trim();

            if(name.length < 3) { alert("Iltimos, ismingizni kiriting!"); return; }
            if(phone.length < 17) { alert("Telefon raqamingizni to'liq kiriting!"); return; }
            
            // Unikal ID yaratish (Chat uchun muhim)
            userID = "ID" + Math.floor(Math.random() * 899999 + 100000);
            
            const userData = {name, phone, userID};
            localStorage.setItem('c777_user', JSON.stringify(userData));
            
            // UI-ni yangilash
            document.getElementById('sideName').innerText = name;
            document.getElementById('sidePhone').innerText = phone;
            
            // Animatsiya bilan yopish
            const screen = document.getElementById('regScreen');
            screen.classList.add('hide');
            setTimeout(() => { screen.style.display = 'none'; }, 800);
            
            loadAppData(); // Ma'lumotlarni yuklashni boshlash
        }

        // 2. MA'LUMOTLARNI YUKLASH (GOOGLE SHEET)
        async function loadAppData() {
            const user = JSON.parse(localStorage.getItem('c777_user'));
            if(!user) return; // Agar foydalanuvchi bo'lmasa, chiqish

            document.getElementById('regScreen').style.display = 'none';
            document.getElementById('sideName').innerText = user.name;
            document.getElementById('sidePhone').innerText = user.phone;
            userID = user.userID;

            try {
                const r = await fetch(SHEET_URL);
                const t = await r.text();
                const j = JSON.parse(t.substr(47).slice(0,-2));
                products = j.table.rows.map((r,i) => ({
                    id: i+1, cat: r.c[1]?.v || "Boshqa", name: r.c[2]?.v || "Nomsiz", 
                    price: r.c[3]?.v || 0, img: r.c[4]?.v || "https://via.placeholder.com/300", 
                    desc: r.c[5]?.v || "Juda mazali va yuqori sifatli mahsulot!"
                }));
                renderMenu();
            } catch(e) { console.error("Yuklashda xato:", e); }
        }

        function renderMenu() {
            const display = document.getElementById('menuDisplay');
            display.innerHTML = products.map(p => `
                <div class="card">
                    <i class="fas fa-heart fav-icon ${favorites.includes(p.id)?'active':''}" onclick="toggleFav(${p.id}, this)"></i>
                    <img src="${p.img}" onclick="openProduct(${p.id})">
                    <div style="padding:12px; text-align:center;">
                        <h4 style="margin:5px 0; font-size:14px; height:35px; overflow:hidden;">${p.name}</h4>
                        <b style="color:var(--secondary); font-size:15px;">${p.price.toLocaleString()} so'm</b>
                        <button onclick="addToCart(${p.id})" style="width:100%; margin-top:10px; border:none; background:var(--dark); color:white; border-radius:10px; padding:8px; font-weight:600;">+ Savatga</button>
                    </div>
                </div>
            `).join('');
        }

        // 3. SEVIMLILAR VA ZOOM MODAL
        function toggleFav(id, el) {
            const idx = favorites.indexOf(id);
            if(idx === -1) { 
                favorites.push(id); 
                el.classList.add('active');
                el.style.transform = "scale(1.4)";
                setTimeout(() => el.style.transform = "scale(1.2)", 200);
            } else { 
                favorites.splice(idx, 1); 
                el.classList.remove('active'); 
            }
            localStorage.setItem('c777_favs', JSON.stringify(favorites));
            document.getElementById('fCount').innerText = favorites.length;
        }

        function openProduct(id) {
            const p = products.find(x => x.id == id);
            document.getElementById('mImg').src = p.img;
            document.getElementById('mTitle').innerText = p.name;
            document.getElementById('mDesc').innerText = p.desc;
            document.getElementById('mPrice').innerText = p.price.toLocaleString() + " so'm";
            document.getElementById('productModal').style.display = 'flex';
            setTimeout(() => document.getElementById('mContent').classList.add('show'), 10);
        }

        function closeProduct() {
            document.getElementById('mContent').classList.remove('show');
            setTimeout(() => document.getElementById('productModal').style.display = 'none', 400);
        }

        // 4. SAVAT VA MANZIL
        function addToCart(id) {
            cart[id] = (cart[id] || 0) + 1;
            updateCartUI();
        }

        function updateCartUI() {
            let total = 0, html = "";
            for(let id in cart) {
                const p = products.find(x => x.id == id);
                total += p.price * cart[id];
                html += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>${p.name} x${cart[id]}</span>
                            <span>${(p.price * cart[id]).toLocaleString()} so'm</span>
                         </div>`;
            }
            document.getElementById('cartItems').innerHTML = html || "Savat hozircha bo'sh";
            document.getElementById('totalSum').innerText = total.toLocaleString() + " so'm";
        }

        function getLocation() {
            const btn = document.getElementById('locBtn');
            btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> ANIQLANMOQDA...";
            navigator.geolocation.getCurrentPosition(pos => {
                myLoc = `${pos.coords.latitude},${pos.coords.longitude}`;
                btn.innerHTML = "<i class='fas fa-check-circle'></i> MANZIL ANIQLANDI";
                btn.style.background = "#eaffea";
                btn.style.color = "#27ae60";
            }, () => { 
                alert("GPS-ni yoqing yoki manzilga ruxsat bering!"); 
                btn.innerHTML = "<i class='fas fa-map-marker-alt'></i> MANZILNI ANIQLASH"; 
            });
        }

        // 5. BUYURTMA BERISH (INDIVIDUAL CHAT BILAN)
        async function placeOrder() {
            if(!Object.keys(cart).length) { alert("Savat bo'sh!"); return; }
            if(!myLoc) { alert("Iltimos, avval manzilni aniqlang!"); return; }

            const user = JSON.parse(localStorage.getItem('c777_user'));
            const btn = document.getElementById('orderBtn');
            btn.innerText = "YUBORILMOQDA..."; btn.disabled = true;

            let items = "";
            for(let id in cart) items += `‚ñ´Ô∏è ${products.find(x=>x.id==id).name} x${cart[id]}\n`;

            const text = `üöÄ *YANGI BUYURTMA*\n\nüë§ *Mijoz:* ${user.name}\nüìû *Tel:* ${user.phone}\nüÜî *ID:* ${user.userID}\n\n*Taomlar:*\n${items}\nüí∞ *JAMI:* ${document.getElementById('totalSum').innerText}\n\nüìç *Manzil:* [Xaritada ko'rish](https://www.google.com/maps?q=${myLoc})`;

            const keyboard = {
                inline_keyboard: [
                    [{text: "‚úÖ Qabul qilish", callback_data: `st_qabul_${user.userID}`}],
                    [{text: "üë®‚Äçüç≥ Tayyorlanmoqda", callback_data: `st_tayyor_${user.userID}`}],
                    [{text: "üöö Yetkazilmoqda", callback_data: `st_yolda_${user.userID}`}]
                ]
            };

            try {
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ chat_id: ADMIN_ID, text: text, parse_mode: 'Markdown', reply_markup: keyboard })
                });

                alert("Buyurtmangiz yuborildi! Kuryer tez orada bog'lanadi.");
                localStorage.setItem('last_status', 'yuborildi');
                updateStatusUI();
                cart = {}; updateCartUI();
            } catch(e) { alert("Xatolik yuz berdi!"); }
            btn.innerText = "BUYURTMA BERISH"; btn.disabled = false;
        }

        // 6. REAL-TIME STATUS VA CHAT
        async function syncUpdates() {
            try {
                const r = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=-1`);
                const d = await r.json();
                if(!d.result.length) return;

                const last = d.result[0];
                
                // Status o'zgarishi
                if(last.message && last.message.text.includes(userID)) {
                    const txt = last.message.text.toLowerCase();
                    if(txt.includes("qabul")) localStorage.setItem('last_status', 'qabul');
                    if(txt.includes("tayyor")) localStorage.setItem('last_status', 'tayyor');
                    if(txt.includes("yolda")) localStorage.setItem('last_status', 'yolda');
                    updateStatusUI();
                }

                // Admin javobi (Reply orqali)
                if(last.m
