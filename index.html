<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cafe 777 Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #ff7f50;
            --bg: #f4f7f6;
            --white: #ffffff;
            --text: #2d3436;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
            --radius: 20px;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; -webkit-tap-highlight-color:transparent; }
        body { background: var(--bg); color: var(--text); overflow-x: hidden; }

        /* Splash Screen (Tuzatilgan) */
        #splash { position:fixed; inset:0; background:var(--white); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.5s; }
        .loader-ring { width:50px; height:50px; border:4px solid #f3f3f3; border-top:4px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite; }

        /* Custom Alert */
        .alert-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:11000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        .alert-card { background:var(--white); padding:25px; border-radius:var(--radius); width:85%; max-width:320px; text-align:center; box-shadow: var(--shadow); }
        .alert-card h3 { color:var(--primary); margin-bottom:10px; }
        .alert-card button { margin-top:20px; width:100%; padding:12px; border:none; background:var(--primary); color:white; border-radius:12px; font-weight:bold; }

        /* Header */
        header { position:sticky; top:0; background:rgba(255,255,255,0.8); backdrop-filter:blur(15px); padding:15px 20px; display:flex; justify-content:space-between; align-items:center; z-index:1000; box-shadow:0 2px 10px rgba(0,0,0,0.03); }
        .logo { font-size:22px; font-weight:900; }
        .logo span { color:var(--primary); }

        /* Categories */
        .cats { display:flex; overflow-x:auto; padding:15px; gap:10px; scrollbar-width:none; }
        .cats::-webkit-scrollbar { display:none; }
        .chip { padding:10px 20px; background:var(--white); border-radius:25px; font-size:14px; font-weight:600; white-space:nowrap; box-shadow:var(--shadow); transition:0.3s; }
        .chip.active { background:var(--primary); color:white; }

        /* Grid */
        .grid { display:grid; grid-template-columns: 1fr 1fr; gap:15px; padding:15px; margin-bottom:100px; }
        .card { background:var(--white); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); }
        .card img { width:100%; height:130px; object-fit:cover; background:#eee; }
        .card-body { padding:12px; }
        .card-body h4 { font-size:14px; margin-bottom:5px; height:20px; overflow:hidden; }
        .card-footer { display:flex; justify-content:space-between; align-items:center; margin-top:10px; }
        .price { color:var(--primary); font-weight:800; font-size:14px; }

        /* Buttons */
        .add-btn { background:var(--primary); color:white; border:none; padding:8px 12px; border-radius:10px; font-size:11px; font-weight:bold; }
        .qty-box { display:flex; align-items:center; gap:8px; background:#f1f2f6; border-radius:10px; padding:2px; }
        .qty-box button { width:26px; height:26px; border:none; background:white; border-radius:8px; font-weight:bold; }

        /* Toolbar */
        .toolbar { position:fixed; bottom:0; width:100%; height:70px; background:var(--white); display:flex; justify-content:space-around; align-items:center; box-shadow:0 -5px 20px rgba(0,0,0,0.05); z-index:1000; }
        .tool-item { display:flex; flex-direction:column; align-items:center; color:#b2bec3; font-size:11px; gap:4px; text-decoration:none; }
        .tool-item.active { color:var(--primary); }
        .tool-item i { font-size:20px; }
        .badge { position:absolute; top:12px; transform: translateX(12px); background:#ff4757; color:white; width:18px; height:18px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; }

        /* History */
        .h-card { background:var(--white); margin:10px 15px; padding:15px; border-radius:15px; border-left:6px solid #dfe6e9; box-shadow:var(--shadow); }
        .st-1 { border-left-color: #fdcb6e; }
        .st-2 { border-left-color: #0984e3; }
        .st-3 { border-left-color: #e67e22; }
        .st-4 { border-left-color: #00b894; }

        .page { display:none; min-height:100vh; padding-bottom:100px; }
        .page.active { display:block; }

        #imgModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10001; align-items:center; justify-content:center; }
        #imgModal img { width:90%; max-height:80%; object-fit:contain; }

        @keyframes spin { 100% { transform:rotate(360deg); } }
    </style>
</head>
<body>

    <div id="splash">
        <div class="loader-ring"></div>
        <h2 style="margin-top:20px">CAFE <span style="color:var(--primary)">777</span></h2>
    </div>

    <div id="alertOverlay" class="alert-overlay">
        <div class="alert-card">
            <h3 id="alertTitle">Xabar</h3>
            <p id="alertMsg"></p>
            <button onclick="closeAlert()">Tushunarli</button>
        </div>
    </div>

    <div id="imgModal" onclick="this.style.display='none'"><img id="zoomImg"></div>

    <header>
        <div class="logo">CAFE <span>777</span></div>
        <div id="userDisplay" style="font-weight:bold; font-size:14px">Profil</div>
    </header>

    <main id="app">
        <section id="main-p" class="page active">
            <div class="cats" id="catNav"></div>
            <div class="grid" id="menuItems"></div>
        </section>

        <section id="cart-p" class="page">
            <div style="padding:20px">
                <h2>Savat üõí</h2>
                <div id="cartList" style="margin-top:20px"></div>
                <div style="margin-top:20px; background:white; padding:20px; border-radius:15px">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px">
                        <span>Jami:</span> <b id="totalPrice" style="color:var(--primary)">0 so'm</b>
                    </div>
                    <button onclick="getLocation()" id="locBtn" style="width:100%; padding:12px; border:2px solid var(--primary); background:none; color:var(--primary); border-radius:10px; margin-bottom:10px; font-weight:bold">üìç Manzilni aniqlash</button>
                    <button onclick="sendOrder()" style="width:100%; padding:15px; border:none; background:var(--primary); color:white; border-radius:10px; font-weight:bold">BUYURTMA BERISH</button>
                </div>
            </div>
        </section>

        <section id="history-p" class="page">
            <div style="padding:20px"><h2>Buyurtmalar üìú</h2></div>
            <div id="historyList"></div>
        </section>
    </main>

    <nav class="toolbar">
        <div class="tool-item active" onclick="changePage('main', this)"><i class="fa fa-home"></i><span>Menyu</span></div>
        <div class="tool-item" onclick="changePage('cart', this)"><i class="fa fa-shopping-basket"></i><span id="badge" class="badge" style="display:none">0</span><span>Savat</span></div>
        <div class="tool-item" onclick="changePage('history', this)"><i class="fa fa-history"></i><span>Tarix</span></div>
    </nav>

    <script>
        // SOZLAMALAR (Sizning ID laringiz)
        const CONFIG = {
            MENU_SHEET: "https://docs.google.com/spreadsheets/d/1j6VojbeSYWgYj3UY98xCxHLCzHcGlEg0nXjYwHDkKQk/gviz/tq?tqx=out:json",
            SCRIPT: "https://script.google.com/macros/s/AKfycbxY3WpeGlsE6giypDRwV_yIjhfUzhYDolYcK4fE1OKWKQHdl1v_ID-XdEq6dAxX1_uK6A/exec",
            BOT_TOKEN: "8032226679:AAETTGPvYZYSvF_QmdofXKibpOwt4E9Iitc",
            ADMIN: "519326806"
        };

        let products = [], cart = {}, coords = null;

        async function init() {
            try {
                const res = await fetch(CONFIG.MENU_SHEET);
                const text = await res.text();
                const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
                
                products = json.table.rows
                    .filter(r => r.c[2] && r.c[2].v)
                    .map((r, i) => ({
                        id: i + 1,
                        cat: r.c[1]?.v || 'Boshqa',
                        name: r.c[2].v,
                        price: r.c[3]?.v || 0,
                        img: r.c[4]?.v || '',
                        desc: r.c[5]?.v || ''
                    }));

                renderCats();
                renderMenu('Barchasi');
                loadUser();
            } catch (e) {
                showAlert("Xatolik", "Jadval yuklanmadi. Sharing sozlamalarini tekshiring.");
            } finally {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => document.getElementById('splash').remove(), 500);
            }
        }

        function renderCats() {
            const cats = ['Barchasi', ...new Set(products.map(p => p.cat))];
            document.getElementById('catNav').innerHTML = cats.map(c => 
                `<div class="chip" onclick="filterMenu('${c}', this)">${c}</div>`
            ).join('');
            document.querySelector('.chip').classList.add('active');
        }

        function filterMenu(cat, el) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderMenu(cat);
        }

        function renderMenu(cat) {
            const filtered = cat === 'Barchasi' ? products : products.filter(p => p.cat === cat);
            document.getElementById('menuItems').innerHTML = filtered.map(p => `
                <div class="card">
                    <img src="${p.img}" onclick="zoom('${p.img}')" onerror="this.src='https://via.placeholder.com/150'">
                    <div class="card-body">
                        <h4>${p.name}</h4>
                        <div class="card-footer">
                            <b class="price">${p.price.toLocaleString()} so'm</b>
                            <div id="ctrl-${p.id}">${btnHTML(p.id)}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function btnHTML(id) {
            const q = cart[id] || 0;
            return q > 0 ? `
                <div class="qty-box">
                    <button onclick="updateQty(${id},-1)">-</button>
                    <span>${q}</span>
                    <button onclick="updateQty(${id},1)">+</button>
                </div>` : `<button class="add-btn" onclick="updateQty(${id},1)">Savatga</button>`;
        }

        function updateQty(id, n) {
            cart[id] = (cart[id] || 0) + n;
            if(cart[id] <= 0) delete cart[id];
            
            const el = document.getElementById(`ctrl-${id}`);
            if(el) el.innerHTML = btnHTML(id);
            updateBadge();
            if(document.getElementById('cart-p').classList.contains('active')) renderCart();
        }

        function updateBadge() {
            const total = Object.values(cart).reduce((a, b) => a + b, 0);
            const b = document.getElementById('badge');
            b.innerText = total;
            b.style.display = total > 0 ? 'flex' : 'none';
        }

        function renderCart() {
            const list = document.getElementById('cartList');
            let total = 0, html = "";
            for(let id in cart) {
                const p = products.find(x => x.id == id);
                total += p.price * cart[id];
                html += `
                <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:15px; border-radius:12px; margin-bottom:10px">
                    <div><b>${p.name}</b><br><small>${p.price.toLocaleString()} so'm</small></div>
                    <div class="qty-box">
                        <button onclick="updateQty(${id},-1)">-</button>
                        <span>${cart[id]}</span>
                        <button onclick="updateQty(${id},1)">+</button>
                    </div>
                </div>`;
            }
            list.innerHTML = html || "<p style='text-align:center'>Savat bo'sh</p>";
            document.getElementById('totalPrice').innerText = total.toLocaleString() + " so'm";
        }

        async function sendOrder() {
            const user = JSON.parse(localStorage.getItem('c777_u'));
            if(!user) {
                const n = prompt("Ismingiz:");
                const p = prompt("Telefoningiz:", "+998");
                if(!n || !p) return;
                localStorage.setItem('c777_u', JSON.stringify({n, p}));
            }
            if(!Object.keys(cart).length) return showAlert("Savat", "Savat bo'sh!");
            if(!coords) return showAlert("Manzil", "Joylashuvni aniqlang!");

            const u = JSON.parse(localStorage.getItem('c777_u'));
            const orderId = Date.now();
            let items = "", total = 0;
            for(let id in cart) {
                const p = products.find(x => x.id == id);
                items += `${p.name} (${cart[id]}x), `;
                total += p.price * cart[id];
            }

            try {
                fetch(`${CONFIG.SCRIPT}?action=add&id=${orderId}&name=${encodeURIComponent(u.n)}&phone=${u.p}&items=${encodeURIComponent(items)}&total=${total}`);
                
                await fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({
                        chat_id: CONFIG.ADMIN,
                        text: `üîî YANGI BUYURTMA #${orderId}\nüë§ ${u.n}\nüìû ${u.p}\nüõí ${items}\nüí∞ ${total.toLocaleString()} so'm\nüìç Manzil: https://www.google.com/maps?q=${coords.latitude},${coords.longitude}`
                    })
                });

                let h = JSON.parse(localStorage.getItem('c777_h') || "[]");
                h.unshift({id: orderId, items, total, status: 1});
                localStorage.setItem('c777_h', JSON.stringify(h));

                showAlert("Rahmat!", "Buyurtmangiz qabul qilindi!");
                cart = {}; updateBadge(); changePage('history', document.querySelectorAll('.tool-item')[2]);
            } catch(e) { showAlert("Xato", "Bog'lanishda xato!"); }
        }

        async function loadHistory() {
            const h = JSON.parse(localStorage.getItem('c777_h') || "[]");
            const container = document.getElementById('historyList');
            if(!h.length) return container.innerHTML = "<p style='text-align:center'>Tarix bo'sh</p>";

            const sts = ["", "Kutilmoqda", "Tayyorlanmoqda üë®‚Äçüç≥", "Yo'lda üö¥", "Yetkazildi ‚úÖ"];
            let html = "";
            for(let o of h) {
                if(o.status < 4) {
                    try {
                        const r = await fetch(`${CONFIG.SCRIPT}?orderId=${o.id}`);
                        const d = await r.json();
                        if(d.status) o.status = parseInt(d.status);
                    } catch(e){}
                }
                html += `
                <div class="h-card st-${o.status}">
                    <div style="display:flex; justify-content:space-between"><small>#${o.id.toString().slice(-6)}</small> <b>${sts[o.status]}</b></div>
                    <p style="font-size:13px; margin:8px 0">${o.items}</p>
                    <b style="color:var(--primary)">${o.total.toLocaleString()} so'm</b>
                </div>`;
            }
            container.innerHTML = html;
            localStorage.setItem('c777_h', JSON.stringify(h));
        }

        function getLocation() {
            const b = document.getElementById('locBtn');
            b.innerText = "Aniqlanmoqda...";
            navigator.geolocation.getCurrentPosition(p => {
                coords = p.coords;
                b.innerText = "‚úÖ Manzil aniqlandi";
                b.style.color = "green"; b.style.borderColor = "green";
            }, () => showAlert("Xato", "GPSni yoqing!"));
        }

        function changePage(p, el) {
            document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
            document.getElementById(p + '-p').classList.add('active');
            document.querySelectorAll('.tool-item').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            if(p === 'history') loadHistory();
            if(p === 'cart') renderCart();
        }

        function zoom(s) { document.getElementById('zoomImg').src = s; document.getElementById('imgModal').style.display = 'flex'; }
        function showAlert(t, m) { document.getElementById('alertTitle').innerText = t; document.getElementById('alertMsg').innerText = m; document.getElementById('alertOverlay').style.display = 'flex'; }
        function closeAlert() { document.getElementById('alertOverlay').style.display = 'none'; }
        function loadUser() { const u = JSON.parse(localStorage.getItem('c777_u')); if(u) document.getElementById('userDisplay').innerText = u.n; }

        window.onload = init;
    </script>
</body>
</html>
